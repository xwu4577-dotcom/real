<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ä½œåŠ©æ‰‹ (äº‘ç«¯åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- åŸºç¡€å˜é‡ --- */
        :root { --primary: #007AFF; --bg: #F5F7FA; --white: #FFFFFF; --green: #34C759; --orange: #FF9500; --purple: #5856D6; --text: #333; --border: #E5E5EA; --red: #FF3B30; --gray: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        /* å¯¼èˆª */
        .navbar { background: var(--white); color: var(--text); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 0 rgba(0,0,0,0.05); flex-shrink: 0; z-index: 100; height: 44px; }
        .nav-left { display: flex; align-items: center; gap: 10px; flex: 1; }
        #backBtn { background: none; border: none; color: var(--primary); font-size: 20px; font-weight: bold; padding: 0 10px 0 0; cursor: pointer; display: none; }
        .page-title { font-size: 18px; font-weight: 700; color: #000; margin: 0; }
        #nodeConfigBtn { background: #f0f0f5; border: none; color: var(--primary); padding: 6px 12px; border-radius: 15px; font-size: 13px; cursor: pointer; font-weight: 500; display: none; }
        
        /* å®¹å™¨ */
        .page-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; position: relative; } /* padding-bottom å¢åŠ ï¼Œé˜²æ­¢é®æŒ¡åº•éƒ¨å†…å®¹ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ğŸŒŸ V44 æ–°å¢ï¼šæ ‡å‡†æ‚¬æµ®æŒ‰é’® (FAB) --- */
        .fab-add {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 900;
            transition: transform 0.1s;
        }
        .fab-add:active { transform: scale(0.95); background-color: #0056b3; }

        /* --- ğŸŒŸ V44 æ–°å¢ï¼šèŠ‚ç‚¹æ’åºåŒºåŸŸ (ç´ é›…ç®­å¤´) --- */
        .node-sort-zone {
            width: 36px;
            background: #f9f9f9;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .node-sort-btn {
            flex: 1;
            width: 100%;
            border: none;
            background: transparent;
            color: #ccc; /* æ™®é€šç°è‰² */
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .node-sort-btn:active { color: var(--primary); background: #eee; }
        .node-sort-btn:first-child { border-bottom: 1px solid #eee; }


        /* --- é¦–é¡µæ ·å¼ --- */
        .welcome-row { margin-bottom: 20px; }
        .welcome-date { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .welcome-title { font-size: 24px; font-weight: 800; color: #333; margin: 5px 0 0 0; }
        .asset-card-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .asset-card { background: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; overflow: hidden; cursor: pointer; transition: transform 0.1s; }
        .asset-card:active { transform: scale(0.98); }
        .asset-card.blue { background: linear-gradient(145deg, #007AFF, #0056b3); color: white; }
        .asset-card.orange { background: white; color: #333; }
        .asset-label { font-size: 12px; opacity: 0.8; margin-bottom: 5px; }
        .asset-value { font-size: 28px; font-weight: 800; line-height: 1.1; }
        .asset-sub { font-size: 11px; margin-top: 5px; opacity: 0.7; }
        .calendar-section { background: white; border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .cal-header { font-weight: bold; margin-bottom: 10px; font-size: 15px; display: flex; justify-content: space-between; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-day-name { font-size: 12px; color: #999; margin-bottom: 5px; }
        .cal-day { font-size: 13px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #333; position: relative; }
        .cal-day.today { background: var(--primary); color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,122,255,0.4); }
        .cal-day.has-log::after { content:''; width:4px; height:4px; background:var(--red); border-radius:50%; position:absolute; bottom:4px; }
        .todo-section { margin-bottom: 30px; }
        .section-head { font-size: 16px; font-weight: 800; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .todo-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .todo-input { flex: 1; border: none; background: #fff; padding: 12px 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); font-size: 14px; }
        .todo-add-btn { background: var(--text); color: white; border: none; width: 44px; border-radius: 10px; font-size: 20px; cursor: pointer; }
        .todo-list { display: flex; flex-direction: column; gap: 8px; }
        .todo-item { background: white; padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .todo-item.done { opacity: 0.5; background: #f5f5f5; }
        .todo-item.done .todo-text { text-decoration: line-through; color: #999; }
        .todo-checkbox { width: 20px; height: 20px; border-radius: 6px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .todo-item.done .todo-checkbox { background: var(--green); border-color: var(--green); color: white; }
        .todo-text { font-size: 14px; flex: 1; }
        .todo-del { color: #ccc; font-size: 18px; padding: 5px; cursor: pointer; }
        .project-entry-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .entry-card { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer; border: 1px solid transparent; transition: all 0.1s; }
        .entry-card:active { transform: scale(0.96); background: #fafafa; }
        .entry-card.eng { border-bottom: 4px solid var(--primary); }
        .entry-card.non-eng { border-bottom: 4px solid var(--purple); }
        .entry-icon { font-size: 32px; margin-bottom: 10px; display: block; }
        .entry-title { font-weight: 700; font-size: 15px; color: #333; display: block; }
        .entry-desc { font-size: 11px; color: #999; margin-top: 4px; display: block; }
        .footer-tools { display: flex; gap: 10px; justify-content: center; margin-bottom: 40px; }
        .tool-btn { font-size: 12px; color: #999; padding: 8px 15px; background: rgba(0,0,0,0.03); border-radius: 20px; cursor: pointer; }

        /* --- è€ƒå‹¤æ ·å¼ --- */
        .ot-summary-card { background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
        .ot-big-num { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .ot-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px; }
        .ot-label { font-size: 12px; opacity: 0.9; }
        .ot-val { font-size: 16px; font-weight: bold; }
        .ot-settings-mini { background: #fff; padding: 10px 15px; border-radius: 10px; display: flex; gap: 15px; align-items: center; font-size: 13px; color: #666; margin-bottom: 20px; border: 1px solid #eee; }
        .ot-input-mini { width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-weight: bold; color: var(--primary); }
        .ot-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-left: 4px solid var(--green); position: relative; }
        .ot-card.used { border-left-color: #ccc; background: #f9f9f9; color: #999; }
        .ot-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .ot-date { font-weight: bold; font-size: 16px; }
        .ot-badge { background: #e8f5e9; color: var(--green); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .ot-card.used .ot-badge { background: #eee; color: #999; }
        .ot-desc { font-size: 13px; color: #666; margin-bottom: 5px; }
        .ot-deadline { font-size: 12px; color: var(--orange); margin-top: 5px; font-weight: 500; }
        .ot-list-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .leave-type-tag { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: white; }

        /* --- å·¥ç¨‹åˆ—è¡¨æ ·å¼ (æŒ‰é”®æ’åº) --- */
        .list-item { background: white; padding: 0; margin-bottom: 10px; border-radius: 10px; display: flex; align-items: stretch; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .list-item-content { flex: 1; padding: 15px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; }
        .list-item-content:active { background: #f5f5f5; }
        .list-sort-zone { width: 46px; background: #f9f9f9; border-left: 1px solid #eee; display: flex; flex-direction: column; }
        .sort-btn { flex: 1; border: none; background: transparent; color: #ccc; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .sort-btn:active { background: #e0e0e0; color: var(--primary); }
        .sort-btn.up { border-bottom: 1px solid #eee; }
        .list-item-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #333; }
        .list-item-date { font-size: 12px; color: #999; }
        .project-section-header { font-size: 14px; font-weight: bold; color: #555; margin: 15px 0 10px; padding-left: 10px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; }
        .home-section-title { font-size: 14px; font-weight: bold; color: #666; margin: 25px 0 10px 5px; border-left: 3px solid var(--primary); padding-left: 8px; }

        /* --- è¯¦æƒ…é¡µæ ·å¼ --- */
        .stage-card { background: white; margin-bottom: 15px; border-radius: 10px; position: relative; box-shadow: 0 2px 6px rgba(0,0,0,0.05); display: flex; overflow: hidden; }
        .card-content { flex: 1; padding: 12px 15px; position: relative; min-width: 0; }
        .status-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .status-bar.done { background: var(--green); }
        .status-bar.processing { background: var(--orange); }
        .status-bar.waiting { background: #ddd; }
        .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-right: 70px; }
        .card-title { font-weight: bold; font-size: 15px; color: #333; }
        .card-status-text { font-size: 12px; color: #999; }
        .card-actions-fixed { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 5; }
        .icon-btn-card { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; background: #f2f2f7; color: #555; }
        .data-grid { display: grid; grid-template-columns: 1fr; gap: 6px; background: #f9f9f9; padding: 8px; border-radius: 6px; font-size: 13px; }
        .data-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .data-label { color: #888; } .data-value { font-weight: 500; color: #333; text-align: right; }
        .preview-section { background: white; border-radius: 10px; padding: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .preview-item.done { background: #f0fdf4; border-color: #bbf7d0; color: #333; padding: 8px 10px; border-radius: 6px; border: 1px solid #eee; margin-bottom: 8px; font-size: 12px; }
        .preview-data-table { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 4px 8px; margin-top: 5px; }
        .preview-kv { display: flex; align-items: center; }
        .preview-k { color: #666; margin-right: 6px; white-space: nowrap; }

        /* é€šç”¨æŒ‰é’® */
        .btn-add-node { background: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3); width: 80%; }
        .back-btn-float { padding: 5px 12px; background: #e3f2fd; border-radius: 15px; color: var(--primary); font-size: 13px; border: 1px solid rgba(0,122,255,0.1); cursor: pointer; font-weight: 500; }
        .btn-mini { padding: 4px 10px; border-radius: 15px; border: 1px solid #ddd; background: white; font-size: 12px; cursor: pointer; color: #555; }
        .btn-mini.action { border-color: var(--primary); color: var(--primary); }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(2px); }
        .modal.open { display: flex; }
        .modal-content { background: white; width: 85%; max-width: 450px; padding: 25px 20px; border-radius: 15px; max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column; }
        .form-label { display: block; font-size: 14px; font-weight: bold; margin: 12px 0 6px; color: #444; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fafafa; }
        .log-textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fafafa; min-height: 100px; resize: vertical; }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 16px; margin-top: 25px; cursor: pointer; font-weight: 600; }
        .btn-cancel { width: 100%; margin-top: 10px; border: none; background: transparent; color: #999; cursor: pointer; padding: 10px; font-size: 14px; }
        
        /* é…ç½®å™¨ */
        .config-container { display: flex; height: 350px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .config-sidebar { width: 35%; background: #f5f5f7; border-right: 1px solid #eee; overflow-y: auto; }
        .config-main { width: 65%; padding: 10px; overflow-y: auto; background: white; }
        .config-node-item { padding: 12px 8px; font-size: 13px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .config-node-item.active { background: white; color: var(--primary); border-left: 3px solid var(--primary); font-weight: bold; }
        .field-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; background: #f9f9f9; padding: 5px; border-radius: 4px; }
        .field-row input, .field-row select { width: 100%; padding: 6px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; }
        .icon-btn { cursor: pointer; padding: 4px; color: #999; font-size: 16px; }
        .btn-small { padding: 6px 10px; font-size: 12px; border-radius: 6px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
        .node-option { background: #f0f2f5; border: 1px solid transparent; padding: 15px 5px; border-radius: 10px; text-align: center; cursor: pointer; font-size: 13px; font-weight: 500; color: #333; }

        .hidden { display: none; }
        
        /* --- â˜ï¸ äº‘åŒæ­¥æ ·å¼ --- */
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .auth-box { background: white; padding: 30px; border-radius: 16px; width: 85%; max-width: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); text-align: center; }
        .auth-box h2 { margin-top: 0; color: #1d1d1f; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .auth-btn:active { background: #005bb5; }
        .auth-switch { margin-top: 15px; font-size: 14px; color: #007aff; cursor: pointer; text-decoration: underline; }
        .error-msg { color: #ff3b30; font-size: 14px; margin-top: 10px; display: none; }
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000; }
        .user-badge { font-size: 12px; color: var(--primary); background: #e3f2fd; padding: 4px 8px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <button id="backBtn" onclick="goHome()">â†</button>
            <h1 id="pageTitle" class="page-title">å·¥ä½œåŠ©æ‰‹</h1>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="userBadge" class="user-badge" onclick="logout()" style="display:none;"></span>
            <button id="nodeConfigBtn" onclick="openConfigModal('global')">âš™ï¸ å¤‡é€‰èŠ‚ç‚¹é…ç½®</button>
        </div>
    </nav>

    <div id="auth-modal" style="display:none;">
        <div class="auth-box">
            <h2 id="auth-title">ä¸ªäººè´¦å·ç™»å½•</h2>
            <p style="font-size:12px;color:#666;margin-bottom:20px;">ç™»å½•åå¯å¤šç«¯åŒæ­¥æ•°æ®</p>
            <input type="email" id="email" class="auth-input" placeholder="ä»»æ„é‚®ç®±æ ¼å¼çš„ç”¨æˆ·å">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç  (è‡³å°‘6ä½)">
            <button class="auth-btn" id="auth-action-btn" onclick="handleAuth()">ç™»å½•</button>
            <div id="auth-error" class="error-msg"></div>
            <div class="auth-switch" onclick="switchMode()">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
        </div>
    </div>
    
    <div id="toast" class="toast">å·²åŒæ­¥åˆ°äº‘ç«¯</div>

    <div class="page-container">
        <div id="homePage" class="page active">
            <div class="welcome-row">
                <div class="welcome-date" id="welcomeDate">LOADING...</div>
                <div class="welcome-title">ä¸ªäººæ•ˆèƒ½ä¸­å¿ƒ</div>
            </div>

            <div class="asset-card-row">
                <div class="asset-card blue" onclick="goToPage('attendancePage')">
                    <div class="asset-label">å¯ä¼‘å¤©æ•°</div>
                    <div class="asset-value" id="homeOtDays">0</div>
                    <div class="asset-sub">å¹´å‡/å­˜ä¼‘/å€’ä¼‘</div>
                </div>
                <div class="asset-card orange" onclick="document.getElementById('todoInput').focus()">
                    <div class="asset-label">å¾…åŠäº‹é¡¹</div>
                    <div class="asset-value" id="homeTodoCount" style="color:var(--primary)">0</div>
                    <div class="asset-sub">ä»Šæ—¥æœªå®Œæˆ</div>
                </div>
            </div>

            <div class="calendar-section">
                <div class="cal-header">
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(-1)">â€¹</div>
                    <span id="calMonth"></span>
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(1)">â€º</div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-mini" onclick="goToday()">å›åˆ°ä»Šå¤©</button>
                </div>
            </div>

            <div class="todo-section">
                <div class="section-head">
                    <span>ğŸ“ æˆ‘çš„å¾…åŠ</span>
                </div>
                <div class="todo-input-row">
                    <input type="text" id="todoInput" class="todo-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡...">
                    <button class="todo-add-btn" onclick="addTodo()">+</button>
                </div>
                <div id="todoList" class="todo-list"></div>
            </div>

            <div class="section-head" style="margin-top:20px;">ğŸš€ é¡¹ç›®ç®¡ç†</div>
            <div class="project-entry-grid">
                <div class="entry-card eng" onclick="goToPage('projectList')">
                    <span class="entry-icon">ğŸ—ï¸</span>
                    <span class="entry-title">å·¥ç¨‹é¡¹ç›®</span>
                    <span class="entry-desc">ä¸“é¡¹/é›¶æ˜Ÿ/æŠ¢ä¿®</span>
                </div>
                <div class="entry-card non-eng" onclick="goToPage('nonProjectList')">
                    <span class="entry-icon">ğŸ“‚</span>
                    <span class="entry-title">éå·¥ç¨‹é¡¹ç›®</span>
                    <span class="entry-desc">å…¶ä»–äº‹åŠ¡ç®¡ç†</span>
                </div>
            </div>

            <div class="footer-tools">
                <div class="tool-btn" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</div>
                <div class="tool-btn" onclick="triggerImport()">ğŸ“¥ æ¢å¤æ•°æ®</div>
            </div>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>

        <div id="attendancePage" class="page">
            <div class="ot-summary-card">
                <div style="font-size:14px; opacity:0.8;">å½“å‰å¯ä¼‘æ€»å¤©æ•°</div>
                <div class="ot-big-num" id="otTotalDays">0.0</div>
                <div class="ot-grid">
                    <div><div class="ot-label">å‰©å¹´å‡</div><div class="ot-val" id="dispAnnual">0</div></div>
                    <div><div class="ot-label">å‰©å­˜ä¼‘</div><div class="ot-val" id="dispSaved">0</div></div>
                    <div><div class="ot-label">åŠ ç­æ± </div><div class="ot-val" id="dispOt">0</div></div>
                </div>
            </div>
            <div class="ot-settings-mini">
                <span>âš™ï¸ åˆå§‹åŸºæ•°è®¾ç½®ï¼š</span>
                <label>å¹´å‡</label><input type="number" id="inpAnnual" class="ot-input-mini" onchange="saveBaseLeave()">
                <label>å­˜ä¼‘</label><input type="number" id="inpSaved" class="ot-input-mini" onchange="saveBaseLeave()">
            </div>
            <div class="home-section-title">ğŸ“… åŠ ç­è®°å½• (å€’ä¼‘)</div>
            <div id="otListContainer"></div>
            <div style="text-align:center; padding:10px;"><button class="btn-mini" onclick="openModal('addOtModal')">+ å½•å…¥åŠ ç­</button></div>
            <div class="home-section-title">ğŸ–ï¸ ä¼‘å‡è®°å½•</div>
            <div id="leaveListContainer"></div>
            <div style="text-align:center; padding:10px; margin-bottom:50px;"><button class="btn-mini" onclick="openModal('addLeaveModal')">+ å½•å…¥ä¼‘å‡</button></div>
        </div>

        <div id="projectList" class="page">
            <div class="project-section">
                <div class="project-section-header" style="color:#007AFF;border-color:#007AFF;">ğŸŒŸ ä¸“é¡¹å·¥ç¨‹ <span id="c_s" style="font-size:12px;background:#e3f2fd;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_special" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#AF52DE;border-color:#AF52DE;">ğŸ”§ é›¶æ˜Ÿå·¥ç¨‹ <span id="c_o" style="font-size:12px;background:#f3e5f5;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_odd" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#FF3B30;border-color:#FF3B30;">ğŸš‘ æŠ¢ä¿®å·¥ç¨‹ <span id="c_r" style="font-size:12px;background:#ffebee;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_repair" class="project-section-body"></div>
            </div>
            <button class="fab-add" onclick="openModal('createModal')">+</button>
        </div>

        <div id="nonProjectList" class="page">
            <div style="text-align:center; padding:50px 20px; color:#999;">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ“‚</div>
                <h3>éå·¥ç¨‹é¡¹ç›®ç®¡ç†</h3>
                <p>æ­¤æ¨¡å—æ­£åœ¨å»ºè®¾ä¸­...</p>
            </div>
        </div>

        <div id="projectDetail" class="page">
            <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h2 id="detailTitle" style="margin:0; font-size:18px; display:inline-block;" onclick="editProjectName()"></h2>
                    <span style="font-size:14px; color:#999; cursor:pointer;" onclick="editProjectName()"> âœï¸</span>
                    <div id="detailType" style="font-size:12px; color:#666; margin-top:2px;"></div>
                </div>
                <button class="back-btn-float" onclick="goToPage('projectList')">â†© è¿”å›åˆ—è¡¨</button>
            </div>
            <div class="preview-section">
                <div class="preview-header"><span>ğŸ“‹ å…¨æ¯è¿›åº¦é¢„è§ˆ</span></div>
                <div id="previewFlow" class="preview-flow"></div>
            </div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="stagesContainer"></div>
                <div id="emptyHint" style="text-align:center; padding:40px; color:#999; font-size:14px; display:none;">ğŸ‘‡ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæµç¨‹èŠ‚ç‚¹</div>
            </div>
            
            <div style="text-align:center; padding-bottom:30px;">
                <button class="btn-add-node" onclick="openNodeLibrary()">+ æ·»åŠ æµç¨‹èŠ‚ç‚¹</button>
            </div>
        </div>
    </div>

    <div id="dayLogModal" class="modal">
        <div class="modal-content">
            <h3 id="logDateTitle">202X-XX-XX</h3>
            <label class="form-label">å·¥ä½œæ—¥å¿—</label>
            <textarea id="logContent" class="log-textarea" placeholder="è®°å½•ä»Šå¤©çš„å·¥ä½œé‡ç‚¹..."></textarea>
            <button class="btn-primary" onclick="saveDayLog()">ä¿å­˜æ—¥å¿—</button>
            <button class="btn-cancel" onclick="closeModal('dayLogModal')">å…³é—­</button>
        </div>
    </div>

    <div id="addOtModal" class="modal"><div class="modal-content"><h3>å½•å…¥åŠ ç­</h3><label class="form-label">æ—¥æœŸ</label><input type="date" id="otDate" class="input-box"><label class="form-label">å¤©æ•°</label><input type="number" id="otDays" class="input-box" step="0.5"><label class="form-label">å¤‡æ³¨</label><input type="text" id="otNote" class="input-box"><button class="btn-primary" onclick="addOvertime()">ç¡®è®¤</button><button class="btn-cancel" onclick="closeModal('addOtModal')">å–æ¶ˆ</button></div></div>
    <div id="addLeaveModal" class="modal"><div class="modal-content"><h3>å½•å…¥ä¼‘å‡</h3><label class="form-label">ç±»å‹</label><select id="lvType" class="input-box"><option value="å¹´å‡">å¹´å‡</option><option value="å­˜ä¼‘">å­˜ä¼‘</option><option value="å€’ä¼‘">å€’ä¼‘</option><option value="å…¶ä»–">å…¶ä»–</select><label class="form-label">æ—¥æœŸ</label><input type="date" id="lvDate" class="input-box"><label class="form-label">å¤©æ•°</label><input type="number" id="lvDays" class="input-box" step="0.5"><label class="form-label">è¯´æ˜</label><input type="text" id="lvNote" class="input-box"><button class="btn-primary" onclick="addLeaveRecord()">ç¡®è®¤</button><button class="btn-cancel" onclick="closeModal('addLeaveModal')">å–æ¶ˆ</button></div></div>
    <div id="useOtModal" class="modal"><div class="modal-content"><h3>æ ¸é”€åŠ ç­</h3><p style="color:#666;font-size:13px;margin-bottom:15px">ç¡®è®¤å·²å€’ä¼‘ï¼Ÿ</p><label class="form-label">å€’ä¼‘æ—¥æœŸ</label><input type="date" id="useOtDate" class="input-box"><input type="hidden" id="useOtId"><button class="btn-primary" onclick="confirmUseOt()">ç¡®è®¤</button><button class="btn-cancel" onclick="closeModal('useOtModal')">å–æ¶ˆ</button></div></div>
    <div id="createModal" class="modal"><div class="modal-content"><h3>æ–°å»ºå·¥ç¨‹</h3><label class="form-label">åç§°</label><input type="text" id="newProjectName" class="input-box"><label class="form-label">ç±»åˆ«</label><select id="newProjectType" class="input-box"><option value="special">ğŸŒŸ ä¸“é¡¹</option><option value="odd">ğŸ”§ é›¶æ˜Ÿ</option><option value="repair">ğŸš‘ æŠ¢ä¿®</option></select><button class="btn-primary" onclick="createProject()">åˆ›å»º</button><button class="btn-cancel" onclick="closeModal('createModal')">å–æ¶ˆ</button></div></div>
    <div id="nodeLibraryModal" class="modal"><div class="modal-content"><h3>é€‰æ‹©èŠ‚ç‚¹</h3><div id="nodeLibraryGrid" class="node-library-grid"></div><button class="btn-cancel" onclick="closeModal('nodeLibraryModal')">å–æ¶ˆ</button></div></div>
    <div id="dynamicFormModal" class="modal"><div class="modal-content"><h3 id="formTitle"></h3><div id="dynamicFormContainer"></div><button class="btn-primary" onclick="saveDynamicData()">ä¿å­˜</button><button class="btn-cancel" onclick="closeModal('dynamicFormModal')">å–æ¶ˆ</button></div></div>
    <div id="configModal" class="modal"><div class="modal-content" style="max-width:600px;"><h3 id="configModalTitle">é…ç½®</h3><div style="display:flex;gap:10px;margin-bottom:10px"><button class="btn-small" id="btnAddConfigNode" onclick="addNewConfigNode()">+ æ–°ç±»å‹</button></div><div class="config-container"><div class="config-sidebar" id="configSidebar"></div><div class="config-main" id="configMain"><div id="fieldEditorArea" style="display:none;"><h4 id="currentEditingNodeTitle"></h4><div id="configFieldsList"></div><button class="btn-small" onclick="addNewConfigField()">+ å­—æ®µ</button></div><div id="configEmptyHint">è¯·é€‰æ‹©</div></div></div><button class="btn-primary" onclick="handleConfigSave()">ä¿å­˜</button><button class="btn-cancel" onclick="closeModal('configModal')">å–æ¶ˆ</button></div></div>

    <script>
        // ==========================================
        // â˜ï¸ æ ¸å¿ƒé…ç½®ï¼šäº‘åŒæ­¥æ¨¡å— (V44.0 Cloud)
        // ==========================================
        const SUPABASE_URL = 'https://real-tau-seven.vercel.app/weather';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZGltYWR6cGJjdm10b3Vqb2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTE3NTksImV4cCI6MjA4NTY4Nzc1OX0.dMJdVjjr3D0oGRli1DE2ohvl-5abwLGHSPAaS8wREG0';
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let isRegisterMode = false;
        let syncTimer = null;

        // åˆå§‹åŒ–ï¼šå…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå†åŠ è½½æ•°æ®
        // ==========================================
        // ğŸ§ª æµ‹è¯•ä¸“ç”¨ï¼šçº¯é™æ€æ¨¡å¼ (æ–­å¼€æ•°æ®åº“)
        // ==========================================
        async function initApp() {
            // 1. å¼ºè¡Œè·³è¿‡æ‰€æœ‰ç½‘ç»œè¯·æ±‚
            console.log("ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šå·²åˆ‡æ–­äº‘ç«¯è¿æ¥");
            
            // 2. ç›´æ¥åŠ è½½æœ¬åœ°æ•°æ® (å¦‚æœæœ‰çš„è¯)
            try {
                // ç¡®ä¿å…ˆè¯»å–é…ç½®å’Œæ•°æ®
                if (typeof loadConfig === 'function') loadConfig();
                if (typeof migrateData === 'function') migrateData();
                if (typeof initHome === 'function') initHome();
                
                // æ¸²æŸ“å·¥ç¨‹åˆ—è¡¨ (é˜²æ­¢é¡µé¢ç©ºç™½)
                if (typeof renderProjects === 'function') renderProjects();
                
                // 3. å¼¹çª—æç¤ºï¼Œè¯æ˜ç½‘é¡µæ´»äº†
                alert("æµ‹è¯•æˆåŠŸï¼ç½‘é¡µèƒ½æ‰“å¼€ï¼\n(å½“å‰ä¸ºçº¯æœ¬åœ°æ¨¡å¼ï¼Œæœªè¿æ¥æ•°æ®åº“)");
                
            } catch (e) {
                alert("ç½‘é¡µæ´»äº†ï¼Œä½†åŠ è½½æœ¬åœ°æ•°æ®å‡ºé”™ï¼š" + e.message);
            }

            // 4. ä¸ºäº†ä¸è®©ä½ ä»¥ä¸ºå¡æ­»ï¼Œæ‰‹åŠ¨éšè—ç™»å½•æ¡†ï¼ˆæˆ–è€…ä½ æƒ³æ˜¾ç¤ºä¹Ÿè¡Œï¼‰
            // è¿™é‡Œæˆ‘ä»¬å¼ºåˆ¶æ˜¾ç¤ºä¸»é¡µï¼ŒæŠŠç™»å½•æ¡†å…³æ‰
            const authModal = document.getElementById('auth-modal');
            if (authModal) authModal.style.display = 'none';
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-action-btn');
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) return showAuthError('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
            
            btn.innerText = 'å¤„ç†ä¸­...';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            let result;
            if (isRegisterMode) {
                result = await _supabase.auth.signUp({ email, password });
            } else {
                result = await _supabase.auth.signInWithPassword({ email, password });
            }

            if (result.error) {
                showAuthError(result.error.message);
                btn.innerText = isRegisterMode ? 'æ³¨å†Œ' : 'ç™»å½•';
                btn.disabled = false;
            } else {
                if (isRegisterMode && !result.data.session) {
                    showAuthError('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤é‚®ä»¶ï¼Œç¡®è®¤åé‡æ–°ç™»å½•ã€‚');
                    btn.innerText = 'æ³¨å†Œ';
                    btn.disabled = false;
                } else {
                    handleLoginSuccess(result.data.user);
                }
            }
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('userBadge').innerText = user.email.split('@')[0];
            document.getElementById('userBadge').style.display = 'block';
            
            // ç™»å½•åï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡â€œäº‘ç«¯ -> æœ¬åœ°â€åŒæ­¥
            syncCloudToLocal().then(() => {
                loadConfig(); 
                migrateData(); 
                initHome();
            });
        }

        function switchMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? 'æ³¨å†Œæ–°è´¦å·' : 'äº‘ç«¯è´¦å·ç™»å½•';
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? 'æ³¨å†Œ' : 'ç™»å½•';
            document.querySelector('.auth-switch').innerText = isRegisterMode ? 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ';
            document.getElementById('auth-error').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.innerText = msg;
            el.style.display = 'block';
        }

        async function logout() {
            if(confirm('ç¡®å®šé€€å‡ºç™»å½•å—ï¼Ÿ')) {
                await _supabase.auth.signOut();
                window.location.reload();
            }
        }

        // --- â˜ï¸ æ ¸å¿ƒï¼šæ•°æ®åŒæ­¥é€»è¾‘ ---
        
        // 1. ä¸Šä¼ ï¼šæœ¬åœ° -> äº‘ç«¯ (é˜²æŠ–ï¼Œæ“ä½œåå»¶è¿Ÿ1ç§’è§¦å‘)
        function debouncedSync() {
            if (!currentUser) return;
            showToast('ğŸ”„ æ­£åœ¨åŒæ­¥...');
            clearTimeout(syncTimer);
            syncTimer = setTimeout(async () => {
                const payload = {
                    projects: JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'),
                    config: JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}'),
                    attendance: JSON.parse(localStorage.getItem(DB_KEY_OT) || '{}'),
                    todo: JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]'),
                    calendar: JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}'),
                    updated_at: new Date().toISOString()
                };
                
                const { error } = await _supabase
                    .from('user_data')
                    .upsert({ user_id: currentUser.id, content: payload });

                if (!error) showToast('âœ… å·²åŒæ­¥åˆ°äº‘ç«¯');
                else showToast('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }, 1000);
        }

        // 2. ä¸‹è½½ï¼šäº‘ç«¯ -> æœ¬åœ° (ç™»å½•æ—¶è§¦å‘)
        async function syncCloudToLocal() {
            const { data, error } = await _supabase
                .from('user_data')
                .select('content')
                .eq('user_id', currentUser.id)
                .single();
            
            if (data && data.content) {
                const c = data.content;
                if(c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                if(c.config && Object.keys(c.config).length > 0) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                if(c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                if(c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                if(c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
                console.log('äº‘ç«¯æ•°æ®å·²åŠ è½½');
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        // ==========================================
        // ğŸ“¦ åŸæœ‰é€»è¾‘ (æ— ç¼é›†æˆ)
        // ==========================================

        function goToPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.getElementById('backBtn').style.display = id === 'homePage' ? 'none' : 'block';
            
            const confBtn = document.getElementById('nodeConfigBtn');
            if(confBtn) {
                if (id === 'projectList' || id === 'projectDetail') {
                    confBtn.style.display = 'block';
                } else {
                    confBtn.style.display = 'none';
                }
            }

            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        const DB_KEY_DATA = 'engineering_master_db'; 
        const DB_KEY_CONFIG = 'engineering_config_v15';
        const DB_KEY_OT = 'attendance_master_db_v2';
        const DB_KEY_TODO = 'todo_master_db'; 
        const DB_KEY_CAL = 'calendar_master_db';

        const DEFAULT_CONFIG={"æ–¹æ¡ˆè®¾è®¡":[{"key":"finishDate","label":"å®Œæˆæ—¶é—´","type":"date"},{"key":"unit","label":"è®¾è®¡å•ä½","type":"text"}],"æäº¤å¸‚å±€å®¡æ ¸":[{"key":"submitDate","label":"åˆå®¡æäº¤","type":"date"},{"key":"replyDate","label":"åˆå®¡å¤å‡½","type":"date"},{"key":"reCheckSubmit","label":"å¤æ ¸æäº¤","type":"date"},{"key":"reCheckReply","label":"å¤æ ¸å¤å‡½","type":"date"}],"äº‹å‰è¯„ä¼°":[{"key":"evalDate","label":"è¯„ä¼°æ—¶é—´","type":"date"},{"key":"reportDate","label":"æŠ¥å‘Šå‡ºå…·","type":"date"}],"è´¢æ”¿è¯„å®¡":[{"key":"submitTime","label":"èµ„æ–™æäº¤","type":"date"},{"key":"outTime","label":"æŠ¥å‘Šå‡ºå…·","type":"date"},{"key":"money","label":"å®¡å®šé‡‘é¢(å…ƒ)","type":"number"}],"èµ„é‡‘åˆ°è´¦":[{"key":"arriveDate","label":"ä¸‹è¾¾æ—¶é—´","type":"date"},{"key":"amount","label":"åˆ°è´¦é‡‘é¢","type":"number"}],"ç®¡ç†å¤„å†³ç­–":[{"key":"meetType","label":"è®®é¢˜ç±»å‹","type":"select","options":["ç«‹é¡¹","åˆåŒç­¾è®¢","å…¶ä»–"]},{"key":"contractSubType","label":"åˆåŒç±»å‹","type":"select","options":["è®¾è®¡åˆåŒ","æ–½å·¥åˆåŒ","ç›‘ç†åˆåŒ","å…¶ä»–"]},{"key":"otherContent","label":"å…¶ä»–å†…å®¹","type":"text"},{"key":"meetLevel","label":"å†³ç­–å±‚çº§","type":"select","options":["å…šç»„ä¼š","ä¸»ä»»åŠå…¬ä¼š","çº¸è´¨è¯·ç¤º"]},{"key":"meetDate","label":"ä¼šè®®æ—¶é—´","type":"date"}],"ç­¾è®¢åˆåŒ":[{"key":"contractType","label":"åˆåŒç±»å‹","type":"select","options":["æ–½å·¥åˆåŒ","è®¾è®¡åˆåŒ","ç›‘ç†åˆåŒ","å…¶ä»–"]},{"key":"otherContractName","label":"å…¶ä»–åˆåŒå","type":"text"},{"key":"signDate","label":"ç­¾è®¢æ—¥æœŸ","type":"date"},{"key":"contractAmount","label":"åˆåŒé‡‘é¢","type":"number"}],"æ–½å·¥è¿‡ç¨‹":[{"key":"startDate","label":"å¼€å·¥æ—¶é—´","type":"date"},{"key":"endDate","label":"ç«£å·¥æ—¶é—´","type":"date"},{"key":"checkDate","label":"éªŒæ”¶æ—¶é—´","type":"date"}],"ä»˜æ¬¾":[{"key":"linkContract","label":"å…³è”åˆåŒ","type":"select","options":["æ— å¯ç”¨åˆåŒ"]},{"key":"payType","label":"æ¬¾é¡¹æ€§è´¨","type":"select","options":["é¦–ç¬”","è¿›åº¦æ¬¾","å°¾æ¬¾"]},{"key":"payAmount","label":"æ”¯ä»˜é‡‘é¢(å…ƒ)","type":"number"}],"ç»“ç®—å®¡è®¡":[{"key":"auditEnd","label":"æŠ¥å‘Šå‡ºå…·","type":"date"},{"key":"finalAmount","label":"æœ€ç»ˆé‡‘é¢","type":"number"}],"å½’æ¡£":[{"key":"archiveDate","label":"å½’æ¡£æ—¶é—´","type":"date"},{"key":"location","label":"å­˜æ”¾ä½ç½®","type":"text"}]};

        let GLOBAL_CONFIG={}, currentProjectId=null, currentStageIndex=null, draggedItemIndex=null, draggedProjectIndex=null, configMode='global', tempLocalConfig=null, editingKey=null, dragSrcType=null;
        
        let viewYear = new Date().getFullYear();
        let viewMonth = new Date().getMonth();
        let selectedDateStr = null;

        // ğŸŒŸ æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ä¿å­˜æœ¬åœ°æ—¶ï¼Œè§¦å‘ debouncedSync()
        const DB = { get:()=>JSON.parse(localStorage.getItem(DB_KEY_DATA)||'[]'), save:d=>{localStorage.setItem(DB_KEY_DATA,JSON.stringify(d)); debouncedSync();} };
        const DB_OT = { get:()=>{const d=localStorage.getItem(DB_KEY_OT);return d?JSON.parse(d):{annual:0, saved:0, records:[], leaveRecords:[]}}, save:d=>{localStorage.setItem(DB_KEY_OT,JSON.stringify(d)); debouncedSync();} };
        const DB_TODO = { get:()=>JSON.parse(localStorage.getItem(DB_KEY_TODO)||'[]'), save:d=>{localStorage.setItem(DB_KEY_TODO,JSON.stringify(d)); debouncedSync();} };
        const DB_CAL = { get:()=>{const d=localStorage.getItem(DB_KEY_CAL); return d?JSON.parse(d):{}}, save:d=>{localStorage.setItem(DB_KEY_CAL,JSON.stringify(d)); debouncedSync();} };

        function loadConfig() { GLOBAL_CONFIG = JSON.parse(localStorage.getItem(DB_KEY_CONFIG)) || JSON.parse(JSON.stringify(DEFAULT_CONFIG)); }
        function migrateData() { let list=DB.get(),ch=false; list.forEach(p=>{p.stages.forEach(s=>{if(!s.config){s.config=JSON.parse(JSON.stringify(GLOBAL_CONFIG[s.name]||[]));ch=true}})}); if(ch)DB.save(list); }

        window.onload = function() { 
            initApp(); // æ”¹ä¸ºå…ˆå¯åŠ¨ App é‰´æƒ
        };

        // --- é¦–é¡µ & æ—¥å†é€»è¾‘ ---
        function initHome() {
            const d = new Date();
            const days = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
            document.getElementById('welcomeDate').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ Â· ${days[d.getDay()]}`;
            
            const ot = DB_OT.get();
            let usedAnnual=0, usedSaved=0, activeOt=0;
            (ot.leaveRecords||[]).forEach(l=>{ if(l.type=='å¹´å‡')usedAnnual+=parseFloat(l.days); if(l.type=='å­˜ä¼‘')usedSaved+=parseFloat(l.days); });
            (ot.records||[]).forEach(r=>{ if(r.status!='used') activeOt+=parseFloat(r.days); });
            const total = (parseFloat(ot.annual||0)-usedAnnual) + (parseFloat(ot.saved||0)-usedSaved) + activeOt;
            document.getElementById('homeOtDays').innerText = total;

            const todos = DB_TODO.get();
            const activeTodo = todos.filter(t=>!t.done).length;
            document.getElementById('homeTodoCount').innerText = activeTodo;

            renderCalendar(viewYear, viewMonth);
            renderTodos();
        }

        function renderCalendar(y, m) {
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            const todayDate = new Date();
            const isCurrentMonth = (y === todayDate.getFullYear() && m === todayDate.getMonth());
            const today = todayDate.getDate();
            const logs = DB_CAL.get();

            document.getElementById('calMonth').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '<div class="cal-day-name">æ—¥</div><div class="cal-day-name">ä¸€</div><div class="cal-day-name">äºŒ</div><div class="cal-day-name">ä¸‰</div><div class="cal-day-name">å››</div><div class="cal-day-name">äº”</div><div class="cal-day-name">å…­</div>';
            
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            
            for(let i=1; i<=daysInMonth; i++) {
                const mStr = (m+1).toString().padStart(2,'0');
                const dStr = i.toString().padStart(2,'0');
                const dateKey = `${y}-${mStr}-${dStr}`;
                
                let cls = 'cal-day';
                if (isCurrentMonth && i === today) cls += ' today';
                if (logs[dateKey]) cls += ' has-log';

                const div = document.createElement('div');
                div.className = cls;
                div.innerText = i;
                div.onclick = () => openDayLog(dateKey);
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if(viewMonth > 11) { viewMonth = 0; viewYear++; }
            if(viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderCalendar(viewYear, viewMonth);
        }

        function goToday() {
            const d = new Date();
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
        }

        function openDayLog(dateStr) {
            selectedDateStr = dateStr;
            document.getElementById('logDateTitle').innerText = dateStr;
            const logs = DB_CAL.get();
            document.getElementById('logContent').value = logs[dateStr] || '';
            openModal('dayLogModal');
        }

        function saveDayLog() {
            if(!selectedDateStr) return;
            const content = document.getElementById('logContent').value.trim();
            const logs = DB_CAL.get();
            if(content) {
                logs[selectedDateStr] = content;
            } else {
                delete logs[selectedDateStr];
            }
            DB_CAL.save(logs);
            closeModal('dayLogModal');
            renderCalendar(viewYear, viewMonth);
        }

        function renderTodos() {
            const list = DB_TODO.get(); const container = document.getElementById('todoList'); container.innerHTML = '';
            list.forEach((t, idx) => {
                const div = document.createElement('div'); div.className = `todo-item ${t.done?'done':''}`;
                div.innerHTML = `<div class="todo-checkbox" onclick="toggleTodo(${idx})">${t.done?'âœ”':''}</div><div class="todo-text">${t.text}</div><div class="todo-del" onclick="deleteTodo(${idx})">Ã—</div>`;
                container.appendChild(div);
            });
        }
        function addTodo() { const val = document.getElementById('todoInput').value; if(!val) return; const list = DB_TODO.get(); list.unshift({ text: val, done: false }); DB_TODO.save(list); document.getElementById('todoInput').value = ''; renderTodos(); initHome(); }
        function toggleTodo(idx) { const list = DB_TODO.get(); list[idx].done = !list[idx].done; DB_TODO.save(list); renderTodos(); initHome(); }
        function deleteTodo(idx) { const list = DB_TODO.get(); list.splice(idx, 1); DB_TODO.save(list); renderTodos(); initHome(); }

        // --- è€ƒå‹¤é¡µé€»è¾‘ ---
        function getDeadline(dateStr) { if(!dateStr) return "æœªçŸ¥"; const d = new Date(dateStr); const target = new Date(d.getFullYear(), d.getMonth() + 2, 0); return target.toISOString().split('T')[0]; }
        function renderOtPage() {
            const data = DB_OT.get(); document.getElementById('inpAnnual').value = data.annual; document.getElementById('inpSaved').value = data.saved;
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            const lvContainer = document.getElementById('leaveListContainer'); lvContainer.innerHTML = '';
            (data.leaveRecords || []).sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach((l, idx) => {
                const days = parseFloat(l.days); let typeColor = '#999';
                if (l.type === 'å¹´å‡') { usedAnnual += days; typeColor = '#007AFF'; } if (l.type === 'å­˜ä¼‘') { usedSaved += days; typeColor = '#AF52DE'; }
                const div = document.createElement('div'); div.className = 'ot-list-item'; 
                div.innerHTML = `<div><div style="font-weight:600"><span class="leave-type-tag" style="background:${typeColor}">${l.type||'ä¼‘å‡'}</span>${l.date} <span style="color:#FF3B30">-${days}å¤©</span></div><div style="font-size:12px;color:#999;margin-left:5px;">${l.note||'-'}</div></div><span onclick="delLeaveItem(${idx})" style="color:#ccc;cursor:pointer">ğŸ—‘ï¸</span>`;
                lvContainer.appendChild(div);
            });
            const otContainer = document.getElementById('otListContainer'); otContainer.innerHTML = '';
            (data.records || []).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const div = document.createElement('div'); div.className = `ot-card ${r.status === 'used' ? 'used' : ''}`;
                let actionHtml = ''; let statusBadge = '';
                if (r.status === 'used') { statusBadge = `<span class="ot-badge">å·²ä¼‘</span>`; actionHtml = `<span style="font-size:12px;">å½’æ¡£: ${r.usedDate}</span> <button class="btn-mini" onclick="delOtItem('${r.id}')">ğŸ—‘ï¸</button>`; } 
                else { activeOt += parseFloat(r.days); const deadline = getDeadline(r.date); statusBadge = `<span class="ot-badge" style="background:#e3f2fd;color:#007AFF">å¾…ä¼‘</span>`; actionHtml = `<div style="display:flex;justify-content:space-between;align-items:center;"><div class="ot-deadline">æœ‰æ•ˆæœŸè‡³: ${deadline}</div><div><button class="btn-mini action" onclick="preUseOt('${r.id}')">âœ… ä¼‘å®Œ</button><button class="btn-mini" onclick="delOtItem('${r.id}')">ğŸ—‘ï¸</button></div></div>`; }
                div.innerHTML = `<div class="ot-card-header"><div class="ot-date">${r.date} <span style="font-size:14px;margin-left:5px;">+${r.days}å¤©</span></div>${statusBadge}</div><div class="ot-desc">${r.note || 'æ— å¤‡æ³¨'}</div>${actionHtml}`;
                otContainer.appendChild(div);
            });
            const remAnnual = parseFloat(data.annual || 0) - usedAnnual; const remSaved = parseFloat(data.saved || 0) - usedSaved;
            document.getElementById('dispAnnual').innerText = remAnnual; document.getElementById('dispSaved').innerText = remSaved; document.getElementById('dispOt').innerText = activeOt;
            document.getElementById('otTotalDays').innerText = remAnnual + remSaved + activeOt;
        }
        function saveBaseLeave() { const data = DB_OT.get(); data.annual = document.getElementById('inpAnnual').value || 0; data.saved = document.getElementById('inpSaved').value || 0; DB_OT.save(data); renderOtPage(); }
        function addOvertime() { const date = document.getElementById('otDate').value; const days = document.getElementById('otDays').value; if(!date || !days) return alert("è¯·å¡«å†™å®Œæ•´"); const data = DB_OT.get(); data.records.push({ id: Date.now().toString(), date, days, note: document.getElementById('otNote').value, status: 'active' }); DB_OT.save(data); closeModal('addOtModal'); renderOtPage(); }
        function preUseOt(id) { document.getElementById('useOtId').value = id; document.getElementById('useOtDate').value = new Date().toISOString().split('T')[0]; openModal('useOtModal'); }
        function confirmUseOt() { const id = document.getElementById('useOtId').value; const date = document.getElementById('useOtDate').value; if(!date) return alert("è¯·å¡«å†™æ—¥æœŸ"); const data = DB_OT.get(); const item = data.records.find(r => r.id === id); if(item) { item.status = 'used'; item.usedDate = date; DB_OT.save(data); closeModal('useOtModal'); renderOtPage(); } }
        function delOtItem(id) { if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) { const data = DB_OT.get(); data.records = data.records.filter(r => r.id !== id); DB_OT.save(data); renderOtPage(); } }
        function addLeaveRecord() { const type = document.getElementById('lvType').value; const date = document.getElementById('lvDate').value; const days = document.getElementById('lvDays').value; if(!date || !days) return alert("è¯·å¡«å†™å®Œæ•´"); const data = DB_OT.get(); if(!data.leaveRecords) data.leaveRecords = []; data.leaveRecords.push({ type, date, days, note: document.getElementById('lvNote').value }); DB_OT.save(data); document.getElementById('lvDate').value=''; closeModal('addLeaveModal'); renderOtPage(); }
        function delLeaveItem(idx) { if(confirm("åˆ é™¤æ­¤ä¼‘å‡è®°å½•ï¼Ÿå°†æ¢å¤å¯¹åº”çš„é¢åº¦ã€‚")) { const data = DB_OT.get(); data.leaveRecords.sort((a,b)=>new Date(b.date)-new Date(a.date)); data.leaveRecords.splice(idx, 1); DB_OT.save(data); renderOtPage(); } }

        // --- å·¥ç¨‹æ ¸å¿ƒ ---
        function openConfigModal(mode, stageIndex = null) {
            configMode = mode; document.getElementById('configEmptyHint').style.display = 'block'; document.getElementById('fieldEditorArea').style.display = 'none';
            if (mode === 'global') { document.getElementById('configSidebar').style.display = 'block'; renderConfigSidebar(); } 
            else { document.getElementById('configSidebar').style.display = 'none'; currentStageIndex = stageIndex; const p = DB.get().find(x => x.id === currentProjectId); const stage = p.stages[stageIndex]; tempLocalConfig = JSON.parse(JSON.stringify(stage.config)); editingKey = 'LOCAL_EDIT'; document.getElementById('configEmptyHint').style.display='none'; document.getElementById('fieldEditorArea').style.display='block'; document.getElementById('currentEditingNodeTitle').innerText = stage.name; renderConfigFields(tempLocalConfig); }
            openModal('configModal');
        }
        function renderConfigSidebar() { const c = document.getElementById('configSidebar'); c.innerHTML=''; Object.keys(GLOBAL_CONFIG).forEach(n=>{ const d=document.createElement('div'); d.className=`config-node-item ${editingKey===n?'active':''}`; d.innerHTML=`<span>${n}</span> <span class="icon-btn" onclick="deleteConfigNode(event,'${n}')">Ã—</span>`; d.onclick=()=>selectConfigNode(n); c.appendChild(d); }); }
        function selectConfigNode(n) { editingKey = n; renderConfigSidebar(); document.getElementById('configEmptyHint').style.display='none'; document.getElementById('fieldEditorArea').style.display='block'; document.getElementById('currentEditingNodeTitle').innerText=`ç¼–è¾‘æ¨¡ç‰ˆï¼š${n}`; renderConfigFields(GLOBAL_CONFIG[n]); }
        function renderConfigFields(fields) { const list = document.getElementById('configFieldsList'); list.innerHTML = ''; fields.forEach((f, i) => { const row = document.createElement('div'); row.className = 'field-row'; let t=`<option value="text" ${f.type==='text'?'selected':''}>æ–‡æœ¬</option><option value="date" ${f.type==='date'?'selected':''}>æ—¥æœŸ</option><option value="number" ${f.type==='number'?'selected':''}>æ•°å­—</option><option value="select" ${f.type==='select'?'selected':''}>ä¸‹æ‹‰</option>`; let optBtn = ''; if(f.type === 'select') { optBtn = `<span class="icon-btn" onclick="editFieldOptions(${i})" style="color:var(--primary);font-weight:bold;">â‰¡</span>`; } row.innerHTML = `<input value="${f.label}" onchange="updateField(${i},'label',this.value)" style="flex:2"><select onchange="updateField(${i},'type',this.value)" style="flex:1">${t}</select>${optBtn}<span class="icon-btn" onclick="deleteConfigField(${i})">ğŸ—‘ï¸</span>`; list.appendChild(row); }); }
        function editFieldOptions(i) { const target = configMode === 'global' ? GLOBAL_CONFIG[editingKey] : tempLocalConfig; const newString = prompt("è¯·è¾“å…¥é€‰é¡¹ (ç”¨é€—å·åˆ†éš”):", (target[i].options||[]).join(",")); if (newString !== null) { target[i].options = newString.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s); renderConfigFields(target); } }
        function addNewConfigNode() { const n = prompt("è¯·è¾“å…¥æ–°èŠ‚ç‚¹åç§°"); if(n && !GLOBAL_CONFIG[n]) { GLOBAL_CONFIG[n] = [{ key: "note", label: "å¤‡æ³¨", type: "text" }]; renderConfigSidebar(); selectConfigNode(n); } }
        function deleteConfigNode(e, name) { e.stopPropagation(); if(confirm(`åˆ é™¤æ¨¡ç‰ˆã€${name}ã€‘ï¼Ÿ`)) { delete GLOBAL_CONFIG[name]; if(editingKey === name) { editingKey = null; document.getElementById('fieldEditorArea').style.display = 'none'; document.getElementById('configEmptyHint').style.display = 'block'; } renderConfigSidebar(); } }
        function addNewConfigField() { const target = configMode === 'global' ? GLOBAL_CONFIG[editingKey] : tempLocalConfig; target.push({key:'f_'+Date.now(), label:"æ–°é¡¹ç›®", type:"text"}); renderConfigFields(target); }
        function deleteConfigField(i) { const target = configMode === 'global' ? GLOBAL_CONFIG[editingKey] : tempLocalConfig; target.splice(i, 1); renderConfigFields(target); }
        function updateField(i, p, v) { const target = configMode === 'global' ? GLOBAL_CONFIG[editingKey] : tempLocalConfig; target[i][p] = v; if(p === 'type') renderConfigFields(target); }
        function handleConfigSave() { 
            if (configMode === 'global') { 
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG)); 
                debouncedSync(); // è§¦å‘åŒæ­¥
                alert("å…¨å±€æ¨¡ç‰ˆå·²æ›´æ–°"); 
            } else { 
                const list = DB.get(); 
                const p = list.find(x => x.id === currentProjectId); 
                p.stages[currentStageIndex].config = tempLocalConfig; 
                DB.save(list); 
                refreshDetail(p); 
            } 
            closeModal('configModal'); 
        }

        function createProject() { const n=document.getElementById('newProjectName').value; if(!n)return alert("è¯·è¾“å…¥åç§°"); DB.save([{id:Date.now(),name:n,type:document.getElementById('newProjectType').value,createDate:new Date().toLocaleDateString(),stages:[]},...DB.get()]); closeModal('createModal'); goToPage('projectList'); }
        function openNodeLibrary() { document.getElementById('nodeLibraryGrid').innerHTML = Object.keys(GLOBAL_CONFIG).map(n => `<div class="node-option" onclick="addStage('${n}')">+ ${n}</div>`).join(''); openModal('nodeLibraryModal'); }
        function addStage(nodeName) { const list = DB.get(); const p = list.find(x => x.id === currentProjectId); const configCopy = JSON.parse(JSON.stringify(GLOBAL_CONFIG[nodeName] || [])); p.stages.push({ name: nodeName, status: 'waiting', data: {}, config: configCopy }); DB.save(list); closeModal('nodeLibraryModal'); refreshDetail(p); setTimeout(() => { document.querySelector('.page-container').scrollTop = 99999; }, 100); }
        function openStageEdit(index) {
            currentStageIndex = index; const project = DB.get().find(p => p.id === currentProjectId); const stage = project.stages[index]; const config = stage.config; 
            document.getElementById('formTitle').innerText = stage.name; const container = document.getElementById('dynamicFormContainer'); container.innerHTML = '';
            let minD = ""; for(let i=index-1; i>=0; i--) { const ps = project.stages[i]; if(ps.config && ps.data) { const ds = ps.config.filter(f=>f.type==='date'&&ps.data[f.key]).map(f=>ps.data[f.key]); if(ds.length) { ds.sort(); minD = ds[ds.length-1]; break; } } }
            config.forEach(f => {
                const w = document.createElement('div'); w.id = 'w_' + f.key; w.innerHTML = `<label class="form-label">${f.label}</label>`; if(f.key === 'otherContent') w.style.display = 'none';
                let inp; const v = stage.data[f.key] || '';
                if(f.type === 'select') {
                    inp = document.createElement('select'); inp.className = 'input-box';
                    let ops = f.options || ["æ— é€‰é¡¹"];
                    if(stage.name==="ç­¾è®¢åˆåŒ"&&f.key==="contractType") ops=getDecisionTypes(project);
                    if(stage.name==="ä»˜æ¬¾"&&f.key==="linkContract") ops=getSignedContracts(project);
                    ops.forEach(o => { let opt=document.createElement('option'); opt.value=o; opt.innerText=o; inp.appendChild(opt); }); inp.value = v;
                    if(f.key === 'meetType' || f.key === 'contractSubType' || f.key === 'contractType') { inp.addEventListener('change', handleLinkage); }
                } else {
                    inp = document.createElement('input'); inp.type = f.type==='date'?'date':(f.type==='number'?'number':'text'); inp.className = 'input-box'; inp.value = v;
                    if(f.type==='date' && minD) { inp.min = minD; inp.onchange = function() { if(this.value && this.value < minD) { alert("ä¸å¯æ—©äºä¸Šä¸€æ­¥"); this.value=''; } } }
                    if(f.key==='payAmount') inp.oninput = function() { calcPay(this.value, stage.data.linkContract, project); }
                }
                inp.id = `f_${f.key}`; w.appendChild(inp); if(f.key==='payAmount') w.innerHTML+='<div id="calcHint" style="font-size:12px;color:blue;margin-top:2px;"></div>'; container.appendChild(w);
            });
            handleLinkage(); openModal('dynamicFormModal');
        }

        // ğŸŒŸ V44.0 ä¿®å¤ï¼šä½¿ç”¨å®½æ¾ç­‰äº (==)
        function openDetail(id){ currentProjectId=id; const p=DB.get().find(x=>x.id==id); document.getElementById('detailTitle').innerText=p.name; document.getElementById('detailType').innerText={'special':'ä¸“é¡¹','odd':'é›¶æ˜Ÿ','repair':'æŠ¢ä¿®'}[p.type]; goToPage('projectDetail'); refreshDetail(p); }
        
        function refreshDetail(p) {
            const c = document.getElementById('stagesContainer'); c.innerHTML = ''; const prev = document.getElementById('previewFlow'); prev.innerHTML = '';
            p.stages.forEach((s, i) => {
                const conf = s.config || [];
                const getDisplayHtml = (mode) => {
                    return conf.map(f => {
                        if (!s.data[f.key]) return ''; if (f.key === 'otherContent' || f.key === 'otherContractName') return ''; 
                        let displayVal = s.data[f.key]; if (f.type === 'number') displayVal = 'Â¥' + displayVal;
                        if ((f.key === 'meetType' || f.key === 'contractSubType' || f.key === 'contractType') && displayVal === 'å…¶ä»–') { if (s.data['otherContent']) displayVal = s.data['otherContent']; if (s.data['otherContractName']) displayVal = s.data['otherContractName']; }
                        if (mode === 'preview') return `<div class="preview-kv"><span class="preview-k">${f.label}:</span><span class="preview-v">${displayVal}</span></div>`;
                        return `<div class="data-item"><span class="data-label">${f.label}</span><span class="data-value">${displayVal}</span></div>`;
                    }).join('');
                };
                if(s.status === 'done') { prev.innerHTML += `<div class="preview-item done"><div class="preview-item-title"><span>${s.name}</span></div><div class="preview-data-table">${getDisplayHtml('preview')}</div></div>`; }
                let det = ''; if(s.status !== 'waiting') { det = '<div class="data-grid">' + getDisplayHtml('card') + '</div>'; }
                const ico = s.status==='done'?'âœ…':(s.status==='processing'?'ğŸ”¥':'â³');
                // ğŸŒŸ V44 èŠ‚ç‚¹æ’åºæŒ‰é’® (æ›¿ä»£æ‹–æ‹½)
                c.innerHTML += `
                <div class="stage-card ${s.status}">
                    <div class="node-sort-zone">
                        <button class="node-sort-btn" onclick="moveStageUp(${i})">â†‘</button>
                        <button class="node-sort-btn" onclick="moveStageDown(${i})">â†“</button>
                    </div>
                    <div class="card-content" onclick="openStageEdit(${i})">
                        <div class="card-actions-fixed">
                            <button class="icon-btn-card btn-edit-struct" onclick="event.stopPropagation();openConfigModal('local', ${i})">âš™ï¸</button>
                            <button class="icon-btn-card btn-delete-node" onclick="event.stopPropagation();deleteStage(${i})">Ã—</button>
                        </div>
                        <div class="status-bar ${s.status}"></div>
                        <div class="card-header-row"><span class="card-title">${s.name}</span><span class="card-status-text">${ico}</span></div>
                        ${det}
                    </div>
                </div>`;
            });
        }

        // ğŸŒŸ V44 èŠ‚ç‚¹æ’åºé€»è¾‘
        function moveStageUp(i) {
            if (i === 0) return;
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            const temp = p.stages[i]; p.stages[i] = p.stages[i-1]; p.stages[i-1] = temp;
            DB.save(list); refreshDetail(p);
        }
        function moveStageDown(i) {
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (i === p.stages.length - 1) return;
            const temp = p.stages[i]; p.stages[i] = p.stages[i+1]; p.stages[i+1] = temp;
            DB.save(list); refreshDetail(p);
        }

        function editProjectName() { const p = DB.get().find(x => x.id === currentProjectId); const newName = prompt("ä¿®æ”¹å·¥ç¨‹åç§°:", p.name); if(newName && newName !== p.name) { const list = DB.get(); list.find(x => x.id === currentProjectId).name = newName; DB.save(list); document.getElementById('detailTitle').innerText = newName; } }
        function handleLinkage() { const mt = document.getElementById('f_meetType')?.value; const cst = document.getElementById('f_contractSubType')?.value; const ct = document.getElementById('f_contractType')?.value; const w_cst = document.getElementById('w_contractSubType'); const w_other = document.getElementById('w_otherContent'); const w_otherContract = document.getElementById('w_otherContractName'); if(w_cst) w_cst.style.display = (mt === 'åˆåŒç­¾è®¢') ? 'block' : 'none'; if(w_other) { w_other.style.display = ((mt === 'å…¶ä»–') || (mt === 'åˆåŒç­¾è®¢' && cst === 'å…¶ä»–')) ? 'block' : 'none'; } if(w_otherContract) { w_otherContract.style.display = (ct === 'å…¶ä»–') ? 'block' : 'none'; } }
        function getDecisionTypes(p) { const s=new Set(); p.stages.forEach(x=>{if(x.name==='ç®¡ç†å¤„å†³ç­–'&&x.data.contractSubType)s.add(x.data.contractSubType)}); return s.size?[...s]:['æ— ']; }
        function getSignedContracts(p) { const c=[]; p.stages.forEach(x=>{if(x.name==='ç­¾è®¢åˆåŒ'&&x.status==='done')c.push(x.data.contractType)}); return c.length?c:['æ— ']; }
        function calcPay(val, link, p) { const s=p.stages.find(x=>x.name==='ç­¾è®¢åˆåŒ'&&x.data.contractType===link); const tot=s?s.data.contractAmount:0; if(tot&&val) document.getElementById('calcHint').innerText=`æ¯”ä¾‹:${((val/tot)*100).toFixed(2)}% | å‰©:${tot-val}`; }
        function saveDynamicData() { const list = DB.get(); const p = list.find(x => x.id === currentProjectId); const stage = p.stages[currentStageIndex]; let nd = {}; let full = true; stage.config.forEach(f => { const el = document.getElementById(`f_${f.key}`); const wrapper = document.getElementById('w_' + f.key); if(wrapper && wrapper.style.display !== 'none') { if(el) { nd[f.key] = el.value; if(el.value==='') full=false; } } else { nd[f.key] = ''; } }); stage.data = {...stage.data, ...nd}; stage.status = Object.values(nd).some(v=>v) ? (full?'done':'processing') : 'waiting'; DB.save(list); closeModal('dynamicFormModal'); refreshDetail(p); }
        
        function deleteStage(i){ if(confirm("åˆ èŠ‚ç‚¹ï¼Ÿ")){ const l=DB.get(); const p=l.find(x=>x.id==currentProjectId); p.stages.splice(i,1); DB.save(l); refreshDetail(p); } }
        
        // ğŸŒŸ V43: å·¥ç¨‹åˆ—è¡¨æ”¹ä¸ºã€ç‚¹å‡»æ’åºã€‘
        function renderProjects() {
            const list = DB.get(); const cs = document.getElementById('container_special'); const co = document.getElementById('container_odd'); const cr = document.getElementById('container_repair');
            cs.innerHTML=''; co.innerHTML=''; cr.innerHTML=''; let c1=0, c2=0, c3=0;
            list.forEach((p, i) => {
                const d = document.createElement('div'); d.className='list-item';
                d.innerHTML = `
                    <div class="list-item-content" onclick="openDetail(${p.id})"><div class="list-item-title">${p.name}</div><div class="list-item-date">${p.createDate}</div></div>
                    <div class="list-sort-zone">
                        <button class="sort-btn up" onclick="moveProjUp(${i}, '${p.type}')">â¬†ï¸</button>
                        <button class="sort-btn down" onclick="moveProjDown(${i}, '${p.type}')">â¬‡ï¸</button>
                    </div>`;
                if(p.type==='special'){cs.appendChild(d);c1++;} else if(p.type==='odd'){co.appendChild(d);c2++;} else{cr.appendChild(d);c3++;}
            });
            document.getElementById('c_s').innerText=c1; document.getElementById('c_o').innerText=c2; document.getElementById('c_r').innerText=c3;
        }

        // ğŸŒŸ V43: æ’åºå‡½æ•°
        function moveProjUp(i, type) {
            if(i === 0) return; // å·²ç»åœ¨æœ€é¡¶
            const list = DB.get();
            // æ³¨æ„ï¼šå› ä¸ºåˆ—è¡¨æ˜¯åˆ†ç±»æ¸²æŸ“çš„ï¼Œiæ˜¯å…¨å±€ç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦æ›´èªæ˜çš„äº¤æ¢
            // ç®€å•åšæ³•ï¼šç›´æ¥äº¤æ¢æ•°ç»„å…ƒç´ 
            const temp = list[i]; list[i] = list[i-1]; list[i-1] = temp;
            DB.save(list); renderProjects();
        }
        function moveProjDown(i, type) {
            const list = DB.get();
            if(i === list.length - 1) return; // å·²ç»åœ¨æœ€åº•
            const temp = list[i]; list[i] = list[i+1]; list[i+1] = temp;
            DB.save(list); renderProjects();
        }

        function exportData(){ const d={v:"44.0",d:new Date(),p:DB.get(),c:GLOBAL_CONFIG, ot:DB_OT.get(), todo:DB_TODO.get(), cal:DB_CAL.get()}; const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"json"})); a.download=`backup_${Date.now()}.json`; a.click(); }
        function triggerImport(){ document.getElementById('importFile').click(); }
        function importData(i){ const r=new FileReader(); r.onload=e=>{ const b=JSON.parse(e.target.result); if(b.p) DB.save(b.p); if(b.c) localStorage.setItem(DB_KEY_CONFIG,JSON.stringify(b.c)); if(b.ot) DB_OT.save(b.ot); if(b.todo) DB_TODO.save(b.todo); if(b.cal) DB_CAL.save(b.cal); location.reload(); }; r.readAsText(i.files[0]); }

        function goHome(){ goToPage('homePage'); updateStats(); }
        function updateStats(){  }
        function openModal(id){ document.getElementById(id).classList.add('open'); }
        function closeModal(id){ document.getElementById(id).classList.remove('open'); }
    </script>
</body>

</html>