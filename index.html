<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工作助手 (V60 历史归档版)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- 基础变量 --- */
        /* 🌟 核心修复 1：防止页面左右晃动 & 统一尺寸计算 */
* {
    box-sizing: border-box; /* 让 padding 不会撑大宽度 */
    outline: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    /* ...原有样式... */
    overflow-x: hidden; /* 🚫 禁止横向滚动 */
    width: 100%;
}
        :root {
            --primary: #007AFF;
            --bg: #F5F7FA;
            --white: #FFFFFF;
            --green: #34C759;
            --orange: #FF9500;
            --purple: #5856D6;
            --text: #333;
            --border: #E5E5EA;
            --red: #FF3B30;
            --gray: #8E8E93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        /* 导航 */
        .navbar {
            background: var(--white);
            color: var(--text);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
            z-index: 100;
            height: 44px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        #backBtn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            font-weight: bold;
            padding: 0 10px 0 0;
            cursor: pointer;
            display: none;
        }

        .page-title {
            font-size: 18px;
            font-weight: 700;
            color: #000;
            margin: 0;
        }

        #nodeConfigBtn {
            background: #f0f0f5;
            border: none;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
            display: none;
        }

        /* 容器 */
        .page-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
            position: relative;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 悬浮按钮 (FAB) */
        .fab-add {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 900;
            transition: transform 0.1s;
        }

        .fab-add:active {
            transform: scale(0.95);
            background-color: #0056b3;
        }

        /* 首页资产卡片 */
        .welcome-row {
            margin-bottom: 20px;
        }

        .welcome-date {
            font-size: 13px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: 800;
            color: #333;
            margin: 5px 0 0 0;
        }

        .asset-card-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .asset-card {
            width: 100%;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.1s;
            box-sizing: border-box;
        }

        .asset-card.blue {
            background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
            color: white;
        }

        .asset-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .asset-value {
            font-size: 28px;
            font-weight: 800;
            line-height: 1.1;
        }

        /* 日历 */
        .calendar-section {
            background: white;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .cal-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
        }

        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .cal-day-name {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .cal-day {
            font-size: 13px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: #333;
            position: relative;
        }

        .cal-day.today {
            background: var(--primary);
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 122, 255, 0.4);
        }

        .cal-day.has-log::after {
            content: '';
            width: 4px;
            height: 4px;
            background: var(--red);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
        }

        /* --- 🌟 V60 新版待办样式 --- */
        .todo-section {
            margin-bottom: 30px;
        }

        .todo-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .btn-history {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-history:active {
            background: rgba(0, 0, 0, 0.1);
        }

        .todo-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .todo-input {
            flex: 1;
            border: none;
            background: #fff;
            padding: 12px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            font-size: 14px;
        }

        .todo-add-btn {
            background: var(--text);
            color: white;
            border: none;
            width: 44px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .todo-item {
            background: white;
            padding: 14px 16px;
            border-radius: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .todo-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .todo-text {
            font-size: 15px;
            line-height: 1.4;
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-size: 13px;
            padding: 20px 0;
            font-style: italic;
            opacity: 0.6;
        }

        /* 历史列表 */
        .history-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-restore {
            font-size: 12px;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 4px 8px;
            border-radius: 6px;
            background: none;
            cursor: pointer;
        }

        /* 功能导航 */
        .project-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .entry-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.1s;
        }

        .entry-card:active {
            transform: scale(0.96);
            background: #fafafa;
        }

        .entry-card.eng {
            border-bottom: 4px solid var(--primary);
        }

        .entry-card.non-eng {
            border-bottom: 4px solid var(--purple);
        }

        .entry-card.tools {
            border-bottom: 4px solid var(--orange);
        }

        .entry-icon {
            font-size: 32px;
            margin-bottom: 10px;
            display: block;
        }

        .entry-title {
            font-weight: 700;
            font-size: 15px;
            color: #333;
            display: block;
        }

        .footer-tools {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 40px;
        }

        .tool-btn {
            font-size: 12px;
            color: #999;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 20px;
            cursor: pointer;
        }

        /* 考勤 */
        .ot-summary-card {
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .ot-big-num {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .ot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 10px;
        }

        .ot-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .ot-val {
            font-size: 16px;
            font-weight: bold;
        }

        .ot-settings-mini {
            background: #fff;
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 13px;
            color: #666;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .ot-input-mini {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }

        .ot-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--green);
            position: relative;
        }

        .ot-card.used {
            border-left-color: #ccc;
            background: #f9f9f9;
            color: #999;
        }

        .ot-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .ot-date {
            font-weight: bold;
            font-size: 16px;
        }

        .ot-badge {
            background: #e8f5e9;
            color: var(--green);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .ot-card.used .ot-badge {
            background: #eee;
            color: #999;
        }

        .ot-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .ot-deadline {
            font-size: 12px;
            color: var(--orange);
            margin-top: 5px;
            font-weight: 500;
        }

        .ot-list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .leave-type-tag {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            color: white;
        }

        /* 工程列表 */
        .list-item {
            background: white;
            padding: 0;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            align-items: stretch;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .list-item-content {
            flex: 1;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-sort-zone {
            width: 32px;
            background: #fcfcfc;
            border-left: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
        }

        .sort-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: #ccc;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .sort-btn:active {
            color: var(--primary);
            background: #e0e0e0;
        }

        .sort-btn.up {
            border-bottom: 1px solid #eee;
        }

        .list-item-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            color: #333;
        }

        .list-item-date {
            font-size: 12px;
            color: #999;
        }

        .project-section-header {
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin: 15px 0 10px;
            padding-left: 10px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
        }

        .home-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin: 25px 0 10px 5px;
            border-left: 3px solid var(--primary);
            padding-left: 8px;
        }

        /* 详情页 */
        .stage-card {
            background: white;
            margin-bottom: 15px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            overflow: hidden;
        }

        .card-content {
            flex: 1;
            padding: 12px 15px;
            position: relative;
            min-width: 0;
        }

        .status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .status-bar.done {
            background: var(--green);
        }

        .status-bar.processing {
            background: var(--orange);
        }

        .status-bar.waiting {
            background: #ddd;
        }

        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-right: 70px;
        }

        .card-title {
            font-weight: bold;
            font-size: 15px;
            color: #333;
        }

        .card-status-text {
            font-size: 12px;
            color: #999;
        }

        .card-actions-fixed {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 5;
        }

        .icon-btn-card {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            background: #f2f2f7;
            color: #555;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding-bottom: 4px;
        }

        .data-label {
            color: #888;
        }

        .data-value {
            font-weight: 500;
            color: #333;
            text-align: right;
        }

        .preview-section {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .preview-item.done {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #333;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .preview-data-table {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 4px 8px;
            margin-top: 5px;
        }

        .preview-kv {
            display: flex;
            align-items: center;
        }

        .preview-k {
            color: #666;
            margin-right: 6px;
            white-space: nowrap;
        }

        /* 通用按钮 */
        .btn-add-node {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            width: 80%;
        }

        .back-btn-float {
            padding: 5px 12px;
            background: #e3f2fd;
            border-radius: 15px;
            color: var(--primary);
            font-size: 13px;
            border: 1px solid rgba(0, 122, 255, 0.1);
            cursor: pointer;
            font-weight: 500;
        }

        .btn-mini {
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid #ddd;
            background: white;
            font-size: 12px;
            cursor: pointer;
            color: #555;
        }

        .btn-mini.action {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* 弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 85%;
            max-width: 450px;
            padding: 25px 20px;
            border-radius: 15px;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin: 12px 0 6px;
            color: #444;
        }

/* 🌟 核心修复 2：统一 Input 和 Select 的外观 */
.input-box {
    width: 100%;
    height: 46px; /* 📏 强制统一高度，适合手指点击 */
    padding: 0 12px; /* 左右内边距 */
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 15px;
    background: #fafafa;
    color: #333;
    
    /* 关键：去除 iOS 默认样式 */
    -webkit-appearance: none; 
    appearance: none;
    border-radius: 8px; /* 再次强制圆角 */
    margin: 0; /* 去除默认外边距 */
    display: block;
}

/* 针对下拉框增加一个小箭头 (因为上面去除了默认样式) */
select.input-box {
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 10px;
    padding-right: 30px; /* 防止文字盖住箭头 */
}
 /* 🌟 核心修复 3：修复 iOS 日期文字垂直居中 */
input[type="date"].input-box {
    display: flex;
    align-items: center;
    line-height: 46px; /* 必须与 height 保持一致 */
}

/* 针对下拉框增加小箭头 (放在这里也很合适) */
select.input-box {
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.9%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 10px;
    padding-right: 30px;
}


        .log-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 15px;
            background: #fafafa;
            min-height: 100px;
            resize: vertical;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            width: 100%;
            margin-top: 10px;
            border: none;
            background: transparent;
            color: #999;
            cursor: pointer;
            padding: 10px;
            font-size: 14px;
        }

        /* 备选配置 - 垂直布局 */
        .config-container {
            display: flex;
            flex-direction: column;
            max-height: 70vh;
            overflow-y: auto;
            margin-top: 10px;
        }

        .config-category-title {
            background: #f5f5f7;
            border-left: 4px solid var(--primary);
            padding: 12px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin: 15px 0 10px 0;
            width: 100%;
            box-sizing: border-box;
        }

        .config-node-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 10px;
            margin-bottom: 10px;
        }

        .config-node-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .config-node-item:hover {
            background: #f9f9f9;
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.1);
        }

        .node-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .node-detail-modal.open {
            display: flex;
        }

        .node-detail-content {
            background: white;
            width: 85%;
            max-width: 500px;
            padding: 25px 20px;
            border-radius: 15px;
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .node-detail-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .node-field-list {
            flex: 1;
            margin-bottom: 15px;
        }

        .node-field-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-field-info {
            flex: 1;
        }

        .node-field-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .node-field-type {
            font-size: 12px;
            color: #999;
        }

        /* 节点排序 */
        .node-sort-zone {
            width: 36px;
            background: #f9f9f9;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .node-sort-btn {
            flex: 1;
            width: 100%;
            border: none;
            background: transparent;
            color: #ccc;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .node-sort-btn:active {
            color: var(--primary);
            background: #eee;
        }

        .node-sort-btn:first-child {
            border-bottom: 1px solid #eee;
        }

        .hidden {
            display: none;
        }

        /* 云同步 */
        #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .auth-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 85%;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .auth-box h2 {
            margin-top: 0;
            color: #1d1d1f;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-btn:active {
            background: #005bb5;
        }

        .auth-switch {
            margin-top: 15px;
            font-size: 14px;
            color: #007aff;
            cursor: pointer;
            text-decoration: underline;
        }

        .error-msg {
            color: #ff3b30;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .user-badge {
            font-size: 12px;
            color: var(--primary);
            background: #e3f2fd;
            padding: 4px 8px;
            border-radius: 10px;
            cursor: pointer;
        }

        /* 图标 */
        .btn-delete-icon {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
            flex-shrink: 0;
            opacity: 0.4;
            transition: all 0.2s;
        }

        .btn-delete-icon:active {
            transform: scale(0.9);
            opacity: 1;
        }

        .btn-delete-icon svg {
            width: 18px;
            height: 18px;
            stroke: #999;
            stroke-width: 1.5;
            fill: none;
        }

        .btn-delete-icon:active svg {
            stroke: #FF3B30;
        }

        /* 🌟 V60 核心修复：百宝箱 & 节点库网格布局 */
        #toolsPage {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            padding: 20px;
            box-sizing: border-box;
            z-index: 50;
        }

        #toolsPage.active {
            display: flex !important;
            flex-direction: column;
            justify-content: flex-start;
        }

        #toolsPage .page-header-row {
            margin-top: 0 !important;
            padding-top: 5px;
        }

        .page-header-row {
            display: flex;
            align-items: center;
            padding: 10px 0 20px 0;
            width: 100%;
            border-bottom: 1px solid #f5f5f7;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .page-header-title {
            font-size: 18px;
            font-weight: 700;
            margin-left: 15px;
            color: #333;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            align-content: start;
            width: 100%;
        }

        .tool-item {
            background: white;
            border-radius: 16px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            cursor: pointer;
            border: 1px solid #f5f5f7;
            height: 90px;
        }

        .tool-item:active {
            transform: scale(0.95);
            background: #fafafa;
        }

        .tool-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }

        .tool-name {
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }

        /* 🌟 V60 核心修复：节点库弹窗网格 */
        .node-library-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .node-library-grid>div[style*="grid-column"] {
            grid-column: 1 / -1 !important;
            margin: 15px 0 5px 0;
            padding-left: 8px;
            border-left: 3px solid var(--primary);
            font-size: 13px;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
            line-height: 30px;
        }

        .node-option {
            background: #ffffff;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        .node-option:active {
            background: #f2f2f7;
            transform: scale(0.96);
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="nav-left">
            <button id="backBtn" onclick="goHome()">←</button>
            <h1 id="pageTitle" class="page-title">工作助手</h1>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <span id="userBadge" class="user-badge" onclick="logout()" style="display:none;"></span>
            <button id="nodeConfigBtn" onclick="openConfigModal('global')">⚙️ 备选节点配置</button>
        </div>
    </nav>

    <div id="auth-modal" style="display:none;">
        <div class="auth-box">
            <h2 id="auth-title">个人账号登录</h2>
            <p style="font-size:12px;color:#666;margin-bottom:20px;">登录后可多端同步数据</p>
            <input type="email" id="email" name="username" autocomplete="username" class="auth-input"
                placeholder="任意邮箱格式的用户名">
            <input type="password" id="password" name="password" autocomplete="current-password" class="auth-input"
                placeholder="密码 (至少6位)">
            <button class="auth-btn" id="auth-action-btn" onclick="handleAuth()">登录</button>
            <div id="auth-error" class="error-msg"></div>
            <div class="auth-switch" onclick="switchMode()">没有账号？点击注册</div>
        </div>
    </div>

    <div id="toast" class="toast">已同步到云端</div>

    <div class="page-container">
        <div id="homePage" class="page active">
            <div class="welcome-row">
                <div class="welcome-date" id="welcomeDate">LOADING...</div>
                <div class="welcome-title">个人效能中心</div>
            </div>

            <div class="asset-card-row">
                <div class="asset-card blue" onclick="goToPage('attendancePage')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="asset-label" style="color:rgba(255,255,255,0.8); margin-bottom:5px;">当前可休总天数
                            </div>
                            <div class="asset-value" id="homeOtDays" style="font-size:42px;">0</div>
                        </div>
                        <div style="text-align:right; opacity:0.9;">
                            <div style="font-size:12px;">年假/存休/倒休</div>
                            <div style="font-size:24px; margin-top:5px;">📅</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-section">
                <div class="cal-header">
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(-1)">‹</div>
                    <span id="calMonth"></span>
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(1)">›</div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-mini" onclick="goToday()">回到今天</button>
                </div>
            </div>

            <div class="todo-section">
                <div class="todo-header-row">
                    <div class="section-head" style="margin:0;">📝 我的待办</div>
                    <button class="btn-history" onclick="openTodoHistory()">
                        <span>↺</span> 历史归档
                    </button>
                </div>

                <div class="todo-input-row">
                    <input type="text" id="todoInput" class="todo-input" placeholder="输入待办"
                        onkeypress="if(event.keyCode===13) addTodo()">
                    <button class="todo-add-btn" onclick="addTodo()">+</button>
                </div>

                <div id="todoList" class="todo-list">
                </div>
            </div>

            <div class="section-head" style="margin-top:20px;">🚀 功能导航</div>
            <div class="project-entry-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="entry-card eng" onclick="goToPage('projectList')" style="padding:15px 5px;">
                    <span class="entry-icon">🏗️</span>
                    <span class="entry-title" style="font-size:13px;">工程项目</span>
                </div>
                <div class="entry-card non-eng" onclick="goToPage('nonProjectList')" style="padding:15px 5px;">
                    <span class="entry-icon">📂</span>
                    <span class="entry-title" style="font-size:13px;">非工程</span>
                </div>
                <div class="entry-card tools" onclick="goToPage('toolsPage')" style="padding:15px 5px;">
                    <span class="entry-icon">🧰</span>
                    <span class="entry-title" style="font-size:13px;">百宝箱</span>
                </div>
            </div>

            <div class="footer-tools">
                <div class="tool-btn" onclick="exportData()">📤 备份数据</div>
                <div class="tool-btn" onclick="triggerImport()">📥 恢复数据(Plus版)</div>
            </div>
            <div
                style="text-align: center; color: #ccc; font-size: 10px; margin-bottom: 20px; font-family: monospace; opacity: 0.6;">
                v1.0.0</div>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>

        <div id="attendancePage" class="page">
            <div class="ot-summary-card">
                <div style="font-size:14px; opacity:0.8;">当前可休总天数</div>
                <div class="ot-big-num" id="otTotalDays">0.0</div>
                <div class="ot-grid">
                    <div>
                        <div class="ot-label">剩年假</div>
                        <div class="ot-val" id="dispAnnual">0</div>
                    </div>
                    <div>
                        <div class="ot-label">剩存休</div>
                        <div class="ot-val" id="dispSaved">0</div>
                    </div>
                    <div>
                        <div class="ot-label">加班池</div>
                        <div class="ot-val" id="dispOt">0</div>
                    </div>
                </div>
            </div>
            <div class="ot-settings-mini">
                <span>初始基数：</span>
                <label>年假</label><input type="number" id="inpAnnual" class="ot-input-mini" onchange="saveBaseLeave()">
                <label>存休</label><input type="number" id="inpSaved" class="ot-input-mini" onchange="saveBaseLeave()">
            </div>
            <div class="home-section-title">加班记录 (倒休)</div>
            <div id="otListContainer"></div>
            <div style="text-align:center; padding:10px;"><button class="btn-mini" onclick="openModal('addOtModal')">+
                    录入加班</button></div>
            <div class="home-section-title">休假记录</div>
            <div id="leaveListContainer"></div>
            <div style="text-align:center; padding:10px; margin-bottom:50px;"><button class="btn-mini"
                    onclick="openNewLeave()">+ 录入休假</button></div>
        </div>

        <div id="projectList" class="page">
            <div class="project-section">
                <div class="project-section-header" style="color:#007AFF;border-color:#007AFF;">专项工程 <span id="c_s"
                        style="font-size:12px;background:#e3f2fd;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_special" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#AF52DE;border-color:#AF52DE;">零星工程 <span id="c_o"
                        style="font-size:12px;background:#f3e5f5;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_odd" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#FF3B30;border-color:#FF3B30;">抢修工程 <span id="c_r"
                        style="font-size:12px;background:#ffebee;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_repair" class="project-section-body"></div>
            </div>
            <button class="fab-add" onclick="openModal('createModal')">+</button>
        </div>

        <div id="nonProjectList" class="page">
            <div style="text-align:center; padding:50px 20px; color:#999;">
                <div style="font-size:40px; margin-bottom:10px;">📂</div>
                <h3>非工程项目管理</h3>
                <p>此模块正在建设中...</p>
            </div>
        </div>

        <div id="projectDetail" class="page">
            <div style="position: relative; height: 44px; display: flex; align-items: center; margin-bottom: 20px;">
                <button class="back-btn-float" onclick="goHome()" style="z-index: 10; position: relative;">← 返回</button>
                <div style="position: absolute; left: 0; right: 0; text-align: center; pointer-events: none;">
                    <h2 id="detailTitle"
                        style="margin: 0; font-size: 18px; display: inline-block; pointer-events: auto;"
                        onclick="editProjectName()"></h2>
                    <span style="font-size: 14px; color: #999; cursor: pointer; pointer-events: auto;"
                        onclick="editProjectName()"> ✏️</span>
                    <div id="detailType" style="font-size: 10px; color: #999; margin-top: 2px;"></div>
                </div>
            </div>
            <div class="preview-section">
                <div class="preview-header"><span>📋 全息进度预览</span></div>
                <div id="previewFlow" class="preview-flow"></div>
            </div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="stagesContainer"></div>
                <div id="emptyHint" style="text-align:center; padding:40px; color:#999; font-size:14px; display:none;">
                    👇 点击下方按钮添加第一个流程节点</div>
            </div>
            <div style="text-align:center; padding-bottom:30px;">
                <button class="btn-add-node" onclick="openNodeLibrary()">+ 添加流程节点</button>
            </div>
        </div>
    </div>

    <div id="toolsPage" class="page">
        <div class="page-header-row">
            <span class="page-header-title">🧰 百宝箱</span>
        </div>
        <div class="tool-grid">
            <div class="tool-item" onclick="openModal('dateCalcModal')">
                <span class="tool-icon">📅</span>
                <span class="tool-name">日期计算</span>
            </div>
            <div class="tool-item" style="opacity:0.5; background:#f9f9f9; border:none; cursor:default;">
                <span class="tool-icon" style="font-size:24px; opacity:0.5;">➕</span>
                <span class="tool-name">更多...</span>
            </div>
            <div class="tool-item" style="opacity:0; pointer-events:none;"></div>
        </div>
    </div>

    <div id="dateCalcModal" class="modal">
        <div class="modal-content">
            <h3>📅 日期差计算器</h3>
            <div style="margin-top:15px;">
                <label class="form-label">开始日期</label>
                <input type="date" id="toolStartDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <label class="form-label">结束日期</label>
                <input type="date" id="toolEndDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <button class="btn-primary" onclick="calcDateDiff()" style="margin-top:20px;">计算天数</button>
                <div id="dateResult" class="tool-result"></div>
            </div>
            <button class="btn-cancel" onclick="closeModal('dateCalcModal')">关闭</button>
        </div>
    </div>

    <div id="dayLogModal" class="modal">
        <div class="modal-content">
            <h3 id="logDateTitle">202X-XX-XX</h3>
            <label class="form-label">工作日志</label>
            <textarea id="logContent" class="log-textarea" placeholder="记录今天的工作重点..."></textarea>
            <button class="btn-primary" onclick="saveDayLog()">保存日志</button>
            <button class="btn-cancel" onclick="closeModal('dayLogModal')">关闭</button>
        </div>
    </div>

    <div id="todoHistoryModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 5px;">📜 已完成任务</h3>
            <div style="font-size:12px; color:#999; margin-bottom:15px;">点击“恢复”可放回首页</div>
            <div id="historyListContainer" class="history-list">
            </div>
            <button class="btn-cancel" onclick="closeModal('todoHistoryModal')">关闭</button>
        </div>
    </div>

    <div id="addOtModal" class="modal">
        <div class="modal-content">
            <h3>录入加班</h3>
            <label class="form-label">日期</label>
            <input type="date" id="otDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">天数</label>
            <input type="number" id="otDays" class="input-box" step="0.5">
            <label class="form-label">备注</label>
            <input type="text" id="otNote" class="input-box">
            <button class="btn-primary" onclick="addOvertime()">确认</button>
            <button class="btn-cancel" onclick="closeModal('addOtModal')">取消</button>
        </div>
    </div>

    <div id="addLeaveModal" class="modal">
        <div class="modal-content">
            <h3 id="leaveModalTitle">录入休假</h3>
            <input type="hidden" id="lvEditIndex">
            <label class="form-label">类型</label>
            <select id="lvType" class="input-box">
                <option value="年假">年假</option>
                <option value="存休">存休</option>
                <option value="倒休">倒休</option>
                <option value="其他">其他</option>
            </select>
            <label class="form-label">日期</label>
            <input type="date" id="lvDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">天数</label>
            <input type="number" id="lvDays" class="input-box" step="0.5">
            <label class="form-label">说明</label>
            <input type="text" id="lvNote" class="input-box">
            <button class="btn-primary" id="lvSaveBtn" onclick="saveLeaveRecord()">确认</button>
            <button class="btn-cancel" onclick="closeModal('addLeaveModal')">取消</button>
        </div>
    </div>

    <div id="useOtModal" class="modal">
        <div class="modal-content">
            <h3>核销加班</h3>
            <p style="color:#666;font-size:13px;margin-bottom:15px">确认已倒休？</p>
            <label class="form-label">倒休日期</label>
            <input type="date" id="useOtDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <input type="hidden" id="useOtId">
            <button class="btn-primary" onclick="confirmUseOt()">确认</button>
            <button class="btn-cancel" onclick="closeModal('useOtModal')">取消</button>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>新建工程</h3>
            <label class="form-label">名称</label>
            <input type="text" id="newProjectName" class="input-box">
            <label class="form-label">类别</label>
            <select id="newProjectType" class="input-box">
                <option value="special">🌟 专项工程</option>
                <option value="odd">🔧 零星工程</option>
                <option value="repair">🚑 抢修工程</option>
            </select>
            <button class="btn-primary" onclick="createProject()">创建</button>
            <button class="btn-cancel" onclick="closeModal('createModal')">取消</button>
        </div>
    </div>

    <div id="nodeLibraryModal" class="modal">
        <div class="modal-content">
            <h3>选择节点</h3>
            <div id="nodeLibraryGrid" class="node-library-grid"></div>
            <button class="btn-cancel" onclick="closeModal('nodeLibraryModal')">取消</button>
        </div>
    </div>

    <div id="dynamicFormModal" class="modal">
        <div class="modal-content">
            <h3 id="formTitle"></h3>
            <div id="dynamicFormContainer"></div>
            <button class="btn-primary" onclick="saveDynamicData()">保存</button>
            <button class="btn-cancel" onclick="closeModal('dynamicFormModal')">取消</button>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 id="configModalTitle">备选节点配置</h3>
            <div class="config-container" id="configContainer"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-primary" style="flex:1;" onclick="handleConfigSave()">保存</button>
                <button class="btn-cancel" style="flex:1;" onclick="closeModal('configModal')">关闭</button>
            </div>
        </div>
    </div>

    <div id="nodeDetailModal" class="node-detail-modal">
        <div class="node-detail-content">
            <div class="node-detail-header" id="nodeDetailTitle"></div>
            <div class="node-field-list" id="nodeFieldList"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-small" onclick="addNewConfigField()" style="flex:1;">+ 增加字段</button>
                <button class="btn-small" onclick="saveNodeDetailEditor()"
                    style="flex:1; background:var(--primary); color:white;">保存</button>
                <button class="btn-small" onclick="closeNodeDetailEditor()" style="flex:1;">返回</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ☁️ 核心配置：云同步模块
        // ==========================================
        const SUPABASE_URL = 'https://api.9990088.xyz';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZGltYWR6cGJjdm10b3Vqb2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTE3NTksImV4cCI6MjA4NTY4Nzc1OX0.dMJdVjjr3D0oGRli1DE2ohvl-5abwLGHSPAaS8wREG0';

        const { createClient } = supabase;
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });

        let currentUser = null;
        let isRegisterMode = false;
        let syncTimer = null;

        async function initApp() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                document.getElementById('auth-modal').style.display = 'none';
                handleLoginSuccess(session.user);
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-action-btn');
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) return showAuthError('请输入邮箱和密码');

            btn.innerText = '处理中...';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            let result;
            if (isRegisterMode) {
                result = await _supabase.auth.signUp({ email, password });
            } else {
                result = await _supabase.auth.signInWithPassword({ email, password });
            }

            if (result.error) {
                showAuthError(result.error.message);
                btn.innerText = isRegisterMode ? '注册' : '登录';
                btn.disabled = false;
            } else {
                if (isRegisterMode && !result.data.session) {
                    showAuthError('注册成功！请检查邮箱确认邮件，确认后重新登录。');
                    btn.innerText = '注册';
                    btn.disabled = false;
                } else {
                    handleLoginSuccess(result.data.user);
                }
            }
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';
            const userBadge = document.getElementById('userBadge');
            userBadge.innerText = user.email.split('@')[0];
            userBadge.style.display = 'block';

            loadConfig();
            migrateData();
            initHome();

            syncCloudToLocal().then(() => {
                console.log("云端数据同步完成，刷新界面");
                loadConfig();
                migrateData();
                initHome();
            }).catch(err => {
                console.error("后台同步失败:", err);
            });
        }

        function switchMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? '注册新账号' : '云端账号登录';
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? '注册' : '登录';
            document.querySelector('.auth-switch').innerText = isRegisterMode ? '已有账号？点击登录' : '没有账号？点击注册';
            document.getElementById('auth-error').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.innerText = msg;
            el.style.display = 'block';
        }

        async function logout() {
            if (confirm('确定退出登录吗？')) {
                await _supabase.auth.signOut();
                window.location.reload();
            }
        }

        function debouncedSync() {
            if (!currentUser) return;
            showToast('🔄 正在同步...');
            clearTimeout(syncTimer);
            syncTimer = setTimeout(async () => {
                const payload = {
                    projects: JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'),
                    config: JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}'),
                    attendance: JSON.parse(localStorage.getItem(DB_KEY_OT) || '{}'),
                    todo: JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]'),
                    calendar: JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}'),
                    updated_at: new Date().toISOString()
                };
                const { error } = await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                if (!error) showToast('✅ 已同步到云端');
                else showToast('❌ 同步失败: ' + error.message);
            }, 1000);
        }

        async function syncCloudToLocal() {
            const { data, error } = await _supabase.from('user_data').select('content').eq('user_id', currentUser.id).single();
            if (data && data.content) {
                const c = data.content;
                if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                if (c.config && Object.keys(c.config).length > 0) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        function goHome() {
            // 🌟 核心修复：返回首页时强制隐藏子页面，显示主页
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('homePage').classList.add('active');

            // 隐藏返回按钮，显示头像
            document.getElementById('backBtn').style.display = 'none';
            const userBadge = document.getElementById('userBadge');
            if (userBadge) userBadge.style.display = 'block';

            // 隐藏配置按钮
            const confBtn = document.getElementById('nodeConfigBtn');
            if (confBtn) confBtn.style.display = 'none';

            // 刷新首页数据（包括待办、考勤等）
            initHome();
        }

        function goToPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            document.getElementById('backBtn').style.display = id === 'homePage' ? 'none' : 'block';

            // 头像只在首页显示
            const userBadge = document.getElementById('userBadge');
            if (userBadge) userBadge.style.display = id === 'homePage' ? 'block' : 'none';

            // 配置按钮只在工程相关页显示
            const confBtn = document.getElementById('nodeConfigBtn');
            if (confBtn) confBtn.style.display = (id === 'projectList' || id === 'projectDetail') ? 'block' : 'none';

            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        const DB_KEY_DATA = 'engineering_master_db';
        const DB_KEY_CONFIG = 'engineering_config_v15';
        const DB_KEY_OT = 'attendance_master_db_v2';
        const DB_KEY_TODO = 'todo_master_db';
        const DB_KEY_CAL = 'calendar_master_db';

        const NODE_CATEGORIES = {
            "📌 项目前期手续": ["方案设计", "市局报审", "区政府会", "发改委立项", "事前评估", "财政评审", "自定义新增"],
            "💰 采购手续": ["委托代理签合同", "编制采购文件", "意向公开", "发布公告", "完成评标", "发布中标公示"],
            "🏢 管理处内部手续": ["党组会", "主任办公会", "纸质请示", "付款"],
            "🏗️ 工程实施过程手续": ["开工备案", "设计交底", "施工入场", "竣工验收", "结算审核", "资料归档"]
        };

        // 🌟 核心：精简版业务字段库 (V59)
        const DEFAULT_CONFIG = {
            "方案设计": [
                { key: "finishDate", label: "图纸完成时间", type: "date" },
                { key: "designUnit", label: "设计单位", type: "text" }
            ],
            "市局报审": [
                { key: "submitDate", label: "报送时间", type: "date" },
                { key: "replyDate", label: "批复时间", type: "date" }
            ],
            "区政府会": [
                { key: "meetDate", label: "上会时间", type: "date" },
                { key: "minutesNo", label: "纪要文号", type: "text" }
            ],
            "发改委立项": [
                { key: "submitDate", label: "申报时间", type: "date" },
                { key: "approvalDate", label: "批复时间", type: "date" },
                { key: "approvalAmount", label: "批复金额(元)", type: "number" },
                { key: "projectCode", label: "项目代码", type: "text" }
            ],
            "事前评估": [
                { key: "evalDate", label: "评估会议时间", type: "date" },
                { key: "reportDate", label: "报告出具时间", type: "date" }
            ],
            "财政评审": [
                { key: "sendDate", label: "送审时间", type: "date" },
                { key: "reportDate", label: "评审报告时间", type: "date" },
                { key: "auditAmount", label: "审定金额(元)", type: "number" }
            ],
            "自定义新增": [
                { key: "taskName", label: "事项名称", type: "text" },
                { key: "finishDate", label: "完成时间", type: "date" },
                { key: "remark", label: "备注", type: "text" }
            ],
            "委托代理签合同": [
                { key: "signDate", label: "签订时间", type: "date" },
                { key: "agencyName", label: "代理机构名称", type: "text" }
            ],
            "编制采购文件": [
                { key: "finishDate", label: "编制完成时间", type: "date" },
                { key: "controlPrice", label: "控制价/预算(元)", type: "number" },
                { key: "purchaseMode", label: "采购方式", type: "select", options: ["公开招标", "竞争性磋商", "单一来源", "询价"] }
            ],
            "意向公开": [
                { key: "publicDate", label: "挂网时间", type: "date" },
                { key: "link", label: "公告链接", type: "text" }
            ],
            "发布公告": [
                { key: "publishDate", label: "发布时间", type: "date" },
                { key: "openDate", label: "预计开标时间", type: "date" }
            ],
            "完成评标": [
                { key: "evalDate", label: "评标时间", type: "date" },
                { key: "evalLocation", label: "评标地点", type: "text" }
            ],
            "发布中标公示": [
                { key: "noticeDate", label: "公示发布时间", type: "date" },
                { key: "winner", label: "中标单位", type: "text" },
                { key: "winAmount", label: "中标金额(元)", type: "number" }
            ],
            "党组会": [
                { key: "meetDate", label: "会议时间", type: "date" },
                { key: "topic", label: "议题名称", type: "text" }
            ],
            "主任办公会": [
                { key: "meetDate", label: "会议时间", type: "date" },
                { key: "topic", label: "议题名称", type: "text" }
            ],
            "纸质请示": [
                { key: "approveDate", label: "批准时间", type: "date" }
            ],
            "付款": [
                { key: "submitFinanceDate", label: "提交财务日期", type: "date" },
                { key: "payAmount", label: "支付金额(元)", type: "number" },
                { key: "payType", label: "款项性质", type: "select", options: ["首笔款", "进度款", "尾款", "质保金"] }
            ],
            "开工备案": [
                { key: "submitDate", label: "备案时间", type: "date" },
                { key: "recordType", label: "备案类型", type: "select", options: ["监督站备案", "工程科备案"] }
            ],
            "设计交底": [
                { key: "meetDate", label: "交底时间", type: "date" }
            ],
            "施工入场": [
                { key: "entryDate", label: "进场日期", type: "date" }
            ],
            "竣工验收": [
                { key: "checkDate", label: "竣工验收日期", type: "date" }
            ],
            "结算审核": [
                { key: "finishAuditDate", label: "审定日期", type: "date" },
                { key: "finalAmount", label: "审定金额(元)", type: "number" },
                { key: "reduceAmount", label: "核减金额(元)", type: "number" }
            ],
            "资料归档": [
                { key: "archiveDate", label: "归档日期", type: "date" }
            ]
        };

        let GLOBAL_CONFIG = {}, currentProjectId = null, currentStageIndex = null, draggedItemIndex = null, draggedProjectIndex = null, configMode = 'global', tempLocalConfig = null, editingKey = null, dragSrcType = null;
        let viewYear = new Date().getFullYear();
        let viewMonth = new Date().getMonth();
        let selectedDateStr = null;

        const DB = { get: () => JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'), save: d => { localStorage.setItem(DB_KEY_DATA, JSON.stringify(d)); debouncedSync(); } };
        const DB_OT = { get: () => { const d = localStorage.getItem(DB_KEY_OT); return d ? JSON.parse(d) : { annual: 0, saved: 0, records: [], leaveRecords: [] } }, save: d => { localStorage.setItem(DB_KEY_OT, JSON.stringify(d)); debouncedSync(); } };
        const DB_TODO = { get: () => JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]'), save: d => { localStorage.setItem(DB_KEY_TODO, JSON.stringify(d)); debouncedSync(); } };
        const DB_CAL = { get: () => { const d = localStorage.getItem(DB_KEY_CAL); return d ? JSON.parse(d) : {} }, save: d => { localStorage.setItem(DB_KEY_CAL, JSON.stringify(d)); debouncedSync(); } };

        function loadConfig() {
            const local = JSON.parse(localStorage.getItem(DB_KEY_CONFIG)) || {};
            GLOBAL_CONFIG = { ...DEFAULT_CONFIG, ...local };
            Object.keys(DEFAULT_CONFIG).forEach(key => {
                if (!GLOBAL_CONFIG[key] || GLOBAL_CONFIG[key].length === 0) {
                    GLOBAL_CONFIG[key] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[key]));
                }
            });
        }
        function migrateData() { let list = DB.get(), ch = false; list.forEach(p => { p.stages.forEach(s => { if (!s.config) { s.config = JSON.parse(JSON.stringify(GLOBAL_CONFIG[s.name] || [])); ch = true } }) }); if (ch) DB.save(list); }

        window.onload = function () { initApp(); };

        function initHome() {
            const d = new Date();
            const days = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];
            document.getElementById('welcomeDate').innerText = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 · ${days[d.getDay()]}`;
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
            const ot = DB_OT.get();
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            (ot.leaveRecords || []).forEach(l => { if (l.type == '年假') usedAnnual += parseFloat(l.days); if (l.type == '存休') usedSaved += parseFloat(l.days); });
            (ot.records || []).forEach(r => { if (r.status != 'used') activeOt += parseFloat(r.days); });
            const total = (parseFloat(ot.annual || 0) - usedAnnual) + (parseFloat(ot.saved || 0) - usedSaved) + activeOt;
            document.getElementById('homeOtDays').innerText = total;
            renderTodos();
        }

        function renderCalendar(y, m) {
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const todayDate = new Date();
            const isCurrentMonth = (y === todayDate.getFullYear() && m === todayDate.getMonth());
            const today = todayDate.getDate();
            const logs = DB_CAL.get();
            document.getElementById('calMonth').innerText = `${y}年 ${m + 1}月`;
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '<div class="cal-day-name">日</div><div class="cal-day-name">一</div><div class="cal-day-name">二</div><div class="cal-day-name">三</div><div class="cal-day-name">四</div><div class="cal-day-name">五</div><div class="cal-day-name">六</div>';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let i = 1; i <= daysInMonth; i++) {
                const mStr = (m + 1).toString().padStart(2, '0');
                const dStr = i.toString().padStart(2, '0');
                const dateKey = `${y}-${mStr}-${dStr}`;
                let cls = 'cal-day';
                if (isCurrentMonth && i === today) cls += ' today';
                if (logs[dateKey]) cls += ' has-log';
                const div = document.createElement('div');
                div.className = cls;
                div.innerText = i;
                div.onclick = () => openDayLog(dateKey);
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderCalendar(viewYear, viewMonth);
        }

        function goToday() {
            const d = new Date();
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
        }

        function openDayLog(dateStr) {
            selectedDateStr = dateStr;
            document.getElementById('logDateTitle').innerText = dateStr;
            const logs = DB_CAL.get();
            document.getElementById('logContent').value = logs[dateStr] || '';
            openModal('dayLogModal');
        }

        function saveDayLog() {
            if (!selectedDateStr) return;
            const content = document.getElementById('logContent').value.trim();
            const logs = DB_CAL.get();
            if (content) { logs[selectedDateStr] = content; } else { delete logs[selectedDateStr]; }
            DB_CAL.save(logs);
            closeModal('dayLogModal');
            renderCalendar(viewYear, viewMonth);
        }

        // --- 🌟 V60: 待办逻辑升级 ---
        // 修改位置：Script 标签内，约第 838 行左右
        function renderTodos() {
            const list = DB_TODO.get();
            const container = document.getElementById('todoList');
            container.innerHTML = '';

            // 筛选未完成
            const activeTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => !t.done);

            // ❌ 删除：这里删除了 document.getElementById('historyCount').innerText... 这一行
            // 这样程序就不会因为找不到 ID 而崩掉了

            if (activeTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">🎉 太棒了，所有待办已清空！</div>';
                return;
            }

            activeTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.innerHTML = `<div class="todo-checkbox" onclick="toggleTodo(${t.originIdx})"></div><div class="todo-text">${t.text}</div><button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})"><svg viewBox="0 0 24 24"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                container.appendChild(div);
            });
        }

        function addTodo() {
            const val = document.getElementById('todoInput').value.trim();
            if (!val) return;
            const list = DB_TODO.get();
            list.unshift({ text: val, done: false, createDate: new Date().toISOString() });
            DB_TODO.save(list);
            document.getElementById('todoInput').value = '';
            renderTodos();
            initHome();
        }

        function toggleTodo(originIdx) {
            const list = DB_TODO.get();
            const item = list[originIdx];

            item.done = !item.done;

            // 🌟 核心修改：如果是“标记为完成”，则记录当前时间
            if (item.done) {
                const now = new Date();
                // 格式示例：2月7日 14:30
                const timeStr = `${now.getMonth() + 1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                item.completedAt = timeStr;
            } else {
                // 如果是“恢复未完成”，则清除时间
                delete item.completedAt;
            }

            DB_TODO.save(list);
            renderTodos();

            // 如果历史弹窗是打开的，立即刷新它以便看到变化
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function deleteTodo(originIdx) {
            if (!confirm("彻底删除？")) return;
            const list = DB_TODO.get();
            list.splice(originIdx, 1);
            DB_TODO.save(list);
            renderTodos();
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function openTodoHistory() {
            renderHistoryList();
            openModal('todoHistoryModal');
        }

        function renderHistoryList() {
            const list = DB_TODO.get();
            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';

            const doneTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => t.done);

            if (doneTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无归档记录</div>';
                return;
            }

            doneTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'history-item';
                // 🌟 核心修改：增加了下方的灰色时间显示行
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="text-decoration:line-through; color:#333; opacity:0.6; font-size:14px;">${t.text}</div>
                        <div style="font-size:11px; color:#bbb; margin-top:3px;">
                            🏁 完成于: ${t.completedAt || '早期记录'}
                        </div>
                    </div>
                    <button class="btn-restore" onclick="toggleTodo(${t.originIdx})">恢复</button>
                    <button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})">
                        <svg viewBox="0 0 24 24"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function getDeadline(dateStr) { if (!dateStr) return "未知"; const d = new Date(dateStr); const target = new Date(d.getFullYear(), d.getMonth() + 2, 0); return target.toISOString().split('T')[0]; }

        function renderOtPage() {
            const data = DB_OT.get();
            document.getElementById('inpAnnual').value = data.annual;
            document.getElementById('inpSaved').value = data.saved;
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            const lvContainer = document.getElementById('leaveListContainer');
            lvContainer.innerHTML = '';
            (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((l, idx) => {
                const days = parseFloat(l.days);
                let typeColor = '#999';
                if (l.type === '年假') { usedAnnual += days; typeColor = '#007AFF'; }
                if (l.type === '存休') { usedSaved += days; typeColor = '#AF52DE'; }
                const div = document.createElement('div');
                div.className = 'ot-list-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `<div style="flex:1;"><div style="font-weight:600"><span class="leave-type-tag" style="background:${typeColor}">${l.type || '休假'}</span>${l.date} <span style="color:#FF3B30">-${days}天</span></div><div style="font-size:12px;color:#999;margin-left:5px;">${l.note || '-'}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); delLeaveItem(${idx})"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                div.onclick = () => editLeave(idx);
                lvContainer.appendChild(div);
            });
            const otContainer = document.getElementById('otListContainer');
            otContainer.innerHTML = '';
            (data.records || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const div = document.createElement('div');
                div.className = `ot-card ${r.status === 'used' ? 'used' : ''}`;
                let actionHtml = '';
                let statusBadge = '';
                const trashIcon = `<button class="btn-delete-icon" onclick="delOtItem('${r.id}')" style="margin-left:0;"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                if (r.status === 'used') {
                    statusBadge = `<span class="ot-badge">已休</span>`;
                    actionHtml = `<div style="display:flex;justify-content:flex-end;align-items:center;margin-top:5px;"><span style="font-size:12px;margin-right:10px;">归档: ${r.usedDate}</span> ${trashIcon}</div>`;
                } else {
                    activeOt += parseFloat(r.days);
                    const deadline = getDeadline(r.date);
                    statusBadge = `<span class="ot-badge" style="background:#e3f2fd;color:#007AFF">待休</span>`;
                    actionHtml = `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><div class="ot-deadline">有效期至: ${deadline}</div><div style="display:flex;align-items:center;gap:5px;"><button class="btn-mini action" onclick="preUseOt('${r.id}')">✅ 休完</button>${trashIcon}</div></div>`;
                }
                div.innerHTML = `<div class="ot-card-header"><div class="ot-date">${r.date} <span style="font-size:14px;margin-left:5px;">+${r.days}天</span></div>${statusBadge}</div><div class="ot-desc">${r.note || '无备注'}</div>${actionHtml}`;
                otContainer.appendChild(div);
            });
            const remAnnual = parseFloat(data.annual || 0) - usedAnnual;
            const remSaved = parseFloat(data.saved || 0) - usedSaved;
            document.getElementById('dispAnnual').innerText = remAnnual;
            document.getElementById('dispSaved').innerText = remSaved;
            document.getElementById('dispOt').innerText = activeOt;
            document.getElementById('otTotalDays').innerText = remAnnual + remSaved + activeOt;
        }

        function saveBaseLeave() { const data = DB_OT.get(); data.annual = document.getElementById('inpAnnual').value || 0; data.saved = document.getElementById('inpSaved').value || 0; DB_OT.save(data); renderOtPage(); }
        function addOvertime() { const date = document.getElementById('otDate').value; const days = document.getElementById('otDays').value; if (!date || !days) return alert("请填写完整"); const data = DB_OT.get(); data.records.push({ id: Date.now().toString(), date, days, note: document.getElementById('otNote').value, status: 'active' }); DB_OT.save(data); closeModal('addOtModal'); renderOtPage(); }
        function preUseOt(id) { document.getElementById('useOtId').value = id; document.getElementById('useOtDate').value = new Date().toISOString().split('T')[0]; openModal('useOtModal'); }
        function confirmUseOt() { const id = document.getElementById('useOtId').value; const date = document.getElementById('useOtDate').value; if (!date) return alert("请填写日期"); const data = DB_OT.get(); const item = data.records.find(r => r.id === id); if (item) { item.status = 'used'; item.usedDate = date; DB_OT.save(data); closeModal('useOtModal'); renderOtPage(); } }
        function delOtItem(id) { if (confirm("删除此记录？")) { const data = DB_OT.get(); data.records = data.records.filter(r => r.id !== id); DB_OT.save(data); renderOtPage(); } }
        function openNewLeave() { document.getElementById('lvEditIndex').value = ''; document.getElementById('leaveModalTitle').innerText = '录入休假'; document.getElementById('lvType').value = '年假'; document.getElementById('lvDate').value = new Date().toISOString().split('T')[0]; document.getElementById('lvDays').value = ''; document.getElementById('lvNote').value = ''; document.getElementById('lvSaveBtn').innerText = '确认'; openModal('addLeaveModal'); }
        function editLeave(idx) {
            const data = DB_OT.get();
            const sorted = (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const record = sorted[idx];
            if (!record) return alert('记录不存在');
            document.getElementById('lvEditIndex').value = idx;
            document.getElementById('leaveModalTitle').innerText = '编辑休假';
            document.getElementById('lvType').value = record.type || '年假';
            document.getElementById('lvDate').value = record.date;
            document.getElementById('lvDays').value = record.days;
            document.getElementById('lvNote').value = record.note || '';
            document.getElementById('lvSaveBtn').innerText = '保存修改';
            openModal('addLeaveModal');
        }
        function saveLeaveRecord() {
            const editIdx = document.getElementById('lvEditIndex').value;
            const type = document.getElementById('lvType').value;
            const date = document.getElementById('lvDate').value;
            const days = document.getElementById('lvDays').value;
            if (!date || !days) return alert("请填写完整");
            const data = DB_OT.get();
            if (!data.leaveRecords) data.leaveRecords = [];
            if (editIdx === '') {
                data.leaveRecords.push({ type, date, days, note: document.getElementById('lvNote').value });
            } else {
                const sorted = data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                const record = sorted[parseInt(editIdx)];
                if (record) { record.type = type; record.date = date; record.days = days; record.note = document.getElementById('lvNote').value; }
            }
            DB_OT.save(data);
            closeModal('addLeaveModal');
            renderOtPage();
        }
        function delLeaveItem(idx) { if (confirm("删除此休假记录？将恢复对应的额度。")) { const data = DB_OT.get(); data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date)); data.leaveRecords.splice(idx, 1); DB_OT.save(data); renderOtPage(); } }

        function openConfigModal(mode, stageIndex = null) {
            configMode = mode;
            if (mode === 'global') { renderConfigContainer(); } else {
                currentStageIndex = stageIndex;
                const p = DB.get().find(x => x.id === currentProjectId);
                const stage = p.stages[stageIndex];
                tempLocalConfig = JSON.parse(JSON.stringify(stage.config));
                editingKey = 'LOCAL_EDIT';
                document.getElementById('configModalTitle').innerText = '配置：' + stage.name;
                renderConfigFields(tempLocalConfig);
            }
            openModal('configModal');
        }

        function renderConfigContainer() {
            const container = document.getElementById('configContainer');
            container.innerHTML = '';
            Object.keys(NODE_CATEGORIES).forEach(cat => {
                const catTitle = document.createElement('div');
                catTitle.className = 'config-category-title';
                catTitle.innerText = cat;
                container.appendChild(catTitle);
                const grid = document.createElement('div');
                grid.className = 'config-node-grid';
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const nodeBtn = document.createElement('div');
                    nodeBtn.className = 'config-node-item';
                    nodeBtn.innerText = nodeName;
                    nodeBtn.onclick = () => openNodeDetailEditor(nodeName);
                    grid.appendChild(nodeBtn);
                });
                container.appendChild(grid);
            });
        }

        let currentEditingNodeName = null;
        function openNodeDetailEditor(nodeName) {
            currentEditingNodeName = nodeName;
            if (!GLOBAL_CONFIG[nodeName]) {
                GLOBAL_CONFIG[nodeName] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[nodeName] || []));
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            }
            const config = GLOBAL_CONFIG[nodeName] || [];
            const modal = document.getElementById('nodeDetailModal');
            document.getElementById('nodeDetailTitle').innerText = nodeName;
            const fieldList = document.getElementById('nodeFieldList');
            fieldList.innerHTML = '';
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) {
                    optionsStr = `<br><span class="node-field-type">选项: ${field.options.join(', ')}</span>`;
                }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">字段: ${field.key} | 类型: ${field.type}${optionsStr}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); deleteConfigField('${nodeName}', ${idx})"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                fieldList.appendChild(item);
            });
            modal.classList.add('open');
        }

        function closeNodeDetailEditor() {
            document.getElementById('nodeDetailModal').classList.remove('open');
            currentEditingNodeName = null;
        }

        function saveNodeDetailEditor() {
            loadConfig();
            DB.get();
            debouncedSync();
            closeNodeDetailEditor();
            showToast('✅ 配置已保存');
        }

        function deleteConfigField(nodeName, fieldIdx) {
            if (confirm('确定删除此字段吗？')) {
                if (GLOBAL_CONFIG[nodeName]) {
                    GLOBAL_CONFIG[nodeName].splice(fieldIdx, 1);
                    localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                    openNodeDetailEditor(nodeName);
                    debouncedSync();
                }
            }
        }

        function addNewConfigField() {
            const fieldLabel = prompt('请输入字段名称 (例如: 实际开工时间):');
            if (!fieldLabel) return;
            const fieldKey = 'custom_' + Date.now();
            const typeInput = prompt('请输入字段类型编号:\n1 - 日期 (Date)\n2 - 金额/数字 (Number)\n3 - 文字 (Text)\n4 - 下拉选项 (Select)', '1');
            let fieldType = 'text';
            let options = [];
            if (typeInput === '1') fieldType = 'date';
            else if (typeInput === '2') fieldType = 'number';
            else if (typeInput === '3') fieldType = 'text';
            else if (typeInput === '4') {
                fieldType = 'select';
                const optStr = prompt('请输入选项，用逗号隔开:', '合格,不合格');
                if (optStr) options = optStr.split(/[,，]/).map(s => s.trim());
            } else { return; }
            if (!GLOBAL_CONFIG[currentEditingNodeName]) { GLOBAL_CONFIG[currentEditingNodeName] = []; }
            GLOBAL_CONFIG[currentEditingNodeName].push({ key: fieldKey, label: fieldLabel, type: fieldType, options: options });
            localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            openNodeDetailEditor(currentEditingNodeName);
            debouncedSync();
        }

        function renderConfigFields(config) {
            const fieldList = document.getElementById('nodeFieldList');
            if (!fieldList) return;
            fieldList.innerHTML = '';
            if (!config || config.length === 0) { fieldList.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">该节点暂无配置</div>'; return; }
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) { optionsStr = `<br><span class="node-field-type">选项: ${field.options.join(', ')}</span>`; }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">字段: ${field.key} | 类型: ${field.type}${optionsStr}</div></div>`;
                fieldList.appendChild(item);
            });
        }

        function handleConfigSave() {
            if (configMode === 'global') {
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                debouncedSync();
                alert('✅ 全局配置已保存');
                closeModal('configModal');
            } else if (configMode === 'local') {
                const list = DB.get();
                const p = list.find(x => x.id === currentProjectId);
                if (p && p.stages[currentStageIndex]) {
                    p.stages[currentStageIndex].config = tempLocalConfig;
                    DB.save(list);
                    alert('✅ 节点配置已保存');
                    closeModal('configModal');
                    refreshDetail(p);
                }
            }
        }

        function createProject() { const n = document.getElementById('newProjectName').value; if (!n) return alert("请输入名称"); DB.save([{ id: Date.now(), name: n, type: document.getElementById('newProjectType').value, createDate: new Date().toLocaleDateString(), stages: [] }, ...DB.get()]); closeModal('createModal'); goToPage('projectList'); }
        function openNodeLibrary() {
            const container = document.getElementById('nodeLibraryGrid');
            container.innerHTML = '';
            Object.keys(NODE_CATEGORIES).forEach(cat => {
                const header = document.createElement('div');
                header.style.cssText = "grid-column: 1 / -1; font-size: 13px; font-weight: bold; color: #888; margin: 15px 0 5px 0; padding-left: 5px; border-left: 3px solid var(--primary);";
                header.innerText = cat;
                container.appendChild(header);
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const btn = document.createElement('div');
                    btn.className = 'node-option';
                    btn.innerText = '+ ' + nodeName;
                    btn.onclick = () => addStage(nodeName);
                    container.appendChild(btn);
                });
            });
            openModal('nodeLibraryModal');
        }

        function addStage(nodeName) {
            if (!currentProjectId) return alert('请先在工程详情页打开要添加节点的工程。');
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('未找到当前工程');
            const sourceCfg = (typeof GLOBAL_CONFIG === 'object' && GLOBAL_CONFIG[nodeName]) ? GLOBAL_CONFIG[nodeName] : (DEFAULT_CONFIG[nodeName] || []);
            const cfg = JSON.parse(JSON.stringify(sourceCfg));
            const newStage = { name: nodeName, status: 'waiting', config: cfg, data: {} };
            p.stages.push(newStage);
            DB.save(list);
            closeModal('nodeLibraryModal');
            refreshDetail(p);
        }

        function openDetail(id) { currentProjectId = id; const p = DB.get().find(x => x.id == id); document.getElementById('detailTitle').innerText = p.name; document.getElementById('detailType').innerText = { 'special': '专项工程', 'odd': '零星工程', 'repair': '抢修工程' }[p.type]; goToPage('projectDetail'); refreshDetail(p); }

        function refreshDetail(p) {
            const c = document.getElementById('stagesContainer'); c.innerHTML = '';
            const prev = document.getElementById('previewFlow'); prev.innerHTML = '';
            p.stages.forEach((s, i) => {
                const conf = s.config || [];
                const getDisplayHtml = (mode) => {
                    return conf.map(f => {
                        if (!s.data[f.key]) return '';
                        let displayVal = s.data[f.key];
                        if (f.type === 'number') displayVal = '¥' + displayVal;
                        if (mode === 'preview') return `<div class="preview-kv"><span class="preview-k">${f.label}:</span><span class="preview-v">${displayVal}</span></div>`;
                        return `<div class="data-item"><span class="data-label">${f.label}</span><span class="data-value">${displayVal}</span></div>`;
                    }).join('');
                };
                if (s.status === 'done') { prev.innerHTML += `<div class="preview-item done"><div class="preview-item-title"><span>${s.name}</span></div><div class="preview-data-table">${getDisplayHtml('preview')}</div></div>`; }
                let det = ''; if (s.status !== 'waiting') { det = '<div class="data-grid">' + getDisplayHtml('card') + '</div>'; }
                const ico = s.status === 'done' ? '✅' : (s.status === 'processing' ? '🔥' : '⏳');
                c.innerHTML += `<div class="stage-card ${s.status}"><div class="node-sort-zone"><button class="node-sort-btn" onclick="moveStageUp(${i})">↑</button><button class="node-sort-btn" onclick="moveStageDown(${i})">↓</button></div><div class="card-content" onclick="openStageEdit(${i})"><div class="card-actions-fixed"><button class="icon-btn-card btn-edit-struct" onclick="event.stopPropagation();openConfigModal('local', ${i})">⚙️</button><button class="btn-delete-icon" style="margin-left:0;" onclick="event.stopPropagation();deleteStage(${i})"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="status-bar ${s.status}"></div><div class="card-header-row"><span class="card-title">${s.name}</span><span class="card-status-text">${ico}</span></div>${det}</div></div>`;
            });
        }

        function moveStageUp(i) {
            if (i === 0) return;
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            const temp = p.stages[i]; p.stages[i] = p.stages[i - 1]; p.stages[i - 1] = temp;
            DB.save(list); refreshDetail(p);
        }
        function moveStageDown(i) {
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            if (i === p.stages.length - 1) return;
            const temp = p.stages[i]; p.stages[i] = p.stages[i + 1]; p.stages[i + 1] = temp;
            DB.save(list); refreshDetail(p);
        }

        function openStageEdit(i) {
            if (!currentProjectId) return alert('请先打开工程详情再编辑节点');
            currentStageIndex = i;
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('未找到工程');
            const stage = p.stages[i];
            document.getElementById('formTitle').innerText = `${stage.name} — 录入`;
            const container = document.getElementById('dynamicFormContainer');
            container.innerHTML = '';
            const cfg = stage.config || [];
            if (!cfg.length) { container.innerHTML = '<div style="color:#666;font-size:13px">该节点无可录入字段。</div>'; openModal('dynamicFormModal'); return; }
            cfg.forEach(f => {
                const wrap = document.createElement('div');
                wrap.style.marginBottom = '10px';
                const lbl = document.createElement('div');
                lbl.style.fontSize = '13px'; lbl.style.marginBottom = '4px'; lbl.innerText = f.label;
                wrap.appendChild(lbl);
                let inputEl;
                const curVal = (stage.data && stage.data[f.key]) ? stage.data[f.key] : '';
                if (f.type === 'select') {
                    inputEl = document.createElement('select');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    (f.options || []).forEach(opt => { const o = document.createElement('option'); o.value = opt; o.innerText = opt; if (opt === curVal) o.selected = true; inputEl.appendChild(o); });
                } else {
                    inputEl = document.createElement('input');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    if (f.type === 'date') { inputEl.type = 'date'; inputEl.max = '2099-12-31'; inputEl.oninput = function () { if (this.value.length > 10) this.value = this.value.slice(0, 10); }; }
                    else if (f.type === 'number') inputEl.type = 'number';
                    else inputEl.type = 'text';
                    inputEl.value = curVal;
                }
                wrap.appendChild(inputEl);
                container.appendChild(wrap);
            });
            openModal('dynamicFormModal');
        }

        function editProjectName() { const p = DB.get().find(x => x.id === currentProjectId); const newName = prompt("修改工程名称:", p.name); if (newName && newName !== p.name) { const list = DB.get(); list.find(x => x.id === currentProjectId).name = newName; DB.save(list); document.getElementById('detailTitle').innerText = newName; } }

        function saveDynamicData() {
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            const stage = p.stages[currentStageIndex];
            let nd = {}; let full = true;
            stage.config.forEach(f => {
                const el = document.getElementById(`f_${f.key}`);
                if (el) { nd[f.key] = el.value; if (el.value === '') full = false; }
            });
            stage.data = { ...stage.data, ...nd };
            stage.status = Object.values(nd).some(v => v) ? (full ? 'done' : 'processing') : 'waiting';
            DB.save(list); closeModal('dynamicFormModal'); refreshDetail(p);
        }
        function deleteStage(i) { if (confirm("删节点？")) { const l = DB.get(); const p = l.find(x => x.id == currentProjectId); p.stages.splice(i, 1); DB.save(l); refreshDetail(p); } }

        function renderProjects() {
            const list = DB.get();
            const cs = document.getElementById('container_special');
            const co = document.getElementById('container_odd');
            const cr = document.getElementById('container_repair');
            cs.innerHTML = ''; co.innerHTML = ''; cr.innerHTML = '';
            let c1 = 0, c2 = 0, c3 = 0;
            list.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div class="list-item-content" onclick="openDetail(${p.id})"><div style="display:flex; flex-direction:column; overflow:hidden;"><div class="list-item-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.name}</div><div class="list-item-date">${p.createDate}</div></div><button class="btn-delete-icon" onclick="deleteProject(event, ${p.id})"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="list-sort-zone"><button class="sort-btn up" onclick="moveProjUp(${i}, '${p.type}')">↑</button><button class="sort-btn down" onclick="moveProjDown(${i}, '${p.type}')">↓</button></div>`;
                if (p.type === 'special') { cs.appendChild(d); c1++; } else if (p.type === 'odd') { co.appendChild(d); c2++; } else { cr.appendChild(d); c3++; }
            });
            document.getElementById('c_s').innerText = c1; document.getElementById('c_o').innerText = c2; document.getElementById('c_r').innerText = c3;
        }

        function deleteProject(e, id) {
            e.stopPropagation();
            if (confirm('⚠️ 确定要彻底删除这个工程吗？\n删除后无法恢复！')) {
                let list = DB.get(); list = list.filter(p => p.id !== id);
                DB.save(list); renderProjects();
            }
        }
        function moveProjUp(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i - 1; k >= 0; k--) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }
        function moveProjDown(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i + 1; k < list.length; k++) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }

        function exportData() { const d = { v: "44.0", d: new Date(), p: DB.get(), c: GLOBAL_CONFIG, ot: DB_OT.get(), todo: DB_TODO.get(), cal: DB_CAL.get() }; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], { type: "json" })); a.download = `backup_${Date.now()}.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importData(i) {
            if (!i.files || !i.files[0]) return alert("❌ 没选文件！");
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    alert("🔍 正在解析并去重...");
                    const b = JSON.parse(e.target.result);
                    const impP = b.p || b.projects || []; const impConf = b.c || b.config || {}; const impOt = b.ot || b.attendance || {}; const impTodo = b.todo || []; const impCal = b.cal || b.calendar || {};
                    const currP = JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]');
                    const currConf = JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}');
                    const currOt = JSON.parse(localStorage.getItem(DB_KEY_OT) || '{"records":[], "leaveRecords":[]}');
                    const projectMap = new Map(); currP.forEach(p => projectMap.set(p.id, p)); impP.forEach(p => projectMap.set(p.id, p));
                    const mergedProjects = Array.from(projectMap.values());
                    const mergedOt = { annual: currOt.annual || impOt.annual, saved: currOt.saved || impOt.saved, records: [...(currOt.records || []), ...(impOt.records || [])], leaveRecords: [...(currOt.leaveRecords || []), ...(impOt.leaveRecords || [])] };
                    const mergedTodo = [...(JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]')), ...impTodo];
                    const mergedCal = { ...impCal, ...JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}') };
                    const mergedConfig = { ...impConf, ...currConf };
                    localStorage.setItem(DB_KEY_DATA, JSON.stringify(mergedProjects)); localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(mergedConfig)); localStorage.setItem(DB_KEY_OT, JSON.stringify(mergedOt)); localStorage.setItem(DB_KEY_TODO, JSON.stringify(mergedTodo)); localStorage.setItem(DB_KEY_CAL, JSON.stringify(mergedCal));
                    if (currentUser) {
                        const payload = { projects: mergedProjects, config: mergedConfig, attendance: mergedOt, todo: mergedTodo, calendar: mergedCal, updated_at: new Date().toISOString() };
                        await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                    }
                    alert(`✅ 导入完成！`); location.reload();
                } catch (err) { alert("💥 出错: " + err.message); }
            };
            r.readAsText(i.files[0]); i.value = '';
        }

        function calcDateDiff() {
            const d1 = document.getElementById('toolStartDate').value;
            const d2 = document.getElementById('toolEndDate').value;
            const resBox = document.getElementById('dateResult');
            if (!d1 || !d2) { alert("请先选择两个日期！"); return; }
            const diffTime = Math.abs(new Date(d2) - new Date(d1));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            resBox.style.display = 'block'; resBox.innerText = `相差 ${diffDays} 天`;
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    </script>
</body>

</html>