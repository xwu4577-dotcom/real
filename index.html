<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ä½œåŠ©æ‰‹</title>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

        <title>å·¥ä½œåŠ©æ‰‹</title>

        <link rel="preload" href="icon.png" as="image">

        <meta name="theme-color" content="#ffffff">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="å·¥ä½œåŠ©æ‰‹">

        <link rel="manifest" href="manifest.json">
        <link rel="apple-touch-icon" href="icon.png?v=3">
        <link rel="icon" type="image/png" href="icon.png?v=3">

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <style>
            /* --- åŸºç¡€å˜é‡ --- */
            :root {
                --primary: #007AFF;
                --bg: #F5F7FA;
                --white: #FFFFFF;
                --green: #34C759;
                --orange: #FF9500;
                --purple: #5856D6;
                --text: #333;
                --border: #E5E5EA;
                --red: #FF3B30;
                --gray: #8E8E93;
            }

            /* æ ¸å¿ƒå¸ƒå±€ */

            /* ğŸ‘‡ 1. æ›¿æ¢ body æ ·å¼ï¼šåŠ ä¸Š html æ ‡ç­¾ï¼Œå½»åº•é”æ­»æ©¡çš®ç­‹æ•ˆæœ */
            html,
            body {
                width: 100%;
                height: 100%;
                overflow: hidden;
                /* ğŸ’€ å…³é”®ï¼šç¦æ­¢æ•´ä¸ªæµè§ˆå™¨çª—å£æ»šåŠ¨ */
                margin: 0;
                padding: 0;
                position: fixed;
                /* ğŸ’€ å…³é”®ï¼šåƒé’‰å­ä¸€æ ·é’‰åœ¨å±å¹•ä¸Š */
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: var(--bg);
                color: var(--text);
                display: flex;
                flex-direction: column;
                /* å‚ç›´å¸ƒå±€ */
                -webkit-tap-highlight-color: transparent;
            }

            * {
                box-sizing: border-box;
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* ğŸ‘‡ 2. æ›¿æ¢å¯¼èˆªæ æ ·å¼ï¼šé˜²æ­¢è¢«æŒ¤å‹ */
            .navbar-common {
                background: var(--white);
                color: var(--text);
                height: 44px;
                /* ğŸ”’ é«˜åº¦å†™æ­» */
                min-height: 44px;
                /* ğŸ”’ æœ€å°é«˜åº¦å†™æ­» */
                padding: 0 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);

                flex-shrink: 0;
                /* ğŸ’€ å…³é”®ï¼šç¦æ­¢è¢«å†…å®¹æŒ¤æ‰ */
                position: relative;
                z-index: 999;
                /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
                width: 100%;
            }

            .nav-left {
                display: flex;
                align-items: center;
                gap: 0;
                height: 100%;
                flex: 1;
                min-width: 0;
            }

            .nav-right {
                display: flex;
                align-items: center;
                gap: 10px;
                height: 100%;
            }

            /* è¿”å›æŒ‰é’® (iOSé£æ ¼) */
            .nav-back-btn {
                background: transparent;
                border: none;
                color: var(--primary);
                font-size: 17px;
                font-weight: 400;
                padding: 0;
                margin: 0;
                margin-right: 2px;
                cursor: pointer;
                display: flex;
                align-items: center;
                height: 100%;
            }

            .nav-back-btn svg {
                width: 26px;
                height: 26px;
                fill: none;
                stroke: currentColor;
                stroke-width: 2.5;
                stroke-linecap: round;
                stroke-linejoin: round;
                margin-left: -8px;
                margin-top: -1px;
            }

            .nav-back-btn:active {
                opacity: 0.5;
            }

            /* é¡µé¢æ ‡é¢˜ */
            .page-title {
                font-size: 17px;
                font-weight: 700;
                color: #000;
                margin: 0;
                line-height: 44px;
                margin-left: -4px;
                /* å¾®è°ƒä¸ç®­å¤´çš„è·ç¦» */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* è¯¦æƒ…é¡µä¸“ç”¨æ ‡é¢˜æ¡† (å‚ç›´å±…ä¸­) */
            .detail-header-center {
                position: absolute;
                left: 80px;
                right: 80px;
                top: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                pointer-events: none;
                /* é˜²æ­¢é®æŒ¡ç‚¹å‡» */
            }

            .detail-title-row {
                display: flex;
                align-items: center;
                pointer-events: auto;
            }

            .detail-main-title {
                font-size: 17px;
                font-weight: 600;
                color: #000;
                line-height: 1.2;
            }

            .detail-sub-title {
                font-size: 10px;
                color: #999;
                margin-top: 1px;
                line-height: 1;
            }

            /* é…ç½®æŒ‰é’® */
            /* ğŸŒŸ æ›¿æ¢ï¼šé…ç½®æŒ‰é’® & å³ä¾§é€šç”¨æŒ‰é’®æ ·å¼ */
            .nav-btn-right {
                background: transparent;
                border: none;
                color: var(--primary);
                padding: 0 10px 0 0;
                font-size: 16px;
                cursor: pointer;
                font-weight: 400;
                display: flex;
                align-items: center;
                gap: 4px;
                height: 100%;
            }

            /* å…¼å®¹æ—§IDï¼Œé˜²æ­¢JSæŠ¥é”™ */
            #nodeConfigBtn {
                display: none;
            }

            /* ğŸ‘‡ 3. æ›¿æ¢å†…å®¹å®¹å™¨æ ·å¼ï¼šåªæœ‰è¿™é‡Œèƒ½æ»šåŠ¨ */
            .page-container {
                flex: 1;
                /* éœ¸å å‰©ä½™æ‰€æœ‰ç©ºé—´ */
                overflow-y: auto;
                /* å…è®¸å†…éƒ¨ä¸Šä¸‹æ»šåŠ¨ */
                overflow-x: hidden;
                width: 100%;
                padding: 15px;
                padding-bottom: 80px;
                position: relative;

                /* iOS ä¸æ»‘æ»šåŠ¨ä½“éªŒ */
                -webkit-overflow-scrolling: touch;
            }

            .page {
                display: none;
            }

            .page.active {
                display: block;
                animation: fadeIn 0.2s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* --- ä¸šåŠ¡æ ·å¼ (ä¿æŒä¸å˜) --- */
            .segmented-control {
                display: flex;
                background: #eeeff1;
                border-radius: 9px;
                padding: 2px;
                margin-bottom: 15px;
            }

            .segment-btn {
                flex: 1;
                border: none;
                background: transparent;
                padding: 6px 0;
                font-size: 13px;
                font-weight: 500;
                border-radius: 7px;
                color: #666;
                cursor: pointer;
                transition: all 0.2s;
            }

            .segment-btn.active {
                background: #fff;
                color: #000;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                font-weight: 600;
            }

            .service-card {
                background: white;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                position: relative;
                border-left: 4px solid var(--purple);
            }

            .service-type-tag {
                font-size: 11px;
                background: #f3e5f5;
                color: var(--purple);
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: bold;
                display: inline-block;
                margin-bottom: 5px;
            }

            .service-name {
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 5px;
                color: #333;
            }

            .service-row {
                display: flex;
                justify-content: space-between;
                font-size: 13px;
                color: #666;
                margin-top: 4px;
            }

            .progress-bg {
                height: 6px;
                background: #eee;
                border-radius: 3px;
                margin-top: 8px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: var(--green);
                width: 0%;
                border-radius: 3px;
            }

            /* å…¶ä½™æ ·å¼ (å¾…åŠã€æ—¥å†ã€è¾“å…¥æ¡†ç­‰) */
            .fab-add {
                position: fixed;
                bottom: 30px;
                right: 20px;
                width: 56px;
                height: 56px;
                background-color: var(--primary);
                color: white;
                border-radius: 50%;
                border: none;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
                font-size: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 900;
                transition: transform 0.1s;
            }

            .fab-add:active {
                transform: scale(0.95);
                background-color: #0056b3;
            }

            .asset-card-row {
                display: flex;
                flex-direction: column;
                margin-bottom: 20px;
            }

            .asset-card {
                width: 100%;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2);
                position: relative;
                overflow: hidden;
                cursor: pointer;
                transition: transform 0.1s;
                box-sizing: border-box;
            }

            .asset-card.blue {
                background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
                color: white;
            }

            .asset-label {
                font-size: 12px;
                opacity: 0.8;
                margin-bottom: 5px;
            }

            .asset-value {
                font-size: 28px;
                font-weight: 800;
                line-height: 1.1;
            }

            .calendar-section {
                background: white;
                border-radius: 16px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }

            .cal-header {
                font-weight: bold;
                margin-bottom: 10px;
                font-size: 15px;
                display: flex;
                justify-content: space-between;
            }

            .cal-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
                text-align: center;
            }

            .cal-day {
                font-size: 13px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                color: #333;
                position: relative;
            }

            .cal-day.today {
                background: var(--primary);
                color: white;
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(0, 122, 255, 0.4);
            }

            .cal-day.has-log::after {
                content: '';
                width: 4px;
                height: 4px;
                background: var(--red);
                border-radius: 50%;
                position: absolute;
                bottom: 4px;
            }

            .todo-section {
                margin-bottom: 30px;
            }

            .todo-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .btn-history {
                background: rgba(0, 0, 0, 0.05);
                color: var(--primary);
                padding: 6px 12px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 600;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .todo-input-row {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .todo-input {
                flex: 1;
                border: none;
                background: #fff;
                padding: 12px 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                font-size: 14px;
            }

            .todo-add-btn {
                background: var(--text);
                color: white;
                border: none;
                width: 44px;
                border-radius: 10px;
                font-size: 20px;
                cursor: pointer;
            }

            .todo-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .todo-item {
                background: white;
                padding: 14px 16px;
                border-radius: 12px;
                display: flex;
                align-items: flex-start;
                gap: 12px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
                transition: all 0.2s ease;
                position: relative;
            }

            .todo-checkbox {
                width: 22px;
                height: 22px;
                border-radius: 50%;
                border: 2px solid #ddd;
                cursor: pointer;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .todo-text {
                font-size: 15px;
                line-height: 1.4;
                color: #333;
                flex: 1;
                word-break: break-all;
            }

            .empty-state {
                text-align: center;
                color: #999;
                font-size: 13px;
                padding: 20px 0;
                font-style: italic;
                opacity: 0.6;
            }

            .history-list {
                max-height: 60vh;
                overflow-y: auto;
            }

            .history-item {
                padding: 12px 0;
                border-bottom: 1px solid #eee;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .history-time {
                font-size: 11px;
                color: #bbb;
                margin-top: 2px;
            }

            .btn-restore {
                font-size: 12px;
                color: var(--primary);
                border: 1px solid var(--primary);
                padding: 4px 8px;
                border-radius: 6px;
                background: none;
                cursor: pointer;
            }

            .project-entry-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
                margin-bottom: 30px;
            }

            .entry-card {
                background: white;
                border-radius: 16px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                cursor: pointer;
                border: 1px solid transparent;
                transition: all 0.1s;
            }

            .entry-card.eng {
                border-bottom: 4px solid var(--primary);
            }

            .entry-card.non-eng {
                border-bottom: 4px solid var(--purple);
            }

            .entry-card.tools {
                border-bottom: 4px solid var(--orange);
            }

            .entry-icon {
                font-size: 32px;
                margin-bottom: 10px;
                display: block;
            }

            .entry-title {
                font-weight: 700;
                font-size: 15px;
                color: #333;
                display: block;
            }

            .footer-tools {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-bottom: 40px;
            }

            .tool-btn {
                font-size: 12px;
                color: #999;
                padding: 8px 15px;
                background: rgba(0, 0, 0, 0.03);
                border-radius: 20px;
                cursor: pointer;
            }

            .ot-summary-card {
                background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
                color: white;
                padding: 25px;
                border-radius: 15px;
                text-align: center;
                margin-bottom: 15px;
            }

            .ot-big-num {
                font-size: 48px;
                font-weight: bold;
                margin: 10px 0;
            }

            .ot-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
                margin-top: 15px;
                background: rgba(255, 255, 255, 0.15);
                padding: 10px;
                border-radius: 10px;
            }

            .ot-label {
                font-size: 12px;
                opacity: 0.9;
            }

            .ot-val {
                font-size: 16px;
                font-weight: bold;
            }

            .ot-settings-mini {
                background: #fff;
                padding: 10px 15px;
                border-radius: 10px;
                display: flex;
                gap: 15px;
                align-items: center;
                font-size: 13px;
                color: #666;
                margin-bottom: 20px;
                border: 1px solid #eee;
            }

            .ot-input-mini {
                width: 60px;
                padding: 4px;
                border: 1px solid #ddd;
                border-radius: 4px;
                text-align: center;
                font-weight: bold;
                color: var(--primary);
            }

            .ot-card {
                background: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                border-left: 4px solid var(--green);
                position: relative;
            }

            .ot-card.used {
                border-left-color: #ccc;
                background: #f9f9f9;
                color: #999;
            }

            .ot-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 5px;
            }

            .ot-date {
                font-weight: bold;
                font-size: 16px;
            }

            .ot-badge {
                background: #e8f5e9;
                color: var(--green);
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
            }

            .ot-card.used .ot-badge {
                background: #eee;
                color: #999;
            }

            .ot-desc {
                font-size: 13px;
                color: #666;
                margin-bottom: 5px;
            }

            .ot-deadline {
                font-size: 12px;
                color: var(--orange);
                margin-top: 5px;
                font-weight: 500;
            }

            .ot-list-item {
                background: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .leave-type-tag {
                font-size: 12px;
                padding: 2px 6px;
                border-radius: 4px;
                margin-right: 5px;
                color: white;
            }

            .list-item {
                background: white;
                padding: 0;
                margin-bottom: 10px;
                border-radius: 10px;
                display: flex;
                align-items: stretch;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                overflow: hidden;
            }

            .list-item-content {
                flex: 1;
                padding: 12px 15px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .list-sort-zone {
                width: 32px;
                background: #fcfcfc;
                border-left: 1px solid #f0f0f0;
                display: flex;
                flex-direction: column;
            }

            .sort-btn {
                flex: 1;
                border: none;
                background: transparent;
                color: #ccc;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: color 0.2s;
            }

            .sort-btn:active {
                color: var(--primary);
                background: #e0e0e0;
            }

            .sort-btn.up {
                border-bottom: 1px solid #eee;
            }

            .list-item-title {
                font-weight: 600;
                font-size: 15px;
                margin-bottom: 4px;
                color: #333;
            }

            .list-item-date {
                font-size: 12px;
                color: #999;
            }

            .project-section-header {
                font-size: 14px;
                font-weight: bold;
                color: #555;
                margin: 15px 0 10px;
                padding-left: 10px;
                border-left: 4px solid var(--primary);
                display: flex;
                justify-content: space-between;
            }

            .home-section-title {
                font-size: 14px;
                font-weight: bold;
                color: #666;
                margin: 25px 0 10px 5px;
                border-left: 3px solid var(--primary);
                padding-left: 8px;
            }

            .stage-card {
                background: white;
                margin-bottom: 15px;
                border-radius: 10px;
                position: relative;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                display: flex;
                overflow: hidden;
            }

            .card-content {
                flex: 1;
                padding: 12px 15px;
                position: relative;
                min-width: 0;
            }

            .status-bar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
            }

            .status-bar.done {
                background: var(--green);
            }

            .status-bar.processing {
                background: var(--orange);
            }

            .status-bar.waiting {
                background: #ddd;
            }

            .card-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding-right: 70px;
            }

            .card-title {
                font-weight: bold;
                font-size: 15px;
                color: #333;
            }

            .card-status-text {
                font-size: 12px;
                color: #999;
            }

            .card-actions-fixed {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 8px;
                z-index: 5;
            }

            .icon-btn-card {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                background: #f2f2f7;
                color: #555;
            }

            .data-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 6px;
                background: #f9f9f9;
                padding: 8px;
                border-radius: 6px;
                font-size: 13px;
            }

            .data-item {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px dashed #eee;
                padding-bottom: 4px;
            }

            .data-label {
                color: #888;
            }

            .data-value {
                font-weight: 500;
                color: #333;
                text-align: right;
            }

            .preview-section {
                background: white;
                border-radius: 10px;
                padding: 12px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .preview-item.done {
                background: #f0fdf4;
                border-color: #bbf7d0;
                color: #333;
                padding: 8px 10px;
                border-radius: 6px;
                border: 1px solid #eee;
                margin-bottom: 8px;
                font-size: 12px;
            }

            .preview-data-table {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 4px 8px;
                margin-top: 5px;
            }

            .preview-kv {
                display: flex;
                align-items: center;
            }

            .preview-k {
                color: #666;
                margin-right: 6px;
                white-space: nowrap;
            }

            .btn-add-node {
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px 40px;
                border-radius: 30px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                width: 80%;
            }

            .back-btn-float {
                padding: 5px 12px;
                background: #e3f2fd;
                border-radius: 15px;
                color: var(--primary);
                font-size: 13px;
                border: 1px solid rgba(0, 122, 255, 0.1);
                cursor: pointer;
                font-weight: 500;
            }

            .btn-mini {
                padding: 4px 10px;
                border-radius: 15px;
                border: 1px solid #ddd;
                background: white;
                font-size: 12px;
                cursor: pointer;
                color: #555;
            }

            .btn-mini.action {
                border-color: var(--primary);
                color: var(--primary);
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                align-items: center;
                justify-content: center;
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .modal.open {
                display: flex;
            }

            .modal-content {
                background: white;
                width: 85%;
                max-width: 450px;
                padding: 25px 20px;
                border-radius: 15px;
                max-height: 80vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .form-label {
                display: block;
                font-size: 14px;
                font-weight: bold;
                margin: 12px 0 6px;
                color: #444;
            }

            .input-box {
                width: 100%;
                height: 46px;
                padding: 0 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 15px;
                background: #fafafa;
                color: #333;
                -webkit-appearance: none;
                appearance: none;
                margin: 0;
                display: block;
            }

            select.input-box {
                background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 10px;
                padding-right: 30px;
            }

            input[type="date"].input-box {
                display: flex;
                align-items: center;
                line-height: 46px;
            }

            .log-textarea {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-sizing: border-box;
                font-size: 15px;
                background: #fafafa;
                min-height: 100px;
                resize: vertical;
            }

            .btn-primary {
                width: 100%;
                padding: 14px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                margin-top: 25px;
                cursor: pointer;
                font-weight: 600;
            }

            .btn-cancel {
                width: 100%;
                margin-top: 10px;
                border: none;
                background: transparent;
                color: #999;
                cursor: pointer;
                padding: 10px;
                font-size: 14px;
            }

            .config-container {
                display: flex;
                flex-direction: column;
                max-height: 70vh;
                overflow-y: auto;
                margin-top: 10px;
            }

            .config-category-title {
                background: #f5f5f7;
                border-left: 4px solid var(--primary);
                padding: 12px 15px;
                font-size: 14px;
                font-weight: bold;
                color: #333;
                margin: 15px 0 10px 0;
                width: 100%;
                box-sizing: border-box;
            }

            .config-node-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                padding: 0 10px;
                margin-bottom: 10px;
            }

            .config-node-item {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                font-size: 12px;
                color: #333;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 60px;
            }

            .config-node-item:hover {
                background: #f9f9f9;
                border-color: var(--primary);
                box-shadow: 0 4px 8px rgba(0, 122, 255, 0.1);
            }

            .node-detail-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(2px);
            }

            .node-detail-modal.open {
                display: flex;
            }

            .node-detail-content {
                background: white;
                width: 85%;
                max-width: 500px;
                padding: 25px 20px;
                border-radius: 15px;
                max-height: 80vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .node-detail-header {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 20px;
                color: #333;
            }

            .node-field-list {
                flex: 1;
                margin-bottom: 15px;
            }

            .node-field-item {
                background: #f9f9f9;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .node-field-info {
                flex: 1;
            }

            .node-field-name {
                font-weight: bold;
                color: #333;
                margin-bottom: 4px;
            }

            .node-field-type {
                font-size: 12px;
                color: #999;
            }

            .node-sort-zone {
                width: 36px;
                background: #f9f9f9;
                border-right: 1px solid #eee;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .node-sort-btn {
                flex: 1;
                width: 100%;
                border: none;
                background: transparent;
                color: #ccc;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
            }

            .node-sort-btn:active {
                color: var(--primary);
                background: #eee;
            }

            .node-sort-btn:first-child {
                border-bottom: 1px solid #eee;
            }

            .hidden {
                display: none;
            }

            #auth-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(5px);
            }

            /* ğŸŒŸ æ ¸å¿ƒï¼šä¸ºç™½æ¡†å¢åŠ ç›¸å¯¹å®šä½ */
            .auth-box {
                position: relative;
                background: white;
                padding: 30px;
                border-radius: 16px;
                width: 85%;
                max-width: 350px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
            }

            /* ğŸŒŸ æ ¸å¿ƒï¼šè®©å‰å·ç›¸å¯¹äºç™½æ¡†ç»å¯¹å®šä½ */
            .auth-close-btn {
                position: absolute;
                top: 10px;
                right: 15px;
                font-size: 28px;
                color: #ccc;
                cursor: pointer;
                line-height: 1;
                z-index: 10;
                padding: 10px;
                /* å¢åŠ æ‰‹æœºç‚¹å‡»åŒºåŸŸ */
            }

            .auth-close-btn:hover {
                color: #333;
            }

            .auth-box h2 {
                margin-top: 0;
                color: #1d1d1f;
            }

            .auth-input {
                width: 100%;
                padding: 12px;
                margin: 10px 0;
                border: 1px solid #d2d2d7;
                border-radius: 8px;
                box-sizing: border-box;
                font-size: 16px;
            }

            .auth-btn {
                width: 100%;
                padding: 12px;
                background: #007aff;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                margin-top: 10px;
            }

            .auth-btn:active {
                background: #005bb5;
            }

            .auth-switch {
                margin-top: 15px;
                font-size: 14px;
                color: #007aff;
                cursor: pointer;
                text-decoration: underline;
            }

            .error-msg {
                color: #ff3b30;
                font-size: 14px;
                margin-top: 10px;
                display: none;
            }

            .toast {
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                z-index: 1000;
            }

            .user-badge {
                font-size: 12px;
                color: var(--primary);
                background: #e3f2fd;
                padding: 4px 8px;
                border-radius: 10px;
                cursor: pointer;
            }

            .btn-delete-icon {
                width: 32px;
                height: 32px;
                background: transparent;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                margin-left: 8px;
                flex-shrink: 0;
                opacity: 0.4;
                transition: all 0.2s;
            }

            .btn-delete-icon:active {
                transform: scale(0.9);
                opacity: 1;
            }

            .btn-delete-icon svg {
                width: 18px;
                height: 18px;
                stroke: #999;
                stroke-width: 1.5;
                fill: none;
            }

            .btn-delete-icon:active svg {
                stroke: #FF3B30;
            }

            #toolsPage {
                display: none;
                position: absolute;
                top: 44px;
                /* ä»å¯¼èˆªæ ä¸‹æ–¹å¼€å§‹ */
                left: 0;
                width: 100%;
                height: calc(100% - 44px);
                /* æ‰£é™¤å¯¼èˆªæ é«˜åº¦ */
                background: var(--bg);
                padding: 20px;
                box-sizing: border-box;
                z-index: 50;
            }

            #toolsPage.active {
                display: flex !important;
                flex-direction: column;
                justify-content: flex-start;
            }

            #toolsPage .page-header-row {
                margin-top: 0 !important;
                padding-top: 0;
            }

            .page-header-row {
                display: flex;
                align-items: center;
                padding: 10px 0 20px 0;
                width: 100%;
                border-bottom: 1px solid #f5f5f7;
                margin-bottom: 15px;
                flex-shrink: 0;
            }

            .page-header-title {
                font-size: 18px;
                font-weight: 700;
                margin-left: 15px;
                color: #333;
            }

            .tool-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                align-content: start;
                width: 100%;
            }

            .tool-item {
                background: white;
                border-radius: 16px;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
                cursor: pointer;
                border: 1px solid #f5f5f7;
                height: 90px;
            }

            .tool-item:active {
                transform: scale(0.95);
                background: #fafafa;
            }

            .tool-icon {
                font-size: 32px;
                margin-bottom: 8px;
                line-height: 1;
            }

            .tool-name {
                font-size: 13px;
                font-weight: 500;
                color: #333;
            }

            .node-library-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px;
                max-height: 60vh;
                overflow-y: auto;
                padding: 10px;
            }

            .node-library-grid>div[style*="grid-column"] {
                grid-column: 1 / -1 !important;
                margin: 15px 0 5px 0;
                padding-left: 8px;
                border-left: 3px solid var(--primary);
                font-size: 13px;
                font-weight: bold;
                color: #666;
                background: #f8f9fa;
                line-height: 30px;
            }

            .node-option {
                background: #ffffff;
                border: 1px solid #e5e5ea;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                font-size: 13px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
                transition: all 0.2s;
            }

            .node-option:active {
                background: #f2f2f7;
                transform: scale(0.96);
            }

            /* ç®¡ç†å‘˜ä¸“ç”¨é¢æ¿ */
            .admin-float-btn {
                position: fixed;
                bottom: 100px;
                left: 20px;
                background: #000;
                color: #fff;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: none;
                /* é»˜è®¤éšè— */
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                font-size: 24px;
                cursor: pointer;
                z-index: 999;
            }

            .admin-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
                margin-top: 10px;
            }

            .admin-table th {
                text-align: left;
                background: #eee;
                padding: 8px;
            }

            .admin-table td {
                border-bottom: 1px solid #eee;
                padding: 8px;
            }

            .btn-del-user {
                color: white;
                background: red;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
            }

            /* åˆ·æ–°æŒ‰é’®æ ·å¼ */
            #refreshBtnMain {
                background: transparent;
                border: none;
                font-size: 20px;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--primary);
                cursor: pointer;
                border-radius: 50%;
                transition: all 0.2s;
            }

            #refreshBtnMain:active {
                background: rgba(0, 122, 255, 0.1);
                transform: rotate(180deg);
            }

            /* è½¬åœˆåŠ¨ç”»ï¼ˆç‚¹å‡»æ—¶ï¼‰ */
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            #refreshBtnMain.spin {
                animation: spin 1s linear infinite;
            }

/* æ—¥å†æ—¥å¿—å¼¹çª— - æ‰‹æœºä¼˜åŒ–ç‰ˆ */
#dayLogModal .modal-content {
    max-width: 92% !important;
    border-radius: 20px !important;
    padding: 20px 18px !important;
}

#dayLogModal .log-textarea {
    min-height: 160px !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    padding: 14px !important;
    border-radius: 12px !important;
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
}

#dayLogModal .btn-primary {
    height: 46px !important;
    font-size: 17px !important;
    border-radius: 12px !important;
}

#dayLogModal .btn-cancel {
    font-size: 16px !important;
    color: #666 !important;
    padding: 14px !important;
}

        </style>
    </head>

<body>

    <nav id="mainNavBar" class="navbar-common">
        <div class="nav-left">
            <button class="nav-back-btn" id="globalBackBtn" onclick="goHome()" style="display:none;">
                <svg viewBox="0 0 24 24">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                é¦–é¡µ
            </button>
            <h1 id="globalPageTitle" class="page-title">å·¥ä½œåŠ©æ‰‹</h1>
        </div>
        <div class="nav-right" style="gap: 8px; align-items: center;">
            <!-- ä¸ªäººä¸­å¿ƒæŒ‰é’®ï¼ˆæœ€å·¦ï¼‰ -->
            <span id="userBadge" class="user-badge" onclick="openPersonalCenter()" style="display:none;"></span>

            <!-- èŠ‚ç‚¹åº“æŒ‰é’® -->
            <button id="nodeConfigBtn" class="nav-btn-right" onclick="openConfigModal('global')" style="display:none;">
                âš™ï¸ èŠ‚ç‚¹åº“
            </button>

            <!-- åˆ·æ–°æŒ‰é’®ï¼ˆæœ€å³ç«¯ï¼‰ -->
            <button id="refreshBtnMain" class="nav-btn-right" onclick="manualSyncData(this)" title="åˆ·æ–°äº‘ç«¯æ•°æ®">
                â†»
            </button>
        </div>
    </nav>

    <nav id="detailNavBar" class="navbar-common" style="display:none; border-bottom: 0.5px solid rgba(0,0,0,0.1);">
        <div class="nav-left">
            <button class="nav-back-btn" onclick="goToPage('projectList')">
                <svg viewBox="0 0 24 24">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                åˆ—è¡¨
            </button>
        </div>

        <div class="detail-header-center">
            <div class="detail-title-row">
                <span id="navDetailTitle" class="detail-main-title"></span>
                <span style="font-size: 14px; color: var(--primary); cursor: pointer; margin-left: 4px;"
                    onclick="editProjectName()">âœ</span>
            </div>
            <div id="navDetailType" class="detail-sub-title"></div>
        </div>

        <div class="nav-right" style="gap: 6px; align-items: center;">
            <!-- ä¸ªäººä¸­å¿ƒæŒ‰é’® -->
            <span id="userBadge" class="user-badge" onclick="openPersonalCenter()" style="display:none;"></span>

            <!-- èŠ‚ç‚¹åº“æŒ‰é’®ï¼ˆé å·¦ï¼‰ -->
            <button id="nodeConfigBtn" class="nav-btn-right" onclick="openConfigModal('global')" style="display:none;">
                âš™ï¸ èŠ‚ç‚¹åº“
            </button>

            <!-- åˆ·æ–°æŒ‰é’®ï¼ˆæ”¾åœ¨æœ€å = æœ€å³ç«¯ï¼‰ -->
            <button id="refreshBtnMain" class="nav-btn-right" onclick="manualSyncData(this)" title="åˆ·æ–°äº‘ç«¯æ•°æ®">
                â†»
            </button>
        </div>

    </nav>

    <div id="auth-modal" style="display:none;">
        <div class="auth-box">
            <h2 id="auth-title">ä¸ªäººè´¦å·ç™»å½•</h2>
            <p style="font-size:12px;color:#666;margin-bottom:20px;">ç™»å½•åå¯å¤šç«¯åŒæ­¥æ•°æ®</p>

            <input type="email" id="email" class="auth-input" placeholder="ç”¨æˆ·å (é‚®ç®±æ ¼å¼)">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç  (è‡³å°‘6ä½)">

            <button class="auth-btn" id="auth-action-btn" onclick="handleAuth()">ç™»å½•</button>
            <div id="auth-error" class="error-msg"></div>
            <div class="auth-switch" onclick="switchMode()">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
        </div>
    </div>

    <div id="toast" class="toast">å·²åŒæ­¥åˆ°äº‘ç«¯</div>

    <div id="adminBtn" class="admin-float-btn" onclick="openAdminPanel()">ğŸ‘®</div>

    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>ğŸ‘® è¶…çº§ç®¡ç†åå°</h3>
            <div style="margin: 10px 0; font-weight: bold;">
                æ€»æ³¨å†Œå¹¶å­˜å‚¨æ•°æ®äººæ•°: <span id="adminTotalCount" style="color:red; font-size:20px;">0</span>
            </div>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·ID (å4ä½)</th>
                            <th>æœ€ååŒæ­¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserList"></tbody>
                </table>
            </div>
            <button class="btn-cancel" onclick="closeModal('adminModal')">å…³é—­</button>
        </div>
    </div>

    <div class="page-container">
        <div id="homePage" class="page active">
            <div class="welcome-row">
                <div class="welcome-date" id="welcomeDate">LOADING...</div>
                <div class="welcome-title">ä¸ªäººæ•ˆèƒ½ä¸­å¿ƒ</div>
            </div>

            <div class="asset-card-row">
                <div class="asset-card blue" onclick="goToPage('attendancePage')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="asset-label" style="color:rgba(255,255,255,0.8); margin-bottom:5px;">å½“å‰å¯ä¼‘æ€»å¤©æ•°
                            </div>
                            <div class="asset-value" id="homeOtDays" style="font-size:42px;">0</div>
                        </div>
                        <div style="text-align:right; opacity:0.9;">
                            <div style="font-size:12px;">å¹´å‡/å­˜ä¼‘/å€’ä¼‘</div>
                            <div style="font-size:24px; margin-top:5px;">ğŸ“…</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-section">
                <div class="cal-header">
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(-1)">â€¹</div>
                    <span id="calMonth"></span>
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(1)">â€º</div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-mini" onclick="goToday()">å›åˆ°ä»Šå¤©</button>
                </div>
            </div>

            <div class="todo-section">
                <div class="todo-header-row">
                    <div class="section-head" style="margin:0;">ğŸ“ æˆ‘çš„å¾…åŠ</div>
                    <button class="btn-history" onclick="openTodoHistory()">
                        <span>â†º</span> å†å²å½’æ¡£
                    </button>
                </div>

                <div class="todo-input-row">
                    <input type="text" id="todoInput" class="todo-input" placeholder="è¾“å…¥ä»»åŠ¡ï¼Œå›è½¦æ·»åŠ ..."
                        onkeypress="if(event.keyCode===13) addTodo()">
                    <button class="todo-add-btn" onclick="addTodo()">+</button>
                </div>

                <div id="todoList" class="todo-list"></div>
            </div>

            <div class="section-head" style="margin-top:20px;">ğŸš€ åŠŸèƒ½å¯¼èˆª</div>
            <div class="project-entry-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="entry-card eng" onclick="goToPage('projectList')" style="padding:15px 5px;">
                    <span class="entry-icon">ğŸ—ï¸</span>
                    <span class="entry-title" style="font-size:13px;">å·¥ç¨‹é¡¹ç›®</span>
                </div>
                <div class="entry-card non-eng" onclick="goToPage('nonProjectList')" style="padding:15px 5px;">
                    <span class="entry-icon">ğŸ“‚</span>
                    <span class="entry-title" style="font-size:13px;">éå·¥ç¨‹</span>
                </div>
                <div class="entry-card tools" onclick="goToPage('toolsPage')" style="padding:15px 5px;">
                    <span class="entry-icon">ğŸ§°</span>
                    <span class="entry-title" style="font-size:13px;">ç™¾å®ç®±</span>
                </div>
            </div>

            <div class="footer-tools">
                <div class="tool-btn" onclick="exportData()">ğŸ“¤ å¤‡ä»½æ•°æ®</div>
                <div class="tool-btn" onclick="triggerImport()">ğŸ“¥ æ¢å¤æ•°æ®(Plusç‰ˆ)</div>
            </div>
            <div
                style="text-align: center; color: #ccc; font-size: 10px; margin-bottom: 20px; font-family: monospace; opacity: 0.6;">
                v1.0.0</div>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>

        <div id="attendancePage" class="page">
            <div class="ot-summary-card">
                <div style="font-size:14px; opacity:0.8;">å½“å‰å¯ä¼‘æ€»å¤©æ•°</div>
                <div class="ot-big-num" id="otTotalDays">0.0</div>
                <div class="ot-grid">
                    <div>
                        <div class="ot-label">å‰©å¹´å‡</div>
                        <div class="ot-val" id="dispAnnual">0</div>
                    </div>
                    <div>
                        <div class="ot-label">å‰©å­˜ä¼‘</div>
                        <div class="ot-val" id="dispSaved">0</div>
                    </div>
                    <div>
                        <div class="ot-label">åŠ ç­æ± </div>
                        <div class="ot-val" id="dispOt">0</div>
                    </div>
                </div>
            </div>
            <div class="ot-settings-mini">
                <span>åˆå§‹åŸºæ•°ï¼š</span>
                <label>å¹´å‡</label><input type="number" id="inpAnnual" class="ot-input-mini" onchange="saveBaseLeave()">
                <label>å­˜ä¼‘</label><input type="number" id="inpSaved" class="ot-input-mini" onchange="saveBaseLeave()">
            </div>
            <div class="home-section-title">åŠ ç­è®°å½• (å€’ä¼‘)</div>
            <div id="otListContainer"></div>
            <div style="text-align:center; padding:10px;"><button class="btn-mini" onclick="openModal('addOtModal')">+
                    å½•å…¥åŠ ç­</button></div>
            <div class="home-section-title">ä¼‘å‡è®°å½•</div>
            <div id="leaveListContainer"></div>
            <div style="text-align:center; padding:10px; margin-bottom:50px;"><button class="btn-mini"
                    onclick="openNewLeave()">+ å½•å…¥ä¼‘å‡</button></div>
        </div>

        <div id="projectList" class="page">
            <div class="project-section">
                <div class="project-section-header" style="color:#007AFF;border-color:#007AFF;">ä¸“é¡¹å·¥ç¨‹ <span id="c_s"
                        style="font-size:12px;background:#e3f2fd;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_special" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#AF52DE;border-color:#AF52DE;">é›¶æ˜Ÿå·¥ç¨‹ <span id="c_o"
                        style="font-size:12px;background:#f3e5f5;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_odd" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#FF3B30;border-color:#FF3B30;">æŠ¢ä¿®å·¥ç¨‹ <span id="c_r"
                        style="font-size:12px;background:#ffebee;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_repair" class="project-section-body"></div>
            </div>
            <button class="fab-add" onclick="openModal('createModal')">+</button>
        </div>

        <div id="nonProjectList" class="page">
            <div style="text-align:center; padding:50px 20px; color:#999;">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ“‚</div>
                <h3>éå·¥ç¨‹é¡¹ç›®ç®¡ç†</h3>
                <p>æ­¤æ¨¡å—æ­£åœ¨å»ºè®¾ä¸­...</p>
            </div>
        </div>

        <div id="projectDetail" class="page">
            <div class="segmented-control">
                <button id="seg_timeline" class="segment-btn active" onclick="switchDetailTab('timeline')">ğŸ“…
                    è¿›åº¦ä¸»çº¿</button>
                <button id="seg_services" class="segment-btn" onclick="switchDetailTab('services')">ğŸ¤ å‚å»ºå•ä½</button>
            </div>

            <div id="view_timeline">
                <div class="preview-section">
                    <div class="preview-header"><span>ğŸ“‹ å…¨æ¯è¿›åº¦é¢„è§ˆ</span></div>
                    <div id="previewFlow" class="preview-flow"></div>
                </div>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    <div id="stagesContainer"></div>
                    <div id="emptyHint"
                        style="text-align:center; padding:40px; color:#999; font-size:14px; display:none;">ğŸ‘‡
                        ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæµç¨‹èŠ‚ç‚¹</div>
                </div>
                <div style="text-align:center; padding-bottom:30px;">
                    <button class="btn-add-node" onclick="openNodeLibrary()">+ æ·»åŠ æµç¨‹èŠ‚ç‚¹</button>
                </div>
            </div>

            <div id="view_services" style="display:none;">
                <div id="servicesListContainer"></div>
                <div style="text-align:center; padding:20px; color:#999; font-size:13px;" id="emptyServicesHint">
                    æš‚æ— å‚å»ºå•ä½è®°å½•</div>
                <div style="text-align:center; padding-bottom:30px;">
                    <button class="btn-add-node" style="background:var(--purple);"
                        onclick="openModal('addServiceModal')">+ å½•å…¥å‚å»ºå•ä½</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toolsPage" class="page">
        <div class="page-header-row">
            <span class="page-header-title">ğŸ§° ç™¾å®ç®±</span>
        </div>
        <div class="tool-grid">
            <div class="tool-item" onclick="openModal('dateCalcModal')">
                <span class="tool-icon">ğŸ“…</span>
                <span class="tool-name">æ—¥æœŸè®¡ç®—</span>
            </div>
            <div class="tool-item" style="opacity:0.5; background:#f9f9f9; border:none; cursor:default;">
                <span class="tool-icon" style="font-size:24px; opacity:0.5;">â•</span>
                <span class="tool-name">æ›´å¤š...</span>
            </div>
            <div class="tool-item" style="opacity:0; pointer-events:none;"></div>
        </div>
    </div>

    <div id="dateCalcModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“… æ—¥æœŸå·®è®¡ç®—å™¨</h3>
            <div style="margin-top:15px;">
                <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" id="toolStartDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                <input type="date" id="toolEndDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <button class="btn-primary" onclick="calcDateDiff()" style="margin-top:20px;">è®¡ç®—å¤©æ•°</button>
                <div id="dateResult" class="tool-result"></div>
            </div>
            <button class="btn-cancel" onclick="closeModal('dateCalcModal')">å…³é—­</button>
        </div>
    </div>

<div id="dayLogModal" class="modal">
    <div class="modal-content" style="max-width: 92%; border-radius: 20px; padding: 20px 18px;">
        
        <!-- æ—¥æœŸæ ‡é¢˜ -->
        <div id="logDateTitle" style="font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 16px; color: #1c1c1e;">
            2026-02-10
        </div>

        <!-- æ—¥å¿—è¾“å…¥åŒº -->
        <div style="margin-bottom: 20px;">
            <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; padding-left: 2px;">
                å·¥ä½œæ—¥å¿—
            </div>
            <textarea id="logContent" class="log-textarea" 
                placeholder="è®°å½•ä»Šå¤©çš„å·¥ä½œé‡ç‚¹ã€å®Œæˆäº‹é¡¹ã€å¾…è·Ÿè¿›å†…å®¹..."
                style="min-height: 160px; font-size: 16px; padding: 14px; border-radius: 12px;">
            </textarea>
        </div>

        <!-- ä¿å­˜æŒ‰é’®ï¼ˆæ›´å°ã€æ›´ä¼˜é›…ï¼‰ -->
        <button class="btn-primary" onclick="saveDayLog()" 
            style="height: 46px; font-size: 17px; font-weight: 600; border-radius: 12px; margin-bottom: 8px;">
            ä¿å­˜æ—¥å¿—
        </button>

        <!-- å–æ¶ˆæŒ‰é’®ï¼ˆè½»é‡åŒ–ï¼‰ -->
        <button onclick="closeModal('dayLogModal')" 
            style="width: 100%; background: none; border: none; color: #666; font-size: 16px; padding: 12px 0;">
            å–æ¶ˆ
        </button>
    </div>
</div>

    <div id="todoHistoryModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 5px;">ğŸ“œ å·²å®Œæˆä»»åŠ¡</h3>
            <div style="font-size:12px; color:#999; margin-bottom:15px;">ç‚¹å‡»â€œæ¢å¤â€å¯æ”¾å›é¦–é¡µ</div>
            <div id="historyListContainer" class="history-list"></div>
            <button class="btn-cancel" onclick="closeModal('todoHistoryModal')">å…³é—­</button>
        </div>
    </div>

    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <h3>å½•å…¥å‚å»ºå•ä½</h3>
            <label class="form-label">å•ä½ç±»å‹</label>
            <select id="svcType" class="input-box">
                <option value="è®¾è®¡å•ä½">ğŸ¨ è®¾è®¡å•ä½</option>
                <option value="ç›‘ç†å•ä½">ğŸ‘ï¸ ç›‘ç†å•ä½</option>
                <option value="å‹˜å¯Ÿæµ‹ç»˜">ğŸ“ å‹˜å¯Ÿæµ‹ç»˜</option>
                <option value="é€ ä»·å’¨è¯¢">ğŸ’° é€ ä»·å’¨è¯¢</option>
                <option value="æ‹›æ ‡ä»£ç†">ğŸ“¢ æ‹›æ ‡ä»£ç†</option>
                <option value="å…¶ä»–æœåŠ¡">ğŸ“¦ å…¶ä»–æœåŠ¡</option>
            </select>
            <label class="form-label">å•ä½åç§°</label>
            <input type="text" id="svcName" class="input-box" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚å»ºç­‘è®¾è®¡é™¢">
            <label class="form-label">åˆåŒé‡‘é¢ (å…ƒ)</label>
            <input type="number" id="svcAmount" class="input-box" placeholder="0">
            <label class="form-label">è”ç³»äºº & ç”µè¯</label>
            <input type="text" id="svcContact" class="input-box" placeholder="å¼ ä¸‰ 13800000000">
            <button class="btn-primary" onclick="saveService()">ä¿å­˜</button>
            <button class="btn-cancel" onclick="closeModal('addServiceModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="addOtModal" class="modal">
        <div class="modal-content">
            <h3>å½•å…¥åŠ ç­</h3>
            <label class="form-label">æ—¥æœŸ</label>
            <input type="date" id="otDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">å¤©æ•°</label>
            <input type="number" id="otDays" class="input-box" step="0.5">
            <label class="form-label">å¤‡æ³¨</label>
            <input type="text" id="otNote" class="input-box">
            <button class="btn-primary" onclick="addOvertime()">ç¡®è®¤</button>
            <button class="btn-cancel" onclick="closeModal('addOtModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="addLeaveModal" class="modal">
        <div class="modal-content">
            <h3 id="leaveModalTitle">å½•å…¥ä¼‘å‡</h3>
            <input type="hidden" id="lvEditIndex">
            <label class="form-label">ç±»å‹</label>
            <select id="lvType" class="input-box">
                <option value="å¹´å‡">å¹´å‡</option>
                <option value="å­˜ä¼‘">å­˜ä¼‘</option>
                <option value="å€’ä¼‘">å€’ä¼‘</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <label class="form-label">æ—¥æœŸ</label>
            <input type="date" id="lvDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">å¤©æ•°</label>
            <input type="number" id="lvDays" class="input-box" step="0.5">
            <label class="form-label">è¯´æ˜</label>
            <input type="text" id="lvNote" class="input-box">
            <button class="btn-primary" id="lvSaveBtn" onclick="saveLeaveRecord()">ç¡®è®¤</button>
            <button class="btn-cancel" onclick="closeModal('addLeaveModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="useOtModal" class="modal">
        <div class="modal-content">
            <h3>æ ¸é”€åŠ ç­</h3>
            <p style="color:#666;font-size:13px;margin-bottom:15px">ç¡®è®¤å·²å€’ä¼‘ï¼Ÿ</p>
            <label class="form-label">å€’ä¼‘æ—¥æœŸ</label>
            <input type="date" id="useOtDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <input type="hidden" id="useOtId">
            <button class="btn-primary" onclick="confirmUseOt()">ç¡®è®¤</button>
            <button class="btn-cancel" onclick="closeModal('useOtModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å»ºå·¥ç¨‹</h3>
            <label class="form-label">åç§°</label>
            <input type="text" id="newProjectName" class="input-box">
            <label class="form-label">ç±»åˆ«</label>
            <select id="newProjectType" class="input-box">
                <option value="special">ğŸŒŸ ä¸“é¡¹å·¥ç¨‹</option>
                <option value="odd">ğŸ”§ é›¶æ˜Ÿå·¥ç¨‹</option>
                <option value="repair">ğŸš‘ æŠ¢ä¿®å·¥ç¨‹</option>
            </select>
            <button class="btn-primary" onclick="createProject()">åˆ›å»º</button>
            <button class="btn-cancel" onclick="closeModal('createModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="nodeLibraryModal" class="modal">
        <div class="modal-content">
            <h3>é€‰æ‹©èŠ‚ç‚¹</h3>
            <div id="nodeLibraryGrid" class="node-library-grid"></div>
            <button class="btn-cancel" onclick="closeModal('nodeLibraryModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="dynamicFormModal" class="modal">
        <div class="modal-content">
            <h3 id="formTitle"></h3>
            <div id="dynamicFormContainer"></div>
            <button class="btn-primary" onclick="saveDynamicData()">ä¿å­˜</button>
            <button class="btn-cancel" onclick="closeModal('dynamicFormModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 id="configModalTitle">èŠ‚ç‚¹åº“</h3>
            <div class="config-container" id="configContainer"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-primary" style="flex:1;" onclick="handleConfigSave()">ä¿å­˜</button>
                <button class="btn-cancel" style="flex:1;" onclick="closeModal('configModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="nodeDetailModal" class="node-detail-modal">
        <div class="node-detail-content">
            <div class="node-detail-header" id="nodeDetailTitle"></div>
            <div class="node-field-list" id="nodeFieldList"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-small" onclick="addNewConfigField()" style="flex:1;">+ å¢åŠ å­—æ®µ</button>
                <button class="btn-small" onclick="saveNodeDetailEditor()"
                    style="flex:1; background:var(--primary); color:white;">ä¿å­˜</button>
                <button class="btn-small" onclick="closeNodeDetailEditor()" style="flex:1;">è¿”å›</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://api.9990088.xyz';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZGltYWR6cGJjdm10b3Vqb2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTE3NTksImV4cCI6MjA4NTY4Nzc1OX0.dMJdVjjr3D0oGRli1DE2ohvl-5abwLGHSPAaS8wREG0';

        const { createClient } = supabase;
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });

        // âš ï¸ æŠŠè¿™ä¸ªæ¢æˆä½ è‡ªå·±çš„ç®¡ç†å‘˜é‚®ç®±
        const ADMIN_EMAIL = "liu@qq.com";

        let currentUser = null;
        let isRegisterMode = false;
        let syncTimer = null;

        // ğŸ“ 1. å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œä¸“é—¨è®°ä½ç½®
        let homeScrollTop = 0;

        // ğŸ”„ 2. è¦†ç›–æ—§çš„è·³è½¬å‡½æ•° (å»åˆ«çš„é¡µé¢æ—¶ï¼Œè®°ä¸‹å½“å‰ä½ç½®)
        window.goToPage = function (id) {
            const container = document.querySelector('.page-container');

            // å¦‚æœæ˜¯ä»é¦–é¡µç¦»å¼€ï¼Œèµ¶ç´§è®°ä¸‹ä½ç½®ï¼
            if (document.getElementById('homePage').classList.contains('active')) {
                homeScrollTop = container.scrollTop;
            }

            // --- åŸæœ‰çš„æ˜¾ç¤ºé€»è¾‘ ---
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            // å¯¼èˆªæ å¤„ç†
            if (id === 'projectDetail') {
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                document.getElementById('globalPageTitle').innerText = isHome ? 'å·¥ä½œåŠ©æ‰‹' : '';
            }

            // æ¸²æŸ“é€»è¾‘
            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();

            // --- ğŸ“ æ ¸å¿ƒä½ç½®æ¢å¤é€»è¾‘ ---
            if (id === 'homePage') {
                // å¦‚æœæ˜¯å›é¦–é¡µï¼Œæ¢å¤ä½ç½®
                setTimeout(() => { container.scrollTop = homeScrollTop; }, 0);
            } else {
                // å¦‚æœæ˜¯å»æ–°é¡µé¢ï¼Œæ»šåˆ°æœ€ä¸Šé¢
                container.scrollTop = 0;
            }

            // å†å²è®°å½• (é˜²æ­¢æµè§ˆå™¨åé€€é€€å‡º)
            history.pushState({ pageId: id }, null, "#" + id);
        };

        // ğŸ  3. è¦†ç›–æ—§çš„å›é¦–é¡µå‡½æ•°
        window.goHome = function () {
            if (history.state && history.state.pageId) {
                history.back(); // ä¼˜å…ˆè§¦å‘æµè§ˆå™¨çš„è¿”å›
            } else {
                // å¼ºåˆ¶å›é¦–é¡µ
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('homePage').classList.add('active');
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';
                document.getElementById('globalBackBtn').style.display = 'none';
                document.getElementById('userBadge').style.display = 'block';

                // æ¢å¤ä½ç½®
                setTimeout(() => {
                    document.querySelector('.page-container').scrollTop = homeScrollTop;
                }, 0);
            }
        };
        async function initApp() {


            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                // æœ‰è´¦å· -> èµ°æ­£å¸¸çš„ç™»å½•æµç¨‹ï¼ˆå«æ•°æ®æ¸…æ´—æ£€æŸ¥ï¼‰
                handleLoginSuccess(session.user);
            } else {
                // æ²¡è´¦å· -> åŠ è½½èƒŒæ™¯ï¼Œå¹¶å¼ºåˆ¶æ˜¾ç¤ºç™»å½•æ¡†
                initHome();
                document.getElementById('auth-modal').style.display = 'flex';
            }
        }
        // ğŸŒŸ æ–°å¢å‡½æ•°ï¼šè¿›å…¥è®¿å®¢æ¨¡å¼
        function enterGuestMode() {
            // 1. å…³é—­ç™»å½•å¼¹çª—
            document.getElementById('auth-modal').style.display = 'none';

            // 2. æç¤ºç”¨æˆ·
            showToast('ğŸ‘€ è®¿å®¢æ¨¡å¼ï¼šæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœº');

            // 3. ç¡®ä¿å½“å‰æ²¡æœ‰ç™»å½•ç”¨æˆ·çŠ¶æ€
            currentUser = null;
            document.getElementById('userBadge').style.display = 'none';

            // 4. åŠ è½½æœ¬åœ°ç¼“å­˜çš„æ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰å¹¶æ¸²æŸ“é¡µé¢
            loadConfig();
            migrateData();
            initHome();
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-action-btn');
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) return showAuthError('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

            btn.innerText = 'å¤„ç†ä¸­...';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            let result;
            if (isRegisterMode) {
                result = await _supabase.auth.signUp({ email, password });
            } else {
                result = await _supabase.auth.signInWithPassword({ email, password });
            }

            if (result.error) {
                showAuthError(result.error.message);
                btn.innerText = isRegisterMode ? 'æ³¨å†Œ' : 'ç™»å½•';
                btn.disabled = false;
            } else {
                if (isRegisterMode && !result.data.session) {
                    showAuthError('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤é‚®ä»¶ï¼Œç¡®è®¤åé‡æ–°ç™»å½•ã€‚');
                    btn.innerText = 'æ³¨å†Œ';
                    btn.disabled = false;
                } else {
                    handleLoginSuccess(result.data.user);
                }
            }
        }

        // 1. ğŸŒŸ æ–°å¢ï¼šè®¿å®¢æ¨¡å¼ç‚¹å‡»å‰å·çš„é€»è¾‘
        function enterGuestMode() {
            document.getElementById('auth-modal').style.display = 'none';
            showToast('ğŸ‘€ è®¿å®¢æ¨¡å¼ï¼šæ•°æ®ä»…å­˜åœ¨æœ¬æœº');
            currentUser = null;
            // ç›´æ¥åŠ è½½æœ¬åœ°ç°æœ‰å†…å®¹
            loadConfig(); migrateData(); initHome();
        }

        // 2. ğŸŒŸ ç»ˆæä¿®å¤ï¼šç™»å½•æˆåŠŸå¤„ç†ï¼ˆé˜²ä¸²å·æ­»å¾ªç¯ï¼‰
        async function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';

            const userBadge = document.getElementById('userBadge');
            userBadge.innerText = user.email.split('@')[0];
            userBadge.style.display = 'block';
            // ğŸŒŸ æ–°å¢ï¼šå¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºé»‘è‰²ç®¡ç†æŒ‰é’®
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('adminBtn').style.display = 'flex';
                showToast('ğŸ‘® ç®¡ç†å‘˜æ¨¡å¼å·²æ¿€æ´»');
            } else {
                document.getElementById('adminBtn').style.display = 'none';
            }
            showToast('â˜ï¸ æ­£åœ¨æ ¸éªŒäº‘ç«¯æ•°æ®...');

            try {
                // ğŸ” ç¬¬ä¸€æ­¥ï¼šå…ˆä¸å»è¯»æœ¬åœ°ï¼Œç›´æ¥é—®äº‘ç«¯è¿™ä¸ªå·æœ‰æ²¡æœ‰æ•°æ®
                const { data, error } = await _supabase.from('user_data').select('content').eq('user_id', currentUser.id).single();

                if (data && data.content) {
                    // ğŸŸ¢ æƒ…å†µAï¼šè€ç”¨æˆ·ï¼Œäº‘ç«¯æœ‰ä¸œè¥¿ï¼Œå¼ºè¡Œè¦†ç›–æ‰æœ¬åœ°ç›®å‰çš„è„æ•°æ®
                    const c = data.content;
                    if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                    if (c.config) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                    if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                    if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                    if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
                } else {
                    // ğŸ”´ æƒ…å†µBï¼šæ–°ç”¨æˆ·ï¼Œäº‘ç«¯æ˜¯ç©ºçš„ï¼Œç«‹åˆ»æ‰§è¡Œæ–©é¦–è¡ŒåŠ¨ï¼šæ¸…ç©ºæœ¬åœ°ç¼“å­˜ï¼
                    console.log("æ£€æµ‹åˆ°æ–°è´¦å·ï¼Œæ­£åœ¨æ¸…æ´—æœ¬åœ°æ®‹ç•™æ•°æ®...");
                    localStorage.clear();
                }
            } catch (err) {
                console.log("è¯¥è´¦å·æš‚æ— äº‘ç«¯å¤‡ä»½");
            }

            // ğŸš€ ç¬¬ä¸‰æ­¥ï¼šæ•°æ®æ´—å¹²å‡€äº†ï¼Œå†é‡æ–°åŠ è½½æ¸²æŸ“é¡µé¢
            loadConfig();
            migrateData();
            initHome();
            showToast('âœ… ç™»å½•æˆåŠŸ');
        }
        function switchMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? 'æ³¨å†Œæ–°è´¦å·' : 'äº‘ç«¯è´¦å·ç™»å½•';
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? 'æ³¨å†Œ' : 'ç™»å½•';
            document.querySelector('.auth-switch').innerText = isRegisterMode ? 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•' : 'æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ';
            document.getElementById('auth-error').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.innerText = msg;
            el.style.display = 'block';
        }

        async function logout() {
            // ğŸŒŸ ç®€æ´æç¤ºï¼Œä¸å†åºŸè¯
            if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ')) {
                // 1. åŠ¨ä½œï¼šç›´æ¥æ¸…ç©ºæœ¬åœ°ï¼Œä¸ç•™ç—•è¿¹
                localStorage.clear();

                // 2. åŠ¨ä½œï¼šæ–­å¼€äº‘ç«¯
                await _supabase.auth.signOut();

                // 3. åŠ¨ä½œï¼šåˆ·æ–°é‡å¯
                window.location.reload();
            }
        }

        function debouncedSync() {
            if (!currentUser) return;
            showToast('ğŸ”„ æ­£åœ¨åŒæ­¥...');
            clearTimeout(syncTimer);
            syncTimer = setTimeout(async () => {
                const payload = {
                    projects: JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'),
                    config: JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}'),
                    attendance: JSON.parse(localStorage.getItem(DB_KEY_OT) || '{}'),
                    todo: JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]'),
                    calendar: JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}'),
                    updated_at: new Date().toISOString()
                };
                const { error } = await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                if (!error) showToast('âœ… å·²åŒæ­¥åˆ°äº‘ç«¯');
                else showToast('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }, 1000);
        }

        // ==================== æ•°æ®åˆ·æ–°æŒ‰é’®è°ƒç”¨å‡½æ•° ====================
        async function manualSyncData(btnElement) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•è´¦å·æ‰èƒ½åŒæ­¥äº‘ç«¯æ•°æ®');
                return;
            }

            // ç‚¹å‡»æ—¶æ˜¾ç¤ºè½¬åœˆ
            if (btnElement) btnElement.classList.add('spin');

            try {
                const { data, error } = await _supabase
                    .from('user_data')
                    .select('content')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error) throw error;

                if (data && data.content) {
                    // è¦†ç›–æœ¬åœ°æ•°æ®ï¼ˆä»¥äº‘ç«¯ä¸ºå‡†ï¼‰
                    const c = data.content;
                    if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                    if (c.config) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                    if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                    if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                    if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));

                    // åˆ·æ–°å½“å‰é¡µé¢æ˜¾ç¤º
                    if (document.getElementById('homePage').classList.contains('active')) {
                        initHome();
                    } else if (document.getElementById('projectList').classList.contains('active')) {
                        renderProjects();
                    } else if (document.getElementById('attendancePage').classList.contains('active')) {
                        renderOtPage();
                    }

                    showToast('âœ… æ•°æ®å·²ä»äº‘ç«¯åˆ·æ–°');
                } else {
                    showToast('äº‘ç«¯æš‚æ— æ•°æ®');
                }
            } catch (err) {
                console.error(err);
                showToast('âŒ åˆ·æ–°å¤±è´¥');
            } finally {
                if (btnElement) btnElement.classList.remove('spin');
            }
        }

        async function syncCloudToLocal() {
            const { data, error } = await _supabase.from('user_data').select('content').eq('user_id', currentUser.id).single();
            if (data && data.content) {
                const c = data.content;
                if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                if (c.config && Object.keys(c.config).length > 0) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        // --- ğŸŒŸ V64 æ ¸å¿ƒä¿®æ”¹ï¼šæ™ºèƒ½å¯¼èˆªæ åˆ‡æ¢ logic ---
        function goHome() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('homePage').classList.add('active');

            // åˆ‡æ¢åˆ°ä¸»å¯¼èˆªæ 
            document.getElementById('mainNavBar').style.display = 'flex';
            document.getElementById('detailNavBar').style.display = 'none';

            // æ¢å¤ä¸»å¯¼èˆªçŠ¶æ€
            document.getElementById('globalBackBtn').style.display = 'none';
            document.getElementById('userBadge').style.display = 'block';
            document.getElementById('globalPageTitle').innerText = 'å·¥ä½œåŠ©æ‰‹';

            // é…ç½®æŒ‰é’®éšè—
            document.getElementById('nodeConfigBtn').style.display = 'none';

            initHome();
        }

        function goToPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            if (id === 'projectDetail') {
                // è¯¦æƒ…é¡µï¼šæ˜¾ç¤ºè¯¦æƒ…ä¸“ç”¨å¯¼èˆªæ 
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                // å…¶ä»–é¡µé¢ï¼šæ˜¾ç¤ºä¸»å¯¼èˆªæ 
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';

                // å¤„ç†â€œåˆ—è¡¨é¡µâ€ç­‰å­é¡µé¢çš„è¿”å›æŒ‰é’®
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';

                // å·¥ç¨‹åˆ—è¡¨é¡µæ˜¾ç¤ºâ€œé…ç½®â€æŒ‰é’®
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                // ğŸŒŸ ä¿®æ”¹ï¼šåªæœ‰åœ¨é¦–é¡µæ˜¾ç¤ºæ ‡é¢˜ï¼Œå…¶ä»–é¡µé¢ç•™ç©º
                if (id === 'homePage') {
                    document.getElementById('globalPageTitle').innerText = 'å·¥ä½œåŠ©æ‰‹';
                } else {
                    document.getElementById('globalPageTitle').innerText = '';

                }
            }

            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        const DB_KEY_DATA = 'engineering_master_db';
        const DB_KEY_CONFIG = 'engineering_config_v15';
        const DB_KEY_OT = 'attendance_master_db_v2';
        const DB_KEY_TODO = 'todo_master_db';
        const DB_KEY_CAL = 'calendar_master_db';

        const NODE_CATEGORIES = {
            "ğŸ“Œ é¡¹ç›®å‰æœŸæ‰‹ç»­": ["æ–¹æ¡ˆè®¾è®¡", "å¸‚å±€æŠ¥å®¡", "åŒºæ”¿åºœä¼š", "å‘æ”¹å§”ç«‹é¡¹", "äº‹å‰è¯„ä¼°", "è´¢æ”¿è¯„å®¡"],
            "ğŸ’° é‡‡è´­æ‰‹ç»­": ["å§”æ‰˜ä»£ç†ç­¾åˆåŒ", "ç¼–åˆ¶é‡‡è´­æ–‡ä»¶", "æ„å‘å…¬å¼€", "å‘å¸ƒå…¬å‘Š", "å®Œæˆè¯„æ ‡", "å‘å¸ƒä¸­æ ‡å…¬ç¤º"],
            "ğŸ¢ ç®¡ç†å¤„å†…éƒ¨æ‰‹ç»­": ["å…šç»„ä¼š", "ä¸»ä»»åŠå…¬ä¼š", "çº¸è´¨è¯·ç¤º", "ä»˜æ¬¾"],
            "ğŸ—ï¸ å·¥ç¨‹å®æ–½è¿‡ç¨‹åŠåç»­æ‰‹ç»­": ["å¼€å·¥å¤‡æ¡ˆ", "è®¾è®¡äº¤åº•", "æ–½å·¥å…¥åœº", "ç«£å·¥éªŒæ”¶", "ç»“ç®—å®¡æ ¸", "èµ„æ–™å½’æ¡£"]
        };

        const DEFAULT_CONFIG = {
            "æ–¹æ¡ˆè®¾è®¡": [{ key: "finishDate", label: "å›¾çº¸å®Œæˆæ—¶é—´", type: "date" }, { key: "designUnit", label: "è®¾è®¡å•ä½", type: "text" }],
            "å¸‚å±€æŠ¥å®¡": [{ key: "submitDate", label: "æŠ¥é€æ—¶é—´", type: "date" }, { key: "replyDate", label: "æ‰¹å¤æ—¶é—´", type: "date" }],
            "åŒºæ”¿åºœä¼š": [{ key: "meetDate", label: "ä¸Šä¼šæ—¶é—´", type: "date" }, { key: "minutesNo", label: "çºªè¦æ–‡å·", type: "text" }],
            "å‘æ”¹å§”ç«‹é¡¹": [{ key: "submitDate", label: "ç”³æŠ¥æ—¶é—´", type: "date" }, { key: "approvalDate", label: "æ‰¹å¤æ—¶é—´", type: "date" }, { key: "approvalAmount", label: "æ‰¹å¤é‡‘é¢(å…ƒ)", type: "number" }, { key: "projectCode", label: "é¡¹ç›®ä»£ç ", type: "text" }],
            "äº‹å‰è¯„ä¼°": [{ key: "evalDate", label: "è¯„ä¼°ä¼šè®®æ—¶é—´", type: "date" }, { key: "reportDate", label: "æŠ¥å‘Šå‡ºå…·æ—¶é—´", type: "date" }],
            "è´¢æ”¿è¯„å®¡": [{ key: "sendDate", label: "é€å®¡æ—¶é—´", type: "date" }, { key: "reportDate", label: "è¯„å®¡æŠ¥å‘Šæ—¶é—´", type: "date" }, { key: "auditAmount", label: "å®¡å®šé‡‘é¢(å…ƒ)", type: "number" }],
            "å§”æ‰˜ä»£ç†ç­¾åˆåŒ": [{ key: "signDate", label: "ç­¾è®¢æ—¶é—´", type: "date" }, { key: "agencyName", label: "ä»£ç†æœºæ„åç§°", type: "text" }],
            "ç¼–åˆ¶é‡‡è´­æ–‡ä»¶": [{ key: "finishDate", label: "ç¼–åˆ¶å®Œæˆæ—¶é—´", type: "date" }, { key: "controlPrice", label: "æ§åˆ¶ä»·/é¢„ç®—(å…ƒ)", type: "number" }, { key: "purchaseMode", label: "é‡‡è´­æ–¹å¼", type: "select", options: ["å…¬å¼€æ‹›æ ‡", "ç«äº‰æ€§ç£‹å•†", "å•ä¸€æ¥æº", "è¯¢ä»·"] }],
            "æ„å‘å…¬å¼€": [{ key: "publicDate", label: "æŒ‚ç½‘æ—¶é—´", type: "date" }, { key: "link", label: "å…¬å‘Šé“¾æ¥", type: "text" }],
            "å‘å¸ƒå…¬å‘Š": [{ key: "publishDate", label: "å‘å¸ƒæ—¶é—´", type: "date" }, { key: "openDate", label: "é¢„è®¡å¼€æ ‡æ—¶é—´", type: "date" }],
            "å®Œæˆè¯„æ ‡": [{ key: "evalDate", label: "è¯„æ ‡æ—¶é—´", type: "date" }, { key: "evalLocation", label: "è¯„æ ‡åœ°ç‚¹", type: "text" }],
            "å‘å¸ƒä¸­æ ‡å…¬ç¤º": [{ key: "noticeDate", label: "å…¬ç¤ºå‘å¸ƒæ—¶é—´", type: "date" }, { key: "winner", label: "ä¸­æ ‡å•ä½", type: "text" }, { key: "winAmount", label: "ä¸­æ ‡é‡‘é¢(å…ƒ)", type: "number" }],
            "å…šç»„ä¼š": [{ key: "meetDate", label: "ä¼šè®®æ—¶é—´", type: "date" }, { key: "topic", label: "è®®é¢˜åç§°", type: "text" }],
            "ä¸»ä»»åŠå…¬ä¼š": [{ key: "meetDate", label: "ä¼šè®®æ—¶é—´", type: "date" }, { key: "topic", label: "è®®é¢˜åç§°", type: "text" }],
            "çº¸è´¨è¯·ç¤º": [{ key: "approveDate", label: "æ‰¹å‡†æ—¶é—´", type: "date" }],
            "ä»˜æ¬¾": [{ key: "submitFinanceDate", label: "æäº¤è´¢åŠ¡æ—¥æœŸ", type: "date" }, { key: "payAmount", label: "æ”¯ä»˜é‡‘é¢(å…ƒ)", type: "number" }, { key: "payType", label: "æ¬¾é¡¹æ€§è´¨", type: "select", options: ["é¦–ç¬”æ¬¾", "è¿›åº¦æ¬¾", "å°¾æ¬¾", "è´¨ä¿é‡‘"] }],
            "å¼€å·¥å¤‡æ¡ˆ": [{ key: "submitDate", label: "å¤‡æ¡ˆæ—¶é—´", type: "date" }, { key: "recordType", label: "å¤‡æ¡ˆç±»å‹", type: "select", options: ["ç›‘ç£ç«™å¤‡æ¡ˆ", "å·¥ç¨‹ç§‘å¤‡æ¡ˆ"] }],
            "è®¾è®¡äº¤åº•": [{ key: "meetDate", label: "äº¤åº•æ—¶é—´", type: "date" }],
            "æ–½å·¥å…¥åœº": [{ key: "entryDate", label: "è¿›åœºæ—¥æœŸ", type: "date" }],
            "ç«£å·¥éªŒæ”¶": [{ key: "checkDate", label: "ç«£å·¥éªŒæ”¶æ—¥æœŸ", type: "date" }],
            "ç»“ç®—å®¡æ ¸": [{ key: "finishAuditDate", label: "å®¡å®šæ—¥æœŸ", type: "date" }, { key: "finalAmount", label: "å®¡å®šé‡‘é¢(å…ƒ)", type: "number" }, { key: "reduceAmount", label: "æ ¸å‡é‡‘é¢(å…ƒ)", type: "number" }],
            "èµ„æ–™å½’æ¡£": [{ key: "archiveDate", label: "å½’æ¡£æ—¥æœŸ", type: "date" }]
        };

        let GLOBAL_CONFIG = {}, currentProjectId = null, currentStageIndex = null, draggedItemIndex = null, draggedProjectIndex = null, configMode = 'global', tempLocalConfig = null, editingKey = null, dragSrcType = null;
        let viewYear = new Date().getFullYear();
        let viewMonth = new Date().getMonth();
        let selectedDateStr = null;

        const DB = { get: () => JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'), save: d => { localStorage.setItem(DB_KEY_DATA, JSON.stringify(d)); debouncedSync(); } };
        const DB_OT = { get: () => { const d = localStorage.getItem(DB_KEY_OT); return d ? JSON.parse(d) : { annual: 0, saved: 0, records: [], leaveRecords: [] } }, save: d => { localStorage.setItem(DB_KEY_OT, JSON.stringify(d)); debouncedSync(); } };
        const DB_TODO = {
            get: () => {
                const masterData = localStorage.getItem('todo_master_db');
                const oldData = localStorage.getItem('todo_db');
                if (!masterData && oldData) {
                    console.log("æ£€æµ‹åˆ°æ—§å¾…åŠæ•°æ®ï¼Œæ­£åœ¨è‡ªåŠ¨è¿ç§»...");
                    localStorage.setItem('todo_master_db', oldData);
                    return JSON.parse(oldData);
                }
                return JSON.parse(masterData || '[]');
            },
            save: (d) => {
                localStorage.setItem('todo_master_db', JSON.stringify(d));
                if (typeof debouncedSync === 'function') debouncedSync();
            }
        };
        const DB_CAL = { get: () => { const d = localStorage.getItem(DB_KEY_CAL); return d ? JSON.parse(d) : {} }, save: d => { localStorage.setItem(DB_KEY_CAL, JSON.stringify(d)); debouncedSync(); } };

        function loadConfig() {
            const local = JSON.parse(localStorage.getItem(DB_KEY_CONFIG)) || {};
            GLOBAL_CONFIG = { ...DEFAULT_CONFIG, ...local };
            Object.keys(DEFAULT_CONFIG).forEach(key => {
                if (!GLOBAL_CONFIG[key] || GLOBAL_CONFIG[key].length === 0) {
                    GLOBAL_CONFIG[key] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[key]));
                }
            });
        }
        function migrateData() { let list = DB.get(), ch = false; list.forEach(p => { p.stages.forEach(s => { if (!s.config) { s.config = JSON.parse(JSON.stringify(GLOBAL_CONFIG[s.name] || [])); ch = true } }) }); if (ch) DB.save(list); }

        window.onload = function () { initApp(); };

        function initHome() {
            const d = new Date();
            const days = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            document.getElementById('welcomeDate').innerText = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ Â· ${days[d.getDay()]}`;
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
            const ot = DB_OT.get();
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            (ot.leaveRecords || []).forEach(l => { if (l.type == 'å¹´å‡') usedAnnual += parseFloat(l.days); if (l.type == 'å­˜ä¼‘') usedSaved += parseFloat(l.days); });
            (ot.records || []).forEach(r => { if (r.status != 'used') activeOt += parseFloat(r.days); });
            const total = (parseFloat(ot.annual || 0) - usedAnnual) + (parseFloat(ot.saved || 0) - usedSaved) + activeOt;
            document.getElementById('homeOtDays').innerText = total;
            renderTodos();
        }

        function renderCalendar(y, m) {
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const todayDate = new Date();
            const isCurrentMonth = (y === todayDate.getFullYear() && m === todayDate.getMonth());
            const today = todayDate.getDate();
            const logs = DB_CAL.get();
            document.getElementById('calMonth').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '<div class="cal-day-name">æ—¥</div><div class="cal-day-name">ä¸€</div><div class="cal-day-name">äºŒ</div><div class="cal-day-name">ä¸‰</div><div class="cal-day-name">å››</div><div class="cal-day-name">äº”</div><div class="cal-day-name">å…­</div>';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let i = 1; i <= daysInMonth; i++) {
                const mStr = (m + 1).toString().padStart(2, '0');
                const dStr = i.toString().padStart(2, '0');
                const dateKey = `${y}-${mStr}-${dStr}`;
                let cls = 'cal-day';
                if (isCurrentMonth && i === today) cls += ' today';
                if (logs[dateKey]) cls += ' has-log';
                const div = document.createElement('div');
                div.className = cls;
                div.innerText = i;
                div.onclick = () => openDayLog(dateKey);
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderCalendar(viewYear, viewMonth);
        }

        function goToday() {
            const d = new Date();
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
        }

        function openDayLog(dateStr) {
            selectedDateStr = dateStr;
            document.getElementById('logDateTitle').innerText = dateStr;
            const logs = DB_CAL.get();
            document.getElementById('logContent').value = logs[dateStr] || '';
            openModal('dayLogModal');
        }

        function saveDayLog() {
            if (!selectedDateStr) return;
            const content = document.getElementById('logContent').value.trim();
            const logs = DB_CAL.get();
            if (content) { logs[selectedDateStr] = content; } else { delete logs[selectedDateStr]; }
            DB_CAL.save(logs);
            closeModal('dayLogModal');
            renderCalendar(viewYear, viewMonth);
        }

        function renderTodos() {
            const list = DB_TODO.get();
            const container = document.getElementById('todoList');
            if (!container) return;
            container.innerHTML = '';
            const activeTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => !t.done);
            if (activeTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">ğŸ‰ å¤ªæ£’äº†ï¼Œæ‰€æœ‰å¾…åŠå·²æ¸…ç©ºï¼</div>';
                return;
            }
            activeTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.innerHTML = `
                    <div class="todo-checkbox" onclick="toggleTodo(${t.originIdx})"></div>
                    <div class="todo-text">${t.text}</div>
                    <button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`;
                container.appendChild(div);
            });
        }

        function addTodo() {
            const val = document.getElementById('todoInput').value.trim();
            if (!val) return;
            const list = DB_TODO.get();
            list.unshift({ text: val, done: false, createDate: new Date().toISOString() });
            DB_TODO.save(list);
            document.getElementById('todoInput').value = '';
            renderTodos();
            initHome();
        }

        function toggleTodo(originIdx) {
            const list = DB_TODO.get();
            const item = list[originIdx];
            item.done = !item.done;
            if (item.done) {
                const now = new Date();
                const timeStr = `${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                item.completedAt = timeStr;
            } else {
                delete item.completedAt;
            }
            DB_TODO.save(list);
            renderTodos();
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function deleteTodo(originIdx) {
            if (!confirm("å½»åº•åˆ é™¤ï¼Ÿ")) return;
            const list = DB_TODO.get();
            list.splice(originIdx, 1);
            DB_TODO.save(list);
            renderTodos();
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function openTodoHistory() {
            renderHistoryList();
            openModal('todoHistoryModal');
        }

        function renderHistoryList() {
            const list = DB_TODO.get();
            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';
            const doneTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => t.done);
            if (doneTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— å½’æ¡£è®°å½•</div>';
                return;
            }
            doneTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                        <div style="flex:1; text-decoration:line-through; color:#999; font-size:14px; margin-right:10px; word-break:break-all;">${t.text}</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="btn-restore" onclick="toggleTodo(${t.originIdx})">æ¢å¤</button>
                            <button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="history-time">ğŸ å®Œæˆäºï¼š${t.completedAt || 'æ—©æœŸè®°å½•'}</div>
                `;
                container.appendChild(div);
            });
        }

        function getDeadline(dateStr) { if (!dateStr) return "æœªçŸ¥"; const d = new Date(dateStr); const target = new Date(d.getFullYear(), d.getMonth() + 2, 0); return target.toISOString().split('T')[0]; }

        function renderOtPage() {
            const data = DB_OT.get();
            document.getElementById('inpAnnual').value = data.annual;
            document.getElementById('inpSaved').value = data.saved;
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            const lvContainer = document.getElementById('leaveListContainer');
            lvContainer.innerHTML = '';
            (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((l, idx) => {
                const days = parseFloat(l.days);
                let typeColor = '#999';
                if (l.type === 'å¹´å‡') { usedAnnual += days; typeColor = '#007AFF'; }
                if (l.type === 'å­˜ä¼‘') { usedSaved += days; typeColor = '#AF52DE'; }
                const div = document.createElement('div');
                div.className = 'ot-list-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `<div style="flex:1;"><div style="font-weight:600"><span class="leave-type-tag" style="background:${typeColor}">${l.type || 'ä¼‘å‡'}</span>${l.date} <span style="color:#FF3B30">-${days}å¤©</span></div><div style="font-size:12px;color:#999;margin-left:5px;">${l.note || '-'}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); delLeaveItem(${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                div.onclick = () => editLeave(idx);
                lvContainer.appendChild(div);
            });
            const otContainer = document.getElementById('otListContainer');
            otContainer.innerHTML = '';
            (data.records || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const div = document.createElement('div');
                div.className = `ot-card ${r.status === 'used' ? 'used' : ''}`;
                let actionHtml = '';
                let statusBadge = '';
                const trashIcon = `<button class="btn-delete-icon" onclick="delOtItem('${r.id}')" style="margin-left:0;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                if (r.status === 'used') {
                    statusBadge = `<span class="ot-badge">å·²ä¼‘</span>`;
                    actionHtml = `<div style="display:flex;justify-content:flex-end;align-items:center;margin-top:5px;"><span style="font-size:12px;margin-right:10px;">å½’æ¡£: ${r.usedDate}</span> ${trashIcon}</div>`;
                } else {
                    activeOt += parseFloat(r.days);
                    const deadline = getDeadline(r.date);
                    statusBadge = `<span class="ot-badge" style="background:#e3f2fd;color:#007AFF">å¾…ä¼‘</span>`;
                    actionHtml = `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><div class="ot-deadline">æœ‰æ•ˆæœŸè‡³: ${deadline}</div><div style="display:flex;align-items:center;gap:5px;"><button class="btn-mini action" onclick="preUseOt('${r.id}')">âœ… ä¼‘å®Œ</button>${trashIcon}</div></div>`;
                }
                div.innerHTML = `<div class="ot-card-header"><div class="ot-date">${r.date} <span style="font-size:14px;margin-left:5px;">+${r.days}å¤©</span></div>${statusBadge}</div><div class="ot-desc">${r.note || 'æ— å¤‡æ³¨'}</div>${actionHtml}`;
                otContainer.appendChild(div);
            });
            const remAnnual = parseFloat(data.annual || 0) - usedAnnual;
            const remSaved = parseFloat(data.saved || 0) - usedSaved;
            document.getElementById('dispAnnual').innerText = remAnnual;
            document.getElementById('dispSaved').innerText = remSaved;
            document.getElementById('dispOt').innerText = activeOt;
            document.getElementById('otTotalDays').innerText = remAnnual + remSaved + activeOt;
        }

        function saveBaseLeave() { const data = DB_OT.get(); data.annual = document.getElementById('inpAnnual').value || 0; data.saved = document.getElementById('inpSaved').value || 0; DB_OT.save(data); renderOtPage(); }
        function addOvertime() { const date = document.getElementById('otDate').value; const days = document.getElementById('otDays').value; if (!date || !days) return alert("è¯·å¡«å†™å®Œæ•´"); const data = DB_OT.get(); data.records.push({ id: Date.now().toString(), date, days, note: document.getElementById('otNote').value, status: 'active' }); DB_OT.save(data); closeModal('addOtModal'); renderOtPage(); }
        function preUseOt(id) { document.getElementById('useOtId').value = id; document.getElementById('useOtDate').value = new Date().toISOString().split('T')[0]; openModal('useOtModal'); }
        function confirmUseOt() { const id = document.getElementById('useOtId').value; const date = document.getElementById('useOtDate').value; if (!date) return alert("è¯·å¡«å†™æ—¥æœŸ"); const data = DB_OT.get(); const item = data.records.find(r => r.id === id); if (item) { item.status = 'used'; item.usedDate = date; DB_OT.save(data); closeModal('useOtModal'); renderOtPage(); } }
        function delOtItem(id) { if (confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ")) { const data = DB_OT.get(); data.records = data.records.filter(r => r.id !== id); DB_OT.save(data); renderOtPage(); } }
        function openNewLeave() { document.getElementById('lvEditIndex').value = ''; document.getElementById('leaveModalTitle').innerText = 'å½•å…¥ä¼‘å‡'; document.getElementById('lvType').value = 'å¹´å‡'; document.getElementById('lvDate').value = new Date().toISOString().split('T')[0]; document.getElementById('lvDays').value = ''; document.getElementById('lvNote').value = ''; document.getElementById('lvSaveBtn').innerText = 'ç¡®è®¤'; openModal('addLeaveModal'); }
        function editLeave(idx) {
            const data = DB_OT.get();
            const sorted = (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const record = sorted[idx];
            if (!record) return alert('è®°å½•ä¸å­˜åœ¨');
            document.getElementById('lvEditIndex').value = idx;
            document.getElementById('leaveModalTitle').innerText = 'ç¼–è¾‘ä¼‘å‡';
            document.getElementById('lvType').value = record.type || 'å¹´å‡';
            document.getElementById('lvDate').value = record.date;
            document.getElementById('lvDays').value = record.days;
            document.getElementById('lvNote').value = record.note || '';
            document.getElementById('lvSaveBtn').innerText = 'ä¿å­˜ä¿®æ”¹';
            openModal('addLeaveModal');
        }
        function saveLeaveRecord() {
            const editIdx = document.getElementById('lvEditIndex').value;
            const type = document.getElementById('lvType').value;
            const date = document.getElementById('lvDate').value;
            const days = document.getElementById('lvDays').value;
            if (!date || !days) return alert("è¯·å¡«å†™å®Œæ•´");
            const data = DB_OT.get();
            if (!data.leaveRecords) data.leaveRecords = [];
            if (editIdx === '') {
                data.leaveRecords.push({ type, date, days, note: document.getElementById('lvNote').value });
            } else {
                const sorted = data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                const record = sorted[parseInt(editIdx)];
                if (record) { record.type = type; record.date = date; record.days = days; record.note = document.getElementById('lvNote').value; }
            }
            DB_OT.save(data);
            closeModal('addLeaveModal');
            renderOtPage();
        }
        function delLeaveItem(idx) { if (confirm("åˆ é™¤æ­¤ä¼‘å‡è®°å½•ï¼Ÿå°†æ¢å¤å¯¹åº”çš„é¢åº¦ã€‚")) { const data = DB_OT.get(); data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date)); data.leaveRecords.splice(idx, 1); DB_OT.save(data); renderOtPage(); } }

        function openConfigModal(mode, stageIndex = null) {
            configMode = mode;
            if (mode === 'global') { renderConfigContainer(); } else {
                currentStageIndex = stageIndex;
                const p = DB.get().find(x => x.id === currentProjectId);
                const stage = p.stages[stageIndex];
                tempLocalConfig = JSON.parse(JSON.stringify(stage.config));
                editingKey = 'LOCAL_EDIT';
                document.getElementById('configModalTitle').innerText = 'é…ç½®ï¼š' + stage.name;
                renderConfigFields(tempLocalConfig);
            }
            openModal('configModal');
        }

        function renderConfigContainer() {
            const container = document.getElementById('configContainer');
            container.innerHTML = '';

            // è¯»å–ç§æœ‰èŠ‚ç‚¹æ˜ å°„è¡¨ (æ ¼å¼: { "é¡¹ç›®å‰æœŸæ‰‹ç»­": ["æˆ‘çš„ç§æœ‰èŠ‚ç‚¹A"], "é‡‡è´­æ‰‹ç»­": [] })
            const customMap = GLOBAL_CONFIG._customNodeMap || {};

            Object.keys(NODE_CATEGORIES).forEach(cat => {
                // 1. æ¸²æŸ“åˆ†ç±»æ ‡é¢˜
                const catTitle = document.createElement('div');
                catTitle.className = 'config-category-title';
                catTitle.innerText = cat;
                container.appendChild(catTitle);

                const grid = document.createElement('div');
                grid.className = 'config-node-grid';

                // 2. æ¸²æŸ“ã€å…¬å…±èŠ‚ç‚¹ã€‘ (é»‘è‰²)
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const nodeBtn = document.createElement('div');
                    nodeBtn.className = 'config-node-item';
                    nodeBtn.innerText = nodeName;
                    nodeBtn.onclick = () => openNodeDetailEditor(nodeName);
                    grid.appendChild(nodeBtn);
                });

                // 3. æ¸²æŸ“ã€ç§æœ‰èŠ‚ç‚¹ã€‘ (ç´«è‰²ï¼Œä»…å±äºå½“å‰åˆ†ç±»)
                if (customMap[cat] && Array.isArray(customMap[cat])) {
                    customMap[cat].forEach(nodeName => {
                        const nodeBtn = document.createElement('div');
                        nodeBtn.className = 'config-node-item';
                        nodeBtn.innerText = nodeName;
                        // ğŸŒŸ è§†è§‰åŒºåˆ†ï¼šç§æœ‰èŠ‚ç‚¹å¸¦ç´«è‰²è¾¹æ¡†
                        nodeBtn.style.border = '1px solid var(--purple)';
                        nodeBtn.style.color = 'var(--purple)';
                        nodeBtn.style.position = 'relative';

                        // å¢åŠ ä¸€ä¸ªå°è§’æ ‡è¡¨ç¤ºç§æœ‰
                        const badge = document.createElement('span');
                        badge.innerText = 'ç§';
                        badge.style.cssText = 'position:absolute; top:2px; right:2px; font-size:8px; background:var(--purple); color:white; padding:1px 3px; border-radius:4px;';
                        nodeBtn.appendChild(badge);

                        nodeBtn.onclick = () => openNodeDetailEditor(nodeName);
                        grid.appendChild(nodeBtn);
                    });
                }
                // ğŸŒŸ æ–°å¢å‡½æ•°ï¼šåˆ†é—¨åˆ«ç±»æ–°å»ºç§æœ‰èŠ‚ç‚¹
                function createNewNodeDefinition(categoryName) {
                    const name = prompt(`è¦åœ¨ã€${categoryName}ã€‘ä¸‹æ–°å»ºä»€ä¹ˆèŠ‚ç‚¹ï¼Ÿ`);
                    if (!name) return;

                    // æ£€æŸ¥é‡å
                    if (GLOBAL_CONFIG[name] || DEFAULT_CONFIG[name]) {
                        return alert("è¯¥èŠ‚ç‚¹åç§°å·²å­˜åœ¨ï¼");
                    }

                    // 1. åˆå§‹åŒ–èŠ‚ç‚¹å­—æ®µé…ç½® (é»˜è®¤ç»™ä¸¤ä¸ªé€šç”¨å­—æ®µ)
                    GLOBAL_CONFIG[name] = [
                        { key: "finishDate", label: "å®Œæˆæ—¶é—´", type: "date" },
                        { key: "remark", label: "å¤‡æ³¨", type: "text" }
                    ];

                    // 2. è®°å½•åˆ°ç§æœ‰æ˜ å°„è¡¨ (Keyæ˜¯åˆ†ç±»å, Valueæ˜¯èŠ‚ç‚¹æ•°ç»„)
                    // ç»“æ„ç¤ºä¾‹: { "é¡¹ç›®å‰æœŸæ‰‹ç»­": ["æ–‡ç‰©å®¡æ‰¹", "ç»¿åŒ–è¿ç§»"], "é‡‡è´­æ‰‹ç»­": [] }
                    if (!GLOBAL_CONFIG._customNodeMap) GLOBAL_CONFIG._customNodeMap = {};
                    if (!GLOBAL_CONFIG._customNodeMap[categoryName]) GLOBAL_CONFIG._customNodeMap[categoryName] = [];

                    GLOBAL_CONFIG._customNodeMap[categoryName].push(name);

                    // 3. ä¿å­˜å¹¶åˆ·æ–°
                    localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                    debouncedSync();
                    renderConfigContainer(); // åˆ·æ–°ç•Œé¢ï¼Œä½ å°±èƒ½çœ‹åˆ°æ–°åŠ çš„æŒ‰é’®äº†

                    // 4. è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘çª—å£ï¼Œæ–¹ä¾¿ç«‹åˆ»åŠ å­—æ®µ
                    openNodeDetailEditor(name);
                }
                // 4. æ¸²æŸ“ã€+ è‡ªå®šä¹‰æ–°å¢ã€‘æŒ‰é’® (å°±åœ¨å½“å‰åˆ†ç±»é‡Œ)
                const addBtn = document.createElement('div');
                addBtn.className = 'config-node-item';
                addBtn.style.border = '1px dashed #999';
                addBtn.style.color = '#999';
                addBtn.style.fontSize = '12px';
                addBtn.innerHTML = '+ è‡ªå®šä¹‰<br>æ–°å¢';
                // ğŸŒŸ å…³é”®ï¼šç‚¹å‡»æ—¶æŠŠå½“å‰åˆ†ç±»å cat ä¼ è¿›å»
                addBtn.onclick = () => createNewNodeDefinition(cat);
                grid.appendChild(addBtn);

                container.appendChild(grid);
            });
        }

        let currentEditingNodeName = null;
        function openNodeDetailEditor(nodeName) {
            currentEditingNodeName = nodeName;
            if (!GLOBAL_CONFIG[nodeName]) {
                GLOBAL_CONFIG[nodeName] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[nodeName] || []));
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            }
            const config = GLOBAL_CONFIG[nodeName] || [];
            const modal = document.getElementById('nodeDetailModal');
            document.getElementById('nodeDetailTitle').innerText = nodeName;
            const fieldList = document.getElementById('nodeFieldList');
            fieldList.innerHTML = '';
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) {
                    optionsStr = `<br><span class="node-field-type">é€‰é¡¹: ${field.options.join(', ')}</span>`;
                }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">å­—æ®µ: ${field.key} | ç±»å‹: ${field.type}${optionsStr}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); deleteConfigField('${nodeName}', ${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                fieldList.appendChild(item);
            });
            modal.classList.add('open');
        }

        function closeNodeDetailEditor() {
            document.getElementById('nodeDetailModal').classList.remove('open');
            currentEditingNodeName = null;
        }

        function saveNodeDetailEditor() {
            loadConfig();
            DB.get();
            debouncedSync();
            closeNodeDetailEditor();
            showToast('âœ… é…ç½®å·²ä¿å­˜');
        }

        function deleteConfigField(nodeName, fieldIdx) {
            if (confirm('ç¡®å®šåˆ é™¤æ­¤å­—æ®µå—ï¼Ÿ')) {
                if (GLOBAL_CONFIG[nodeName]) {
                    GLOBAL_CONFIG[nodeName].splice(fieldIdx, 1);
                    localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                    openNodeDetailEditor(nodeName);
                    debouncedSync();
                }
            }
        }

        function addNewConfigField() {
            const fieldLabel = prompt('è¯·è¾“å…¥å­—æ®µåç§° (ä¾‹å¦‚: å®é™…å¼€å·¥æ—¶é—´):');
            if (!fieldLabel) return;
            const fieldKey = 'custom_' + Date.now();
            const typeInput = prompt('è¯·è¾“å…¥å­—æ®µç±»å‹ç¼–å·:\n1 - æ—¥æœŸ (Date)\n2 - é‡‘é¢/æ•°å­— (Number)\n3 - æ–‡å­— (Text)\n4 - ä¸‹æ‹‰é€‰é¡¹ (Select)', '1');
            let fieldType = 'text';
            let options = [];
            if (typeInput === '1') fieldType = 'date';
            else if (typeInput === '2') fieldType = 'number';
            else if (typeInput === '3') fieldType = 'text';
            else if (typeInput === '4') {
                fieldType = 'select';
                const optStr = prompt('è¯·è¾“å…¥é€‰é¡¹ï¼Œç”¨é€—å·éš”å¼€:', 'åˆæ ¼,ä¸åˆæ ¼');
                if (optStr) options = optStr.split(/[,ï¼Œ]/).map(s => s.trim());
            } else { return; }
            if (!GLOBAL_CONFIG[currentEditingNodeName]) { GLOBAL_CONFIG[currentEditingNodeName] = []; }
            GLOBAL_CONFIG[currentEditingNodeName].push({ key: fieldKey, label: fieldLabel, type: fieldType, options: options });
            localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            openNodeDetailEditor(currentEditingNodeName);
            debouncedSync();
        }

        function renderConfigFields(config) {
            const fieldList = document.getElementById('nodeFieldList');
            if (!fieldList) return;
            fieldList.innerHTML = '';
            if (!config || config.length === 0) { fieldList.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">è¯¥èŠ‚ç‚¹æš‚æ— é…ç½®</div>'; return; }
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) { optionsStr = `<br><span class="node-field-type">é€‰é¡¹: ${field.options.join(', ')}</span>`; }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">å­—æ®µ: ${field.key} | ç±»å‹: ${field.type}${optionsStr}</div></div>`;
                fieldList.appendChild(item);
            });
        }

        function handleConfigSave() {
            if (configMode === 'global') {
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                debouncedSync();
                alert('âœ… å…¨å±€é…ç½®å·²ä¿å­˜');
                closeModal('configModal');
            } else if (configMode === 'local') {
                const list = DB.get();
                const p = list.find(x => x.id === currentProjectId);
                if (p && p.stages[currentStageIndex]) {
                    p.stages[currentStageIndex].config = tempLocalConfig;
                    DB.save(list);
                    alert('âœ… èŠ‚ç‚¹é…ç½®å·²ä¿å­˜');
                    closeModal('configModal');
                    refreshDetail(p);
                }
            }
        }

        function createProject() { const n = document.getElementById('newProjectName').value; if (!n) return alert("è¯·è¾“å…¥åç§°"); DB.save([{ id: Date.now(), name: n, type: document.getElementById('newProjectType').value, createDate: new Date().toLocaleDateString(), stages: [] }, ...DB.get()]); closeModal('createModal'); goToPage('projectList'); }
        function openNodeLibrary() {
            const container = document.getElementById('nodeLibraryGrid');
            container.innerHTML = '';

            // è¯»å–ç§æœ‰æ˜ å°„
            const customMap = GLOBAL_CONFIG._customNodeMap || {};

            Object.keys(NODE_CATEGORIES).forEach(cat => {
                // æ¸²æŸ“åˆ†ç±»å¤´
                const header = document.createElement('div');
                header.style.cssText = "grid-column: 1 / -1; font-size: 13px; font-weight: bold; color: #888; margin: 15px 0 5px 0; padding-left: 5px; border-left: 3px solid var(--primary);";
                header.innerText = cat;
                container.appendChild(header);

                // 1. å…ˆåˆ—å‡ºå…¬å…±èŠ‚ç‚¹
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const btn = document.createElement('div');
                    btn.className = 'node-option';
                    btn.innerText = '+ ' + nodeName;
                    btn.onclick = () => addStage(nodeName);
                    container.appendChild(btn);
                });

                // 2. ğŸŒŸ ç´§æ¥ç€åˆ—å‡ºè¯¥åˆ†ç±»ä¸‹çš„ã€ç§æœ‰èŠ‚ç‚¹ã€‘
                if (customMap[cat] && Array.isArray(customMap[cat])) {
                    customMap[cat].forEach(nodeName => {
                        const btn = document.createElement('div');
                        btn.className = 'node-option';
                        btn.innerText = '+ ' + nodeName;
                        // æ ·å¼åŒºåˆ†ï¼šç´«è‰²æ–‡å­—
                        btn.style.color = 'var(--purple)';
                        btn.style.borderColor = 'var(--purple)';
                        btn.onclick = () => addStage(nodeName);
                        container.appendChild(btn);
                    });
                }
            });

            openModal('nodeLibraryModal');
        }

        function addStage(nodeName) {
            if (!currentProjectId) return alert('è¯·å…ˆåœ¨å·¥ç¨‹è¯¦æƒ…é¡µæ‰“å¼€è¦æ·»åŠ èŠ‚ç‚¹çš„å·¥ç¨‹ã€‚');
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('æœªæ‰¾åˆ°å½“å‰å·¥ç¨‹');
            const sourceCfg = (typeof GLOBAL_CONFIG === 'object' && GLOBAL_CONFIG[nodeName]) ? GLOBAL_CONFIG[nodeName] : (DEFAULT_CONFIG[nodeName] || []);
            const cfg = JSON.parse(JSON.stringify(sourceCfg));
            const newStage = { name: nodeName, status: 'waiting', config: cfg, data: {} };
            p.stages.push(newStage);
            DB.save(list);
            closeModal('nodeLibraryModal');
            refreshDetail(p);
        }

        function openDetail(id) {
            currentProjectId = id;
            const p = DB.get().find(x => x.id == id);
            // ğŸŒŸ æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°è¯¦æƒ…é¡µé¡¶éƒ¨å¯¼èˆªæ•°æ®
            document.getElementById('navDetailTitle').innerText = p.name;
            const typeMap = { 'special': 'ä¸“é¡¹å·¥ç¨‹', 'odd': 'é›¶æ˜Ÿå·¥ç¨‹', 'repair': 'æŠ¢ä¿®å·¥ç¨‹' };
            document.getElementById('navDetailType').innerText = typeMap[p.type];
            goToPage('projectDetail');
            refreshDetail(p);
        }

        function refreshDetail(p) {
            const c = document.getElementById('stagesContainer'); c.innerHTML = '';
            const prev = document.getElementById('previewFlow'); prev.innerHTML = '';
            p.stages.forEach((s, i) => {
                const conf = s.config || [];
                const getDisplayHtml = (mode) => {
                    return conf.map(f => {
                        if (!s.data[f.key]) return '';
                        let displayVal = s.data[f.key];
                        if (f.type === 'number') displayVal = 'Â¥' + displayVal;
                        if (mode === 'preview') return `<div class="preview-kv"><span class="preview-k">${f.label}:</span><span class="preview-v">${displayVal}</span></div>`;
                        return `<div class="data-item"><span class="data-label">${f.label}</span><span class="data-value">${displayVal}</span></div>`;
                    }).join('');
                };
                if (s.status === 'done') { prev.innerHTML += `<div class="preview-item done"><div class="preview-item-title"><span>${s.name}</span></div><div class="preview-data-table">${getDisplayHtml('preview')}</div></div>`; }
                let det = ''; if (s.status !== 'waiting') { det = '<div class="data-grid">' + getDisplayHtml('card') + '</div>'; }
                const ico = s.status === 'done' ? 'âœ…' : (s.status === 'processing' ? 'ğŸ”¥' : 'â³');
                c.innerHTML += `<div class="stage-card ${s.status}"><div class="node-sort-zone"><button class="node-sort-btn" onclick="moveStageUp(${i})">â†‘</button><button class="node-sort-btn" onclick="moveStageDown(${i})">â†“</button></div><div class="card-content" onclick="openStageEdit(${i})"><div class="card-actions-fixed"><button class="icon-btn-card btn-edit-struct" onclick="event.stopPropagation();openConfigModal('local', ${i})">âš™ï¸</button><button class="btn-delete-icon" style="margin-left:0;" onclick="event.stopPropagation();deleteStage(${i})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="status-bar ${s.status}"></div><div class="card-header-row"><span class="card-title">${s.name}</span><span class="card-status-text">${ico}</span></div>${det}</div></div>`;
            });
        }

        function moveStageUp(i) {
            if (i === 0) return;
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            const temp = p.stages[i]; p.stages[i] = p.stages[i - 1]; p.stages[i - 1] = temp;
            DB.save(list); refreshDetail(p);
        }
        function moveStageDown(i) {
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            if (i === p.stages.length - 1) return;
            const temp = p.stages[i]; p.stages[i] = p.stages[i + 1]; p.stages[i + 1] = temp;
            DB.save(list); refreshDetail(p);
        }

        function openStageEdit(i) {
            if (!currentProjectId) return alert('è¯·å…ˆæ‰“å¼€å·¥ç¨‹è¯¦æƒ…å†ç¼–è¾‘èŠ‚ç‚¹');
            currentStageIndex = i;
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('æœªæ‰¾åˆ°å·¥ç¨‹');
            const stage = p.stages[i];
            document.getElementById('formTitle').innerText = `${stage.name} â€” å½•å…¥`;
            const container = document.getElementById('dynamicFormContainer');
            container.innerHTML = '';
            const cfg = stage.config || [];
            if (!cfg.length) { container.innerHTML = '<div style="color:#666;font-size:13px">è¯¥èŠ‚ç‚¹æ— å¯å½•å…¥å­—æ®µã€‚</div>'; openModal('dynamicFormModal'); return; }
            cfg.forEach(f => {
                const wrap = document.createElement('div');
                wrap.style.marginBottom = '10px';
                const lbl = document.createElement('div');
                lbl.style.fontSize = '13px'; lbl.style.marginBottom = '4px'; lbl.innerText = f.label;
                wrap.appendChild(lbl);
                let inputEl;
                const curVal = (stage.data && stage.data[f.key]) ? stage.data[f.key] : '';
                if (f.type === 'select') {
                    inputEl = document.createElement('select');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    (f.options || []).forEach(opt => { const o = document.createElement('option'); o.value = opt; o.innerText = opt; if (opt === curVal) o.selected = true; inputEl.appendChild(o); });
                } else {
                    inputEl = document.createElement('input');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    if (f.type === 'date') { inputEl.type = 'date'; inputEl.max = '2099-12-31'; inputEl.oninput = function () { if (this.value.length > 10) this.value = this.value.slice(0, 10); }; }
                    else if (f.type === 'number') inputEl.type = 'number';
                    else inputEl.type = 'text';
                    inputEl.value = curVal;
                }
                wrap.appendChild(inputEl);
                container.appendChild(wrap);
            });
            openModal('dynamicFormModal');
        }

        function editProjectName() {
            const p = DB.get().find(x => x.id === currentProjectId);
            const newName = prompt("ä¿®æ”¹å·¥ç¨‹åç§°:", p.name);
            if (newName && newName !== p.name) {
                const list = DB.get();
                list.find(x => x.id === currentProjectId).name = newName;
                DB.save(list);
                // æ›´æ–°é¡¶éƒ¨æ ‡é¢˜
                document.getElementById('navDetailTitle').innerText = newName;
            }
        }

        function saveDynamicData() {
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            const stage = p.stages[currentStageIndex];
            let nd = {}; let full = true;
            stage.config.forEach(f => {
                const el = document.getElementById(`f_${f.key}`);
                if (el) { nd[f.key] = el.value; if (el.value === '') full = false; }
            });
            stage.data = { ...stage.data, ...nd };
            stage.status = Object.values(nd).some(v => v) ? (full ? 'done' : 'processing') : 'waiting';
            DB.save(list); closeModal('dynamicFormModal'); refreshDetail(p);
        }
        function deleteStage(i) { if (confirm("åˆ èŠ‚ç‚¹ï¼Ÿ")) { const l = DB.get(); const p = l.find(x => x.id == currentProjectId); p.stages.splice(i, 1); DB.save(l); refreshDetail(p); } }

        function renderProjects() {
            const list = DB.get();
            const cs = document.getElementById('container_special');
            const co = document.getElementById('container_odd');
            const cr = document.getElementById('container_repair');
            cs.innerHTML = ''; co.innerHTML = ''; cr.innerHTML = '';
            let c1 = 0, c2 = 0, c3 = 0;
            list.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div class="list-item-content" onclick="openDetail(${p.id})"><div style="display:flex; flex-direction:column; overflow:hidden;"><div class="list-item-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.name}</div><div class="list-item-date">${p.createDate}</div></div><button class="btn-delete-icon" onclick="deleteProject(event, ${p.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="list-sort-zone"><button class="sort-btn up" onclick="moveProjUp(${i}, '${p.type}')">â†‘</button><button class="sort-btn down" onclick="moveProjDown(${i}, '${p.type}')">â†“</button></div>`;
                if (p.type === 'special') { cs.appendChild(d); c1++; } else if (p.type === 'odd') { co.appendChild(d); c2++; } else { cr.appendChild(d); c3++; }
            });
            document.getElementById('c_s').innerText = c1; document.getElementById('c_o').innerText = c2; document.getElementById('c_r').innerText = c3;
        }

        function deleteProject(e, id) {
            e.stopPropagation();
            if (confirm('âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤è¿™ä¸ªå·¥ç¨‹å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                let list = DB.get(); list = list.filter(p => p.id !== id);
                DB.save(list); renderProjects();
            }
        }
        function moveProjUp(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i - 1; k >= 0; k--) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }
        function moveProjDown(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i + 1; k < list.length; k++) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }

        function exportData() { const d = { v: "44.0", d: new Date(), p: DB.get(), c: GLOBAL_CONFIG, ot: DB_OT.get(), todo: DB_TODO.get(), cal: DB_CAL.get() }; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], { type: "json" })); a.download = `backup_${Date.now()}.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importData(i) {
            if (!i.files || !i.files[0]) return alert("âŒ æ²¡é€‰æ–‡ä»¶ï¼");
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    alert("ğŸ” æ­£åœ¨è§£æå¹¶å»é‡...");
                    const b = JSON.parse(e.target.result);
                    const impP = b.p || b.projects || []; const impConf = b.c || b.config || {}; const impOt = b.ot || b.attendance || {}; const impTodo = b.todo || []; const impCal = b.cal || b.calendar || {};
                    const currP = JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]');
                    const currConf = JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}');
                    const currOt = JSON.parse(localStorage.getItem(DB_KEY_OT) || '{"records":[], "leaveRecords":[]}');
                    const projectMap = new Map(); currP.forEach(p => projectMap.set(p.id, p)); impP.forEach(p => projectMap.set(p.id, p));
                    const mergedProjects = Array.from(projectMap.values());
                    const mergedOt = { annual: currOt.annual || impOt.annual, saved: currOt.saved || impOt.saved, records: [...(currOt.records || []), ...(impOt.records || [])], leaveRecords: [...(currOt.leaveRecords || []), ...(impOt.leaveRecords || [])] };
                    const mergedTodo = [...(JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]')), ...impTodo];
                    const mergedCal = { ...impCal, ...JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}') };
                    const mergedConfig = { ...impConf, ...currConf };
                    localStorage.setItem(DB_KEY_DATA, JSON.stringify(mergedProjects)); localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(mergedConfig)); localStorage.setItem(DB_KEY_OT, JSON.stringify(mergedOt)); localStorage.setItem(DB_KEY_TODO, JSON.stringify(mergedTodo)); localStorage.setItem(DB_KEY_CAL, JSON.stringify(mergedCal));
                    if (currentUser) {
                        const payload = { projects: mergedProjects, config: mergedConfig, attendance: mergedOt, todo: mergedTodo, calendar: mergedCal, updated_at: new Date().toISOString() };
                        await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                    }
                    alert(`âœ… å¯¼å…¥å®Œæˆï¼`); location.reload();
                } catch (err) { alert("ğŸ’¥ å‡ºé”™: " + err.message); }
            };
            r.readAsText(i.files[0]); i.value = '';
        }

        function calcDateDiff() {
            const d1 = document.getElementById('toolStartDate').value;
            const d2 = document.getElementById('toolEndDate').value;
            const resBox = document.getElementById('dateResult');
            if (!d1 || !d2) { alert("è¯·å…ˆé€‰æ‹©ä¸¤ä¸ªæ—¥æœŸï¼"); return; }
            const diffTime = Math.abs(new Date(d2) - new Date(d1));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            resBox.style.display = 'block'; resBox.innerText = `ç›¸å·® ${diffDays} å¤©`;
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        // ğŸŒŸ è¡¥å……ï¼šæ¸²æŸ“å‚å»ºå•ä½
        function renderServices() {
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            const container = document.getElementById('servicesListContainer');
            const emptyHint = document.getElementById('emptyServicesHint');

            container.innerHTML = '';

            if (!p.services) p.services = [];
            if (p.services.length === 0) {
                emptyHint.style.display = 'block';
                return;
            } else {
                emptyHint.style.display = 'none';
            }

            p.services.forEach((svc, idx) => {
                const div = document.createElement('div');
                div.className = 'service-card';
                // æ¨¡æ‹Ÿè¿›åº¦æ¡
                const mockProgress = Math.floor(Math.random() * 50) + 30;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span class="service-type-tag">${svc.type}</span>
                        <button class="btn-delete-icon" onclick="deleteService(${idx})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    <div class="service-name">${svc.name}</div>
                    <div class="service-row">
                        <span>ğŸ’° åˆåŒé¢: Â¥${Number(svc.amount).toLocaleString()}</span>
                        <span>ğŸ‘¤ ${svc.contact || 'æ— è”ç³»äºº'}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width: ${mockProgress}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function saveService() {
            const type = document.getElementById('svcType').value;
            const name = document.getElementById('svcName').value;
            const amount = document.getElementById('svcAmount').value;
            const contact = document.getElementById('svcContact').value;
            if (!name) return alert('è¯·è¾“å…¥å•ä½åç§°');
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            if (!p.services) p.services = [];
            p.services.push({ type, name, amount, contact });
            DB.save(list);
            closeModal('addServiceModal');
            renderServices();
            document.getElementById('svcName').value = '';
            document.getElementById('svcAmount').value = '';
            document.getElementById('svcContact').value = '';
        }
        function deleteService(idx) {
            if (!confirm('ç¡®å®šç§»é™¤è¯¥å‚å»ºå•ä½å—ï¼Ÿ')) return;
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            p.services.splice(idx, 1);
            DB.save(list);
            renderServices();
        }
        function switchDetailTab(tabName) {
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`seg_${tabName}`).classList.add('active');
            document.getElementById('view_timeline').style.display = (tabName === 'timeline') ? 'block' : 'none';
            document.getElementById('view_services').style.display = (tabName === 'services') ? 'block' : 'none';
            if (tabName === 'services') { renderServices(); }
        }


        // --- ğŸ‘® ç®¡ç†å‘˜åŠŸèƒ½ (ä¿®å¤ç‰ˆ) ---

        async function openAdminPanel() {
            openModal('adminModal');
            document.getElementById('adminUserList').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">æ­£åœ¨åŠ è½½æ•°æ®...</td></tr>';

            // 1. ä¿®å¤ç‚¹ï¼šå»æ‰ 'updated_at'ï¼ŒåªæŸ¥è¯¢å­˜åœ¨çš„åˆ—
            const { data, error } = await _supabase
                .from('user_data')
                .select('user_id, content');

            if (error) {
                // å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œæˆ–è€…è¡¨åä¸å¯¹
                alert("åŠ è½½å¤±è´¥: " + error.message);
                return;
            }

            document.getElementById('adminTotalCount').innerText = data.length;
            const tbody = document.getElementById('adminUserList');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                return;
            }

            data.forEach(row => {
                // 2. å°è¯•è§£æ ID (åªæ˜¾ç¤ºå‰8ä½)
                let displayName = row.user_id.slice(0, 8) + '...';

                // 3. ä¿®å¤ç‚¹ï¼šä» content (JSON) å†…éƒ¨è¯»å–æ—¶é—´
                let dateStr = 'æœªçŸ¥æ—¶é—´';
                if (row.content && row.content.updated_at) {
                    dateStr = new Date(row.content.updated_at).toLocaleString();
                } else if (row.content && row.content.d) {
                    // å…¼å®¹æ—§æ•°æ®çš„å¯¼å‡ºæ—¶é—´å­—æ®µ
                    dateStr = new Date(row.content.d).toLocaleString();
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="font-family:monospace; color:#333;">${displayName}</span></td>
                    <td style="font-size:11px; color:#666;">${dateStr}</td>
                    <td>
                        <button class="btn-del-user" onclick="adminDeleteUser('${row.user_id}')">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function adminDeleteUser(targetUserId) {
            if (!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰äº‘ç«¯æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            const { error } = await _supabase
                .from('user_data')
                .delete()
                .eq('user_id', targetUserId);

            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } else {
                alert('âœ… æ•°æ®å·²åˆ é™¤');
                openAdminPanel(); // åˆ·æ–°åˆ—è¡¨
            }
        }
        // ğŸ‘¤ æ‰“å¼€ä¸ªäººä¸­å¿ƒ
        function openPersonalCenter() {
            if (!currentUser) return;

            // 1. å¡«å…¥é‚®ç®±
            document.getElementById('centerEmail').innerText = currentUser.email;

            // 2. é¡ºä¾¿ç»Ÿè®¡ä¸€ä¸‹æ•°æ®ï¼ˆæ˜¾å¾—é«˜çº§ï¼‰
            const projs = JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]');
            const todos = JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]');

            document.getElementById('centerProjCount').innerText = projs.length;
            document.getElementById('centerTodoCount').innerText = todos.length;

            // 3. æ‰“å¼€å¼¹çª—
            openModal('personalCenterModal');
        }

        // --- ğŸ”™ æ ¸å¿ƒä¿®å¤ï¼šæ¥ç®¡æµè§ˆå™¨è¿”å›é”® & æ»‘åŠ¨è¿”å› ---

        // 1. ç›‘å¬æµè§ˆå™¨çš„â€œåé€€â€åŠ¨ä½œ (åŒ…æ‹¬è¾¹ç¼˜æ»‘åŠ¨ã€ç‰©ç†è¿”å›é”®)
        window.addEventListener('popstate', function (event) {
            // å¦‚æœ history çŠ¶æ€é‡Œæ²¡æœ‰ IDï¼Œè¯´æ˜å›åˆ°äº†åŸç‚¹ï¼ˆé¦–é¡µï¼‰
            const state = event.state;

            if (state && state.pageId) {
                // å¦‚æœå†å²è®°å½•é‡Œæœ‰é¡µé¢IDï¼Œå°±è·³è¿‡å»ï¼ˆæ¯”å¦‚å‰è¿›æ—¶ï¼‰
                // è¿™é‡Œæˆ‘ä»¬é€šå¸¸åªéœ€è¦å¤„ç†â€œå›é€€â€åˆ°é¦–é¡µçš„æƒ…å†µ
                // ä½†ä¸ºäº†ä¿é™©ï¼Œè¿˜æ˜¯ç•™ç€
                showPageSimple(state.pageId);
            } else {
                // å¦‚æœæ²¡æœ‰çŠ¶æ€äº†ï¼Œè¯´æ˜é€€åˆ°äº†æœ€å¼€å§‹ï¼Œå¼ºåˆ¶å›é¦–é¡µ
                goHomeSimple();
            }
        });

        // 2. æ”¹é€ é¡µé¢è·³è½¬å‡½æ•°ï¼šæ¯æ¬¡è·³è½¬éƒ½â€œè™šæ„â€ä¸€æ¡å†å²è®°å½•
        // âš ï¸ æ³¨æ„ï¼šè¯·ç”¨è¿™ä¸ªæ›¿æ¢ä»£ç é‡ŒåŸæœ¬çš„ goToPage å‡½æ•°ï¼Œæˆ–è€…è¦†ç›–å®ƒ
        const originalGoToPage = window.goToPage; // å¤‡ä»½ä¸€ä¸‹æ—§é€»è¾‘å¦‚æœæœ‰çš„è¯

        window.goToPage = function (id) {
            // å…ˆæ‰§è¡ŒåŸæœ¬çš„ UI åˆ‡æ¢é€»è¾‘
            showPageSimple(id);

            // ğŸ“ å…³é”®ï¼šå¾€æµè§ˆå™¨å†å²é‡Œå¡ä¸€æ¡è®°å½•
            // è¿™æ ·æµè§ˆå™¨è§‰å¾—å¦‚æœä½ æ»‘å›å»ï¼Œå°±æ˜¯æ’¤é”€è¿™æ¡è®°å½•ï¼Œè€Œä¸æ˜¯å…³é—­ç½‘é¡µ
            history.pushState({ pageId: id }, null, "#" + id);
        };

        // 3. æ”¹é€ å›é¦–é¡µå‡½æ•°
        window.goHome = function () {
            // å¦‚æœå½“å‰æœ‰å†å²è®°å½•ï¼ˆä¸æ˜¯é¦–é¡µï¼‰ï¼Œå°±é€šè¿‡ history.back() è¿”å›
            // è¿™æ ·å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·çš„â€œç‚¹å‡»è¿”å›â€æ“ä½œ
            if (history.state && history.state.pageId) {
                history.back();
            } else {
                goHomeSimple();
            }
        };

        // --- å†…éƒ¨å·¥å…·ï¼šçº¯ç²¹çš„æ˜¾ç¤ºéšè—ï¼Œä¸æ“ä½œå†å²è®°å½• ---
        function showPageSimple(id) {
            // 1. éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // 2. æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const target = document.getElementById(id);
            if (target) target.classList.add('active');

            // 3. å¤„ç†å¯¼èˆªæ æ˜¾ç¤º
            if (id === 'projectDetail') {
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';

                // é¦–é¡µç‰¹æ®Šå¤„ç†
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                document.getElementById('globalPageTitle').innerText = isHome ? 'å·¥ä½œåŠ©æ‰‹' : '';
            }

            // 4. è§¦å‘é¡µé¢ç‰¹å®šçš„æ¸²æŸ“é€»è¾‘
            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        // --- å†…éƒ¨å·¥å…·ï¼šçº¯ç²¹å›é¦–é¡µ UI ---
        function goHomeSimple() {
            showPageSimple('homePage');
        }

        // åˆå§‹åŒ–ï¼šåˆšæ‰“å¼€ç½‘é¡µæ—¶ï¼ŒæŠŠé¦–é¡µæ›¿æ¢ä¸ºå½“å‰çŠ¶æ€ï¼Œé˜²æ­¢ä¹±è·‘
        history.replaceState({ pageId: 'homePage' }, null, "#home");

    </script>
    <div id="personalCenterModal" class="modal">
        <div class="modal-content" style="max-width: 320px; text-align: center;">
            <h3 style="margin-bottom: 5px;">ä¸ªäººä¸­å¿ƒ</h3>

            <div style="font-size: 48px; margin: 15px 0;">ğŸ¤ </div>

            <div style="color: #666; font-size: 13px;">å½“å‰ç™»å½•è´¦å·</div>
            <div id="centerEmail"
                style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 25px; word-break: break-all;">
                loading...
            </div>

            <div
                style="display: flex; justify-content: space-around; margin-bottom: 25px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <div>
                    <div style="font-size: 12px; color: #999;">é¡¹ç›®æ•°</div>
                    <div style="font-size: 16px; font-weight: bold;" id="centerProjCount">0</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #999;">å¾…åŠæ•°</div>
                    <div style="font-size: 16px; font-weight: bold;" id="centerTodoCount">0</div>
                </div>
            </div>

            <button class="btn-primary" style="background: #FF3B30; margin-bottom: 10px;"
                onclick="logout()">é€€å‡ºç™»å½•</button>
            <button class="btn-cancel" onclick="closeModal('personalCenterModal')">å…³é—­</button>
        </div>
    </div>
</body>

</html>