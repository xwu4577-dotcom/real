<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â∑•‰ΩúÂä©Êâã</title>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

        <title>Â∑•‰ΩúÂä©Êâã</title>

        <link rel="preload" href="icon.png" as="image">

        <meta name="theme-color" content="#ffffff">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Â∑•‰ΩúÂä©Êâã">

        <link rel="manifest" href="manifest.json">
        <link rel="apple-touch-icon" href="icon.png?v=3">
        <link rel="icon" type="image/png" href="icon.png?v=3">

        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <style>
            /* --- Âü∫Á°ÄÂèòÈáè --- */
            :root {
                --primary: #007AFF;
                --bg: #F5F7FA;
                --white: #FFFFFF;
                --green: #34C759;
                --orange: #FF9500;
                --purple: #5856D6;
                --text: #333;
                --border: #E5E5EA;
                --red: #FF3B30;
                --gray: #8E8E93;
            }

            /* Ê†∏ÂøÉÂ∏ÉÂ±Ä */

            /* üëá 1. ÊõøÊç¢ body Ê†∑ÂºèÔºöÂä†‰∏ä html Ê†áÁ≠æÔºåÂΩªÂ∫ïÈîÅÊ≠ªÊ©°ÁöÆÁ≠ãÊïàÊûú */
            html,
            body {
                width: 100%;
                height: 100%;
                overflow: hidden;
                /* üíÄ ÂÖ≥ÈîÆÔºöÁ¶ÅÊ≠¢Êï¥‰∏™ÊµèËßàÂô®Á™óÂè£ÊªöÂä® */
                margin: 0;
                padding: 0;
                position: fixed;
                /* üíÄ ÂÖ≥ÈîÆÔºöÂÉèÈíâÂ≠ê‰∏ÄÊ†∑ÈíâÂú®Â±èÂπï‰∏ä */
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: var(--bg);
                color: var(--text);
                display: flex;
                flex-direction: column;
                /* ÂûÇÁõ¥Â∏ÉÂ±Ä */
                -webkit-tap-highlight-color: transparent;
            }

            * {
                box-sizing: border-box;
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* üëá 2. ÊõøÊç¢ÂØºËà™Ê†èÊ†∑ÂºèÔºöÈò≤Ê≠¢Ë¢´Êå§Âéã */
            .navbar-common {
                background: var(--white);
                color: var(--text);
                height: 44px;
                /* üîí È´òÂ∫¶ÂÜôÊ≠ª */
                min-height: 44px;
                /* üîí ÊúÄÂ∞èÈ´òÂ∫¶ÂÜôÊ≠ª */
                padding: 0 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);

                flex-shrink: 0;
                /* üíÄ ÂÖ≥ÈîÆÔºöÁ¶ÅÊ≠¢Ë¢´ÂÜÖÂÆπÊå§ÊâÅ */
                position: relative;
                z-index: 999;
                /* ‰øùËØÅÂú®ÊúÄ‰∏äÂ±Ç */
                width: 100%;
            }

            .nav-left {
                display: flex;
                align-items: center;
                gap: 0;
                height: 100%;
                flex: 1;
                min-width: 0;
            }

            .nav-right {
                display: flex;
                align-items: center;
                gap: 10px;
                height: 100%;
            }

            /* ËøîÂõûÊåâÈíÆ (iOSÈ£éÊ†º) */
            .nav-back-btn {
                background: transparent;
                border: none;
                color: var(--primary);
                font-size: 17px;
                font-weight: 400;
                padding: 0;
                margin: 0;
                margin-right: 2px;
                cursor: pointer;
                display: flex;
                align-items: center;
                height: 100%;
            }

            .nav-back-btn svg {
                width: 26px;
                height: 26px;
                fill: none;
                stroke: currentColor;
                stroke-width: 2.5;
                stroke-linecap: round;
                stroke-linejoin: round;
                margin-left: -8px;
                margin-top: -1px;
            }

            .nav-back-btn:active {
                opacity: 0.5;
            }

            /* È°µÈù¢Ê†áÈ¢ò */
            .page-title {
                font-size: 17px;
                font-weight: 700;
                color: #000;
                margin: 0;
                line-height: 44px;
                margin-left: -4px;
                /* ÂæÆË∞É‰∏éÁÆ≠Â§¥ÁöÑË∑ùÁ¶ª */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* ËØ¶ÊÉÖÈ°µ‰∏ìÁî®Ê†áÈ¢òÊ°Ü (ÂûÇÁõ¥Â±Ö‰∏≠) */
            .detail-header-center {
                position: absolute;
                left: 80px;
                right: 80px;
                top: 0;
                bottom: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                pointer-events: none;
                /* Èò≤Ê≠¢ÈÅÆÊå°ÁÇπÂáª */
            }

            .detail-title-row {
                display: flex;
                align-items: center;
                pointer-events: auto;
            }

            .detail-main-title {
                font-size: 17px;
                font-weight: 600;
                color: #000;
                line-height: 1.2;
            }

            .detail-sub-title {
                font-size: 10px;
                color: #999;
                margin-top: 1px;
                line-height: 1;
            }

            /* ÈÖçÁΩÆÊåâÈíÆ */
            /* üåü ÊõøÊç¢ÔºöÈÖçÁΩÆÊåâÈíÆ & Âè≥‰æßÈÄöÁî®ÊåâÈíÆÊ†∑Âºè */
            .nav-btn-right {
                background: transparent;
                border: none;
                color: var(--primary);
                padding: 0 10px 0 0;
                font-size: 16px;
                cursor: pointer;
                font-weight: 400;
                display: flex;
                align-items: center;
                gap: 4px;
                height: 100%;
            }

            /* ÂÖºÂÆπÊóßIDÔºåÈò≤Ê≠¢JSÊä•Èîô */
            #nodeConfigBtn {
                display: none;
            }

            /* üëá 3. ÊõøÊç¢ÂÜÖÂÆπÂÆπÂô®Ê†∑ÂºèÔºöÂè™ÊúâËøôÈáåËÉΩÊªöÂä® */
            .page-container {
                flex: 1;
                /* Èú∏Âç†Ââ©‰ΩôÊâÄÊúâÁ©∫Èó¥ */
                overflow-y: auto;
                /* ÂÖÅËÆ∏ÂÜÖÈÉ®‰∏ä‰∏ãÊªöÂä® */
                overflow-x: hidden;
                width: 100%;
                padding: 15px;
                padding-bottom: 80px;
                position: relative;

                /* iOS ‰∏ùÊªëÊªöÂä®‰ΩìÈ™å */
                -webkit-overflow-scrolling: touch;
            }

            .page {
                display: none;
            }

            .page.active {
                display: block;
                animation: fadeIn 0.2s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* --- ‰∏öÂä°Ê†∑Âºè (‰øùÊåÅ‰∏çÂèò) --- */
            .segmented-control {
                display: flex;
                background: #eeeff1;
                border-radius: 9px;
                padding: 2px;
                margin-bottom: 15px;
            }

            .segment-btn {
                flex: 1;
                border: none;
                background: transparent;
                padding: 6px 0;
                font-size: 13px;
                font-weight: 500;
                border-radius: 7px;
                color: #666;
                cursor: pointer;
                transition: all 0.2s;
            }

            .segment-btn.active {
                background: #fff;
                color: #000;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                font-weight: 600;
            }

            .service-card {
                background: white;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                position: relative;
                border-left: 4px solid var(--purple);
            }

            .service-type-tag {
                font-size: 11px;
                background: #f3e5f5;
                color: var(--purple);
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: bold;
                display: inline-block;
                margin-bottom: 5px;
            }

            .service-name {
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 5px;
                color: #333;
            }

            .service-row {
                display: flex;
                justify-content: space-between;
                font-size: 13px;
                color: #666;
                margin-top: 4px;
            }

            .progress-bg {
                height: 6px;
                background: #eee;
                border-radius: 3px;
                margin-top: 8px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: var(--green);
                width: 0%;
                border-radius: 3px;
            }

            /* ÂÖ∂‰ΩôÊ†∑Âºè (ÂæÖÂäû„ÄÅÊó•ÂéÜ„ÄÅËæìÂÖ•Ê°ÜÁ≠â) */
            .fab-add {
                position: fixed;
                bottom: 30px;
                right: 20px;
                width: 56px;
                height: 56px;
                background-color: var(--primary);
                color: white;
                border-radius: 50%;
                border: none;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
                font-size: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 900;
                transition: transform 0.1s;
            }

            .fab-add:active {
                transform: scale(0.95);
                background-color: #0056b3;
            }

            .asset-card-row {
                display: flex;
                flex-direction: column;
                margin-bottom: 20px;
            }

            .asset-card {
                width: 100%;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2);
                position: relative;
                overflow: hidden;
                cursor: pointer;
                transition: transform 0.1s;
                box-sizing: border-box;
            }

            .asset-card.blue {
                background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
                color: white;
            }

            .asset-label {
                font-size: 12px;
                opacity: 0.8;
                margin-bottom: 5px;
            }

            .asset-value {
                font-size: 28px;
                font-weight: 800;
                line-height: 1.1;
            }

            .calendar-section {
                background: white;
                border-radius: 16px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            }

            .cal-header {
                font-weight: bold;
                margin-bottom: 10px;
                font-size: 15px;
                display: flex;
                justify-content: space-between;
            }

            .cal-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
                text-align: center;
            }

            .cal-day {
                font-size: 13px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                color: #333;
                position: relative;
            }

            .cal-day.today {
                background: var(--primary);
                color: white;
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(0, 122, 255, 0.4);
            }

            .cal-day.has-log::after {
                content: '';
                width: 4px;
                height: 4px;
                background: var(--red);
                border-radius: 50%;
                position: absolute;
                bottom: 4px;
            }

            .todo-section {
                margin-bottom: 30px;
            }

            .todo-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .btn-history {
                background: rgba(0, 0, 0, 0.05);
                color: var(--primary);
                padding: 6px 12px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 600;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .todo-input-row {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .todo-input {
                flex: 1;
                border: none;
                background: #fff;
                padding: 12px 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                font-size: 14px;
            }

            .todo-add-btn {
                background: var(--text);
                color: white;
                border: none;
                width: 44px;
                border-radius: 10px;
                font-size: 20px;
                cursor: pointer;
            }

            .todo-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .todo-item {
                background: white;
                padding: 14px 16px;
                border-radius: 12px;
                display: flex;
                align-items: flex-start;
                gap: 12px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
                transition: all 0.2s ease;
                position: relative;
            }

            .todo-checkbox {
                width: 22px;
                height: 22px;
                border-radius: 50%;
                border: 2px solid #ddd;
                cursor: pointer;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .todo-text {
                font-size: 15px;
                line-height: 1.4;
                color: #333;
                flex: 1;
                word-break: break-all;
            }

            .empty-state {
                text-align: center;
                color: #999;
                font-size: 13px;
                padding: 20px 0;
                font-style: italic;
                opacity: 0.6;
            }

            .history-list {
                max-height: 60vh;
                overflow-y: auto;
            }

            .history-item {
                padding: 12px 0;
                border-bottom: 1px solid #eee;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .history-time {
                font-size: 11px;
                color: #bbb;
                margin-top: 2px;
            }

            .btn-restore {
                font-size: 12px;
                color: var(--primary);
                border: 1px solid var(--primary);
                padding: 4px 8px;
                border-radius: 6px;
                background: none;
                cursor: pointer;
            }

            .project-entry-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
                margin-bottom: 30px;
            }

            .entry-card {
                background: white;
                border-radius: 16px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                cursor: pointer;
                border: 1px solid transparent;
                transition: all 0.1s;
            }

            .entry-card.eng {
                border-bottom: 4px solid var(--primary);
            }

            .entry-card.non-eng {
                border-bottom: 4px solid var(--purple);
            }

            .entry-card.tools {
                border-bottom: 4px solid var(--orange);
            }

            .entry-icon {
                font-size: 32px;
                margin-bottom: 10px;
                display: block;
            }

            .entry-title {
                font-weight: 700;
                font-size: 15px;
                color: #333;
                display: block;
            }

            .footer-tools {
                display: flex;
                gap: 10px;
                justify-content: center;
                margin-bottom: 40px;
            }

            .tool-btn {
                font-size: 12px;
                color: #999;
                padding: 8px 15px;
                background: rgba(0, 0, 0, 0.03);
                border-radius: 20px;
                cursor: pointer;
            }

            .ot-summary-card {
                background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
                color: white;
                padding: 25px;
                border-radius: 15px;
                text-align: center;
                margin-bottom: 15px;
            }

            .ot-big-num {
                font-size: 48px;
                font-weight: bold;
                margin: 10px 0;
            }

            .ot-grid {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
                margin-top: 15px;
                background: rgba(255, 255, 255, 0.15);
                padding: 10px;
                border-radius: 10px;
            }

            .ot-label {
                font-size: 12px;
                opacity: 0.9;
            }

            .ot-val {
                font-size: 16px;
                font-weight: bold;
            }

            .ot-settings-mini {
                background: #fff;
                padding: 10px 15px;
                border-radius: 10px;
                display: flex;
                gap: 15px;
                align-items: center;
                font-size: 13px;
                color: #666;
                margin-bottom: 20px;
                border: 1px solid #eee;
            }

            .ot-input-mini {
                width: 60px;
                padding: 4px;
                border: 1px solid #ddd;
                border-radius: 4px;
                text-align: center;
                font-weight: bold;
                color: var(--primary);
            }

            .ot-card {
                background: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                border-left: 4px solid var(--green);
                position: relative;
            }

            .ot-card.used {
                border-left-color: #ccc;
                background: #f9f9f9;
                color: #999;
            }

            .ot-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 5px;
            }

            .ot-date {
                font-weight: bold;
                font-size: 16px;
            }

            .ot-badge {
                background: #e8f5e9;
                color: var(--green);
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
            }

            .ot-card.used .ot-badge {
                background: #eee;
                color: #999;
            }

            .ot-desc {
                font-size: 13px;
                color: #666;
                margin-bottom: 5px;
            }

            .ot-deadline {
                font-size: 12px;
                color: var(--orange);
                margin-top: 5px;
                font-weight: 500;
            }

            .ot-list-item {
                background: white;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .leave-type-tag {
                font-size: 12px;
                padding: 2px 6px;
                border-radius: 4px;
                margin-right: 5px;
                color: white;
            }

            .list-item {
                background: white;
                padding: 0;
                margin-bottom: 10px;
                border-radius: 10px;
                display: flex;
                align-items: stretch;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                overflow: hidden;
            }

            .list-item-content {
                flex: 1;
                padding: 12px 15px;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .list-sort-zone {
                width: 32px;
                background: #fcfcfc;
                border-left: 1px solid #f0f0f0;
                display: flex;
                flex-direction: column;
            }

            .sort-btn {
                flex: 1;
                border: none;
                background: transparent;
                color: #ccc;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: color 0.2s;
            }

            .sort-btn:active {
                color: var(--primary);
                background: #e0e0e0;
            }

            .sort-btn.up {
                border-bottom: 1px solid #eee;
            }

            .list-item-title {
                font-weight: 600;
                font-size: 15px;
                margin-bottom: 4px;
                color: #333;
            }

            .list-item-date {
                font-size: 12px;
                color: #999;
            }

            .project-section-header {
                font-size: 14px;
                font-weight: bold;
                color: #555;
                margin: 15px 0 10px;
                padding-left: 10px;
                border-left: 4px solid var(--primary);
                display: flex;
                justify-content: space-between;
            }

            .home-section-title {
                font-size: 14px;
                font-weight: bold;
                color: #666;
                margin: 25px 0 10px 5px;
                border-left: 3px solid var(--primary);
                padding-left: 8px;
            }

            .stage-card {
                background: white;
                margin-bottom: 15px;
                border-radius: 10px;
                position: relative;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                display: flex;
                overflow: hidden;
            }

            .card-content {
                flex: 1;
                padding: 12px 15px;
                position: relative;
                min-width: 0;
            }

            .status-bar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
            }

            .status-bar.done {
                background: var(--green);
            }

            .status-bar.processing {
                background: var(--orange);
            }

            .status-bar.waiting {
                background: #ddd;
            }

            .card-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                padding-right: 70px;
            }

            .card-title {
                font-weight: bold;
                font-size: 15px;
                color: #333;
            }

            .card-status-text {
                font-size: 12px;
                color: #999;
            }

            .card-actions-fixed {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 8px;
                z-index: 5;
            }

            .icon-btn-card {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
                font-weight: bold;
                background: #f2f2f7;
                color: #555;
            }

            .data-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 6px;
                background: #f9f9f9;
                padding: 8px;
                border-radius: 6px;
                font-size: 13px;
            }

            .data-item {
                display: flex;
                justify-content: space-between;
                border-bottom: 1px dashed #eee;
                padding-bottom: 4px;
            }

            .data-label {
                color: #888;
            }

            .data-value {
                font-weight: 500;
                color: #333;
                text-align: right;
            }

            .preview-section {
                background: white;
                border-radius: 10px;
                padding: 12px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .preview-item.done {
                background: #f0fdf4;
                border-color: #bbf7d0;
                color: #333;
                padding: 8px 10px;
                border-radius: 6px;
                border: 1px solid #eee;
                margin-bottom: 8px;
                font-size: 12px;
            }

            .preview-data-table {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 4px 8px;
                margin-top: 5px;
            }

            .preview-kv {
                display: flex;
                align-items: center;
            }

            .preview-k {
                color: #666;
                margin-right: 6px;
                white-space: nowrap;
            }

            .btn-add-node {
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px 40px;
                border-radius: 30px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                width: 80%;
            }

            .back-btn-float {
                padding: 5px 12px;
                background: #e3f2fd;
                border-radius: 15px;
                color: var(--primary);
                font-size: 13px;
                border: 1px solid rgba(0, 122, 255, 0.1);
                cursor: pointer;
                font-weight: 500;
            }

            .btn-mini {
                padding: 4px 10px;
                border-radius: 15px;
                border: 1px solid #ddd;
                background: white;
                font-size: 12px;
                cursor: pointer;
                color: #555;
            }

            .btn-mini.action {
                border-color: var(--primary);
                color: var(--primary);
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                align-items: center;
                justify-content: center;
                z-index: 999;
                backdrop-filter: blur(2px);
            }

            .modal.open {
                display: flex;
            }

            .modal-content {
                background: white;
                width: 85%;
                max-width: 450px;
                padding: 25px 20px;
                border-radius: 15px;
                max-height: 80vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .form-label {
                display: block;
                font-size: 14px;
                font-weight: bold;
                margin: 12px 0 6px;
                color: #444;
            }

            .input-box {
                width: 100%;
                height: 46px;
                padding: 0 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 15px;
                background: #fafafa;
                color: #333;
                -webkit-appearance: none;
                appearance: none;
                margin: 0;
                display: block;
            }

            select.input-box {
                background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23999999%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 10px;
                padding-right: 30px;
            }

            input[type="date"].input-box {
                display: flex;
                align-items: center;
                line-height: 46px;
            }

            .log-textarea {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-sizing: border-box;
                font-size: 15px;
                background: #fafafa;
                min-height: 100px;
                resize: vertical;
            }

            .btn-primary {
                width: 100%;
                padding: 14px;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                margin-top: 25px;
                cursor: pointer;
                font-weight: 600;
            }

            .btn-cancel {
                width: 100%;
                margin-top: 10px;
                border: none;
                background: transparent;
                color: #999;
                cursor: pointer;
                padding: 10px;
                font-size: 14px;
            }

            .config-container {
                display: flex;
                flex-direction: column;
                max-height: 70vh;
                overflow-y: auto;
                margin-top: 10px;
            }

            .config-category-title {
                background: #f5f5f7;
                border-left: 4px solid var(--primary);
                padding: 12px 15px;
                font-size: 14px;
                font-weight: bold;
                color: #333;
                margin: 15px 0 10px 0;
                width: 100%;
                box-sizing: border-box;
            }

            .config-node-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                padding: 0 10px;
                margin-bottom: 10px;
            }

            .config-node-item {
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 15px 10px;
                text-align: center;
                cursor: pointer;
                font-size: 12px;
                color: #333;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 60px;
            }

            .config-node-item:hover {
                background: #f9f9f9;
                border-color: var(--primary);
                box-shadow: 0 4px 8px rgba(0, 122, 255, 0.1);
            }

            .node-detail-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(2px);
            }

            .node-detail-modal.open {
                display: flex;
            }

            .node-detail-content {
                background: white;
                width: 85%;
                max-width: 500px;
                padding: 25px 20px;
                border-radius: 15px;
                max-height: 80vh;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .node-detail-header {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 20px;
                color: #333;
            }

            .node-field-list {
                flex: 1;
                margin-bottom: 15px;
            }

            .node-field-item {
                background: #f9f9f9;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .node-field-info {
                flex: 1;
            }

            .node-field-name {
                font-weight: bold;
                color: #333;
                margin-bottom: 4px;
            }

            .node-field-type {
                font-size: 12px;
                color: #999;
            }

            .node-sort-zone {
                width: 36px;
                background: #f9f9f9;
                border-right: 1px solid #eee;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .node-sort-btn {
                flex: 1;
                width: 100%;
                border: none;
                background: transparent;
                color: #ccc;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
            }

            .node-sort-btn:active {
                color: var(--primary);
                background: #eee;
            }

            .node-sort-btn:first-child {
                border-bottom: 1px solid #eee;
            }

            .hidden {
                display: none;
            }

            #auth-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(5px);
            }

            /* üåü Ê†∏ÂøÉÔºö‰∏∫ÁôΩÊ°ÜÂ¢ûÂä†Áõ∏ÂØπÂÆö‰Ωç */
            .auth-box {
                position: relative;
                background: white;
                padding: 30px;
                border-radius: 16px;
                width: 85%;
                max-width: 350px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
            }

            /* üåü Ê†∏ÂøÉÔºöËÆ©ÂèâÂè∑Áõ∏ÂØπ‰∫éÁôΩÊ°ÜÁªùÂØπÂÆö‰Ωç */
            .auth-close-btn {
                position: absolute;
                top: 10px;
                right: 15px;
                font-size: 28px;
                color: #ccc;
                cursor: pointer;
                line-height: 1;
                z-index: 10;
                padding: 10px;
                /* Â¢ûÂä†ÊâãÊú∫ÁÇπÂáªÂå∫Âüü */
            }

            .auth-close-btn:hover {
                color: #333;
            }

            .auth-box h2 {
                margin-top: 0;
                color: #1d1d1f;
            }

            .auth-input {
                width: 100%;
                padding: 12px;
                margin: 10px 0;
                border: 1px solid #d2d2d7;
                border-radius: 8px;
                box-sizing: border-box;
                font-size: 16px;
            }

            .auth-btn {
                width: 100%;
                padding: 12px;
                background: #007aff;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                margin-top: 10px;
            }

            .auth-btn:active {
                background: #005bb5;
            }

            .auth-switch {
                margin-top: 15px;
                font-size: 14px;
                color: #007aff;
                cursor: pointer;
                text-decoration: underline;
            }

            .error-msg {
                color: #ff3b30;
                font-size: 14px;
                margin-top: 10px;
                display: none;
            }

            .toast {
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                z-index: 1000;
            }

            .user-badge {
                font-size: 12px;
                color: var(--primary);
                background: #e3f2fd;
                padding: 4px 8px;
                border-radius: 10px;
                cursor: pointer;
            }

            .btn-delete-icon {
                width: 32px;
                height: 32px;
                background: transparent;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                margin-left: 8px;
                flex-shrink: 0;
                opacity: 0.4;
                transition: all 0.2s;
            }

            .btn-delete-icon:active {
                transform: scale(0.9);
                opacity: 1;
            }

            .btn-delete-icon svg {
                width: 18px;
                height: 18px;
                stroke: #999;
                stroke-width: 1.5;
                fill: none;
            }

            .btn-delete-icon:active svg {
                stroke: #FF3B30;
            }

            #toolsPage {
                display: none;
                position: absolute;
                top: 44px;
                /* ‰ªéÂØºËà™Ê†è‰∏ãÊñπÂºÄÂßã */
                left: 0;
                width: 100%;
                height: calc(100% - 44px);
                /* Êâ£Èô§ÂØºËà™Ê†èÈ´òÂ∫¶ */
                background: var(--bg);
                padding: 20px;
                box-sizing: border-box;
                z-index: 50;
            }

            #toolsPage.active {
                display: flex !important;
                flex-direction: column;
                justify-content: flex-start;
            }

            #toolsPage .page-header-row {
                margin-top: 0 !important;
                padding-top: 0;
            }

            .page-header-row {
                display: flex;
                align-items: center;
                padding: 10px 0 20px 0;
                width: 100%;
                border-bottom: 1px solid #f5f5f7;
                margin-bottom: 15px;
                flex-shrink: 0;
            }

            .page-header-title {
                font-size: 18px;
                font-weight: 700;
                margin-left: 15px;
                color: #333;
            }

            .tool-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                align-content: start;
                width: 100%;
            }

            .tool-item {
                background: white;
                border-radius: 16px;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
                cursor: pointer;
                border: 1px solid #f5f5f7;
                height: 90px;
            }

            .tool-item:active {
                transform: scale(0.95);
                background: #fafafa;
            }

            .tool-icon {
                font-size: 32px;
                margin-bottom: 8px;
                line-height: 1;
            }

            .tool-name {
                font-size: 13px;
                font-weight: 500;
                color: #333;
            }

            .node-library-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 12px;
                max-height: 60vh;
                overflow-y: auto;
                padding: 10px;
            }

            .node-library-grid>div[style*="grid-column"] {
                grid-column: 1 / -1 !important;
                margin: 15px 0 5px 0;
                padding-left: 8px;
                border-left: 3px solid var(--primary);
                font-size: 13px;
                font-weight: bold;
                color: #666;
                background: #f8f9fa;
                line-height: 30px;
            }

            .node-option {
                background: #ffffff;
                border: 1px solid #e5e5ea;
                border-radius: 12px;
                padding: 15px 10px;
                text-align: center;
                font-size: 13px;
                font-weight: 500;
                color: #333;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
                transition: all 0.2s;
            }

            .node-option:active {
                background: #f2f2f7;
                transform: scale(0.96);
            }

            /* ÁÆ°ÁêÜÂëò‰∏ìÁî®Èù¢Êùø */
            .admin-float-btn {
                position: fixed;
                bottom: 100px;
                left: 20px;
                background: #000;
                color: #fff;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                display: none;
                /* ÈªòËÆ§ÈöêËóè */
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                font-size: 24px;
                cursor: pointer;
                z-index: 999;
            }

            .admin-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
                margin-top: 10px;
            }

            .admin-table th {
                text-align: left;
                background: #eee;
                padding: 8px;
            }

            .admin-table td {
                border-bottom: 1px solid #eee;
                padding: 8px;
            }

            .btn-del-user {
                color: white;
                background: red;
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
            }

            /* Âà∑Êñ∞ÊåâÈíÆÊ†∑Âºè */
            #refreshBtnMain {
                background: transparent;
                border: none;
                font-size: 20px;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--primary);
                cursor: pointer;
                border-radius: 50%;
                transition: all 0.2s;
            }

            #refreshBtnMain:active {
                background: rgba(0, 122, 255, 0.1);
                transform: rotate(180deg);
            }

            /* ËΩ¨ÂúàÂä®ÁîªÔºàÁÇπÂáªÊó∂Ôºâ */
            @keyframes spin {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(360deg);
                }
            }

            #refreshBtnMain.spin {
                animation: spin 1s linear infinite;
            }
        </style>
    </head>

<body>

    <nav id="mainNavBar" class="navbar-common">
        <div class="nav-left">
            <button class="nav-back-btn" id="globalBackBtn" onclick="goHome()" style="display:none;">
                <svg viewBox="0 0 24 24">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                È¶ñÈ°µ
            </button>
            <h1 id="globalPageTitle" class="page-title">Â∑•‰ΩúÂä©Êâã</h1>
        </div>
        <div class="nav-right" style="gap: 8px; align-items: center;">
    <!-- ‰∏™‰∫∫‰∏≠ÂøÉÊåâÈíÆÔºàÊúÄÂ∑¶Ôºâ -->
    <span id="userBadge" class="user-badge" onclick="openPersonalCenter()" style="display:none;"></span>
    
    <!-- ËäÇÁÇπÂ∫ìÊåâÈíÆ -->
    <button id="nodeConfigBtn" class="nav-btn-right" onclick="openConfigModal('global')" style="display:none;">
        ‚öôÔ∏è ËäÇÁÇπÂ∫ì
    </button>
    
    <!-- Âà∑Êñ∞ÊåâÈíÆÔºàÊúÄÂè≥Á´ØÔºâ -->
    <button id="refreshBtnMain" class="nav-btn-right" onclick="manualSyncData(this)" title="Âà∑Êñ∞‰∫ëÁ´ØÊï∞ÊçÆ">
        ‚Üª
    </button>
</div>
    </nav>

    <nav id="detailNavBar" class="navbar-common" style="display:none; border-bottom: 0.5px solid rgba(0,0,0,0.1);">
        <div class="nav-left">
            <button class="nav-back-btn" onclick="goToPage('projectList')">
                <svg viewBox="0 0 24 24">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                ÂàóË°®
            </button>
        </div>

        <div class="detail-header-center">
            <div class="detail-title-row">
                <span id="navDetailTitle" class="detail-main-title"></span>
                <span style="font-size: 14px; color: var(--primary); cursor: pointer; margin-left: 4px;"
                    onclick="editProjectName()">‚úé</span>
            </div>
            <div id="navDetailType" class="detail-sub-title"></div>
        </div>

        <div class="nav-right" style="gap: 6px; align-items: center;">
            <!-- ‰∏™‰∫∫‰∏≠ÂøÉÊåâÈíÆ -->
            <span id="userBadge" class="user-badge" onclick="openPersonalCenter()" style="display:none;"></span>

            <!-- ËäÇÁÇπÂ∫ìÊåâÈíÆÔºàÈù†Â∑¶Ôºâ -->
            <button id="nodeConfigBtn" class="nav-btn-right" onclick="openConfigModal('global')" style="display:none;">
                ‚öôÔ∏è ËäÇÁÇπÂ∫ì
            </button>

            <!-- Âà∑Êñ∞ÊåâÈíÆÔºàÊîæÂú®ÊúÄÂêé = ÊúÄÂè≥Á´ØÔºâ -->
            <button id="refreshBtnMain" class="nav-btn-right" onclick="manualSyncData(this)" title="Âà∑Êñ∞‰∫ëÁ´ØÊï∞ÊçÆ">
                ‚Üª
            </button>
        </div>

    </nav>

    <div id="auth-modal" style="display:none;">
        <div class="auth-box">
            <h2 id="auth-title">‰∏™‰∫∫Ë¥¶Âè∑ÁôªÂΩï</h2>
            <p style="font-size:12px;color:#666;margin-bottom:20px;">ÁôªÂΩïÂêéÂèØÂ§öÁ´ØÂêåÊ≠•Êï∞ÊçÆ</p>

            <input type="email" id="email" class="auth-input" placeholder="Áî®Êà∑Âêç (ÈÇÆÁÆ±Ê†ºÂºè)">
            <input type="password" id="password" class="auth-input" placeholder="ÂØÜÁ†Å (Ëá≥Â∞ë6‰Ωç)">

            <button class="auth-btn" id="auth-action-btn" onclick="handleAuth()">ÁôªÂΩï</button>
            <div id="auth-error" class="error-msg"></div>
            <div class="auth-switch" onclick="switchMode()">Ê≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå</div>
        </div>
    </div>

    <div id="toast" class="toast">Â∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø</div>

    <div id="adminBtn" class="admin-float-btn" onclick="openAdminPanel()">üëÆ</div>

    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>üëÆ Ë∂ÖÁ∫ßÁÆ°ÁêÜÂêéÂè∞</h3>
            <div style="margin: 10px 0; font-weight: bold;">
                ÊÄªÊ≥®ÂÜåÂπ∂Â≠òÂÇ®Êï∞ÊçÆ‰∫∫Êï∞: <span id="adminTotalCount" style="color:red; font-size:20px;">0</span>
            </div>
            <div style="max-height: 60vh; overflow-y: auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Áî®Êà∑ID (Âêé4‰Ωç)</th>
                            <th>ÊúÄÂêéÂêåÊ≠•</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserList"></tbody>
                </table>
            </div>
            <button class="btn-cancel" onclick="closeModal('adminModal')">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div class="page-container">
        <div id="homePage" class="page active">
            <div class="welcome-row">
                <div class="welcome-date" id="welcomeDate">LOADING...</div>
                <div class="welcome-title">‰∏™‰∫∫ÊïàËÉΩ‰∏≠ÂøÉ</div>
            </div>

            <div class="asset-card-row">
                <div class="asset-card blue" onclick="goToPage('attendancePage')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="asset-label" style="color:rgba(255,255,255,0.8); margin-bottom:5px;">ÂΩìÂâçÂèØ‰ºëÊÄªÂ§©Êï∞
                            </div>
                            <div class="asset-value" id="homeOtDays" style="font-size:42px;">0</div>
                        </div>
                        <div style="text-align:right; opacity:0.9;">
                            <div style="font-size:12px;">Âπ¥ÂÅá/Â≠ò‰ºë/ÂÄí‰ºë</div>
                            <div style="font-size:24px; margin-top:5px;">üìÖ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-section">
                <div class="cal-header">
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(-1)">‚Äπ</div>
                    <span id="calMonth"></span>
                    <div class="cal-nav-btn" style="cursor:pointer" onclick="changeMonth(1)">‚Ä∫</div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn-mini" onclick="goToday()">ÂõûÂà∞‰ªäÂ§©</button>
                </div>
            </div>

            <div class="todo-section">
                <div class="todo-header-row">
                    <div class="section-head" style="margin:0;">üìù ÊàëÁöÑÂæÖÂäû</div>
                    <button class="btn-history" onclick="openTodoHistory()">
                        <span>‚Ü∫</span> ÂéÜÂè≤ÂΩíÊ°£
                    </button>
                </div>

                <div class="todo-input-row">
                    <input type="text" id="todoInput" class="todo-input" placeholder="ËæìÂÖ•‰ªªÂä°ÔºåÂõûËΩ¶Ê∑ªÂä†..."
                        onkeypress="if(event.keyCode===13) addTodo()">
                    <button class="todo-add-btn" onclick="addTodo()">+</button>
                </div>

                <div id="todoList" class="todo-list"></div>
            </div>

            <div class="section-head" style="margin-top:20px;">üöÄ ÂäüËÉΩÂØºËà™</div>
            <div class="project-entry-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="entry-card eng" onclick="goToPage('projectList')" style="padding:15px 5px;">
                    <span class="entry-icon">üèóÔ∏è</span>
                    <span class="entry-title" style="font-size:13px;">Â∑•Á®ãÈ°πÁõÆ</span>
                </div>
                <div class="entry-card non-eng" onclick="goToPage('nonProjectList')" style="padding:15px 5px;">
                    <span class="entry-icon">üìÇ</span>
                    <span class="entry-title" style="font-size:13px;">ÈùûÂ∑•Á®ã</span>
                </div>
                <div class="entry-card tools" onclick="goToPage('toolsPage')" style="padding:15px 5px;">
                    <span class="entry-icon">üß∞</span>
                    <span class="entry-title" style="font-size:13px;">ÁôæÂÆùÁÆ±</span>
                </div>
            </div>

            <div class="footer-tools">
                <div class="tool-btn" onclick="exportData()">üì§ Â§á‰ªΩÊï∞ÊçÆ</div>
                <div class="tool-btn" onclick="triggerImport()">üì• ÊÅ¢Â§çÊï∞ÊçÆ(PlusÁâà)</div>
            </div>
            <div
                style="text-align: center; color: #ccc; font-size: 10px; margin-bottom: 20px; font-family: monospace; opacity: 0.6;">
                v1.0.0</div>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>

        <div id="attendancePage" class="page">
            <div class="ot-summary-card">
                <div style="font-size:14px; opacity:0.8;">ÂΩìÂâçÂèØ‰ºëÊÄªÂ§©Êï∞</div>
                <div class="ot-big-num" id="otTotalDays">0.0</div>
                <div class="ot-grid">
                    <div>
                        <div class="ot-label">Ââ©Âπ¥ÂÅá</div>
                        <div class="ot-val" id="dispAnnual">0</div>
                    </div>
                    <div>
                        <div class="ot-label">Ââ©Â≠ò‰ºë</div>
                        <div class="ot-val" id="dispSaved">0</div>
                    </div>
                    <div>
                        <div class="ot-label">Âä†Áè≠Ê±†</div>
                        <div class="ot-val" id="dispOt">0</div>
                    </div>
                </div>
            </div>
            <div class="ot-settings-mini">
                <span>ÂàùÂßãÂü∫Êï∞Ôºö</span>
                <label>Âπ¥ÂÅá</label><input type="number" id="inpAnnual" class="ot-input-mini" onchange="saveBaseLeave()">
                <label>Â≠ò‰ºë</label><input type="number" id="inpSaved" class="ot-input-mini" onchange="saveBaseLeave()">
            </div>
            <div class="home-section-title">Âä†Áè≠ËÆ∞ÂΩï (ÂÄí‰ºë)</div>
            <div id="otListContainer"></div>
            <div style="text-align:center; padding:10px;"><button class="btn-mini" onclick="openModal('addOtModal')">+
                    ÂΩïÂÖ•Âä†Áè≠</button></div>
            <div class="home-section-title">‰ºëÂÅáËÆ∞ÂΩï</div>
            <div id="leaveListContainer"></div>
            <div style="text-align:center; padding:10px; margin-bottom:50px;"><button class="btn-mini"
                    onclick="openNewLeave()">+ ÂΩïÂÖ•‰ºëÂÅá</button></div>
        </div>

        <div id="projectList" class="page">
            <div class="project-section">
                <div class="project-section-header" style="color:#007AFF;border-color:#007AFF;">‰∏ìÈ°πÂ∑•Á®ã <span id="c_s"
                        style="font-size:12px;background:#e3f2fd;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_special" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#AF52DE;border-color:#AF52DE;">Èõ∂ÊòüÂ∑•Á®ã <span id="c_o"
                        style="font-size:12px;background:#f3e5f5;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_odd" class="project-section-body"></div>
            </div>
            <div class="project-section">
                <div class="project-section-header" style="color:#FF3B30;border-color:#FF3B30;">Êä¢‰øÆÂ∑•Á®ã <span id="c_r"
                        style="font-size:12px;background:#ffebee;padding:2px 8px;border-radius:10px;">0</span></div>
                <div id="container_repair" class="project-section-body"></div>
            </div>
            <button class="fab-add" onclick="openModal('createModal')">+</button>
        </div>

        <div id="nonProjectList" class="page">
            <div style="text-align:center; padding:50px 20px; color:#999;">
                <div style="font-size:40px; margin-bottom:10px;">üìÇ</div>
                <h3>ÈùûÂ∑•Á®ãÈ°πÁõÆÁÆ°ÁêÜ</h3>
                <p>Ê≠§Ê®°ÂùóÊ≠£Âú®Âª∫ËÆæ‰∏≠...</p>
            </div>
        </div>

        <div id="projectDetail" class="page">
            <div class="segmented-control">
                <button id="seg_timeline" class="segment-btn active" onclick="switchDetailTab('timeline')">üìÖ
                    ËøõÂ∫¶‰∏ªÁ∫ø</button>
                <button id="seg_services" class="segment-btn" onclick="switchDetailTab('services')">ü§ù ÂèÇÂª∫Âçï‰Ωç</button>
            </div>

            <div id="view_timeline">
                <div class="preview-section">
                    <div class="preview-header"><span>üìã ÂÖ®ÊÅØËøõÂ∫¶È¢ÑËßà</span></div>
                    <div id="previewFlow" class="preview-flow"></div>
                </div>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    <div id="stagesContainer"></div>
                    <div id="emptyHint"
                        style="text-align:center; padding:40px; color:#999; font-size:14px; display:none;">üëá
                        ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†Á¨¨‰∏Ä‰∏™ÊµÅÁ®ãËäÇÁÇπ</div>
                </div>
                <div style="text-align:center; padding-bottom:30px;">
                    <button class="btn-add-node" onclick="openNodeLibrary()">+ Ê∑ªÂä†ÊµÅÁ®ãËäÇÁÇπ</button>
                </div>
            </div>

            <div id="view_services" style="display:none;">
                <div id="servicesListContainer"></div>
                <div style="text-align:center; padding:20px; color:#999; font-size:13px;" id="emptyServicesHint">
                    ÊöÇÊó†ÂèÇÂª∫Âçï‰ΩçËÆ∞ÂΩï</div>
                <div style="text-align:center; padding-bottom:30px;">
                    <button class="btn-add-node" style="background:var(--purple);"
                        onclick="openModal('addServiceModal')">+ ÂΩïÂÖ•ÂèÇÂª∫Âçï‰Ωç</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toolsPage" class="page">
        <div class="page-header-row">
            <span class="page-header-title">üß∞ ÁôæÂÆùÁÆ±</span>
        </div>
        <div class="tool-grid">
            <div class="tool-item" onclick="openModal('dateCalcModal')">
                <span class="tool-icon">üìÖ</span>
                <span class="tool-name">Êó•ÊúüËÆ°ÁÆó</span>
            </div>
            <div class="tool-item" style="opacity:0.5; background:#f9f9f9; border:none; cursor:default;">
                <span class="tool-icon" style="font-size:24px; opacity:0.5;">‚ûï</span>
                <span class="tool-name">Êõ¥Â§ö...</span>
            </div>
            <div class="tool-item" style="opacity:0; pointer-events:none;"></div>
        </div>
    </div>

    <div id="dateCalcModal" class="modal">
        <div class="modal-content">
            <h3>üìÖ Êó•ÊúüÂ∑ÆËÆ°ÁÆóÂô®</h3>
            <div style="margin-top:15px;">
                <label class="form-label">ÂºÄÂßãÊó•Êúü</label>
                <input type="date" id="toolStartDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <label class="form-label">ÁªìÊùüÊó•Êúü</label>
                <input type="date" id="toolEndDate" class="input-box" max="2099-12-31"
                    oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
                <button class="btn-primary" onclick="calcDateDiff()" style="margin-top:20px;">ËÆ°ÁÆóÂ§©Êï∞</button>
                <div id="dateResult" class="tool-result"></div>
            </div>
            <button class="btn-cancel" onclick="closeModal('dateCalcModal')">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="dayLogModal" class="modal">
        <div class="modal-content">
            <h3 id="logDateTitle">202X-XX-XX</h3>
            <label class="form-label">Â∑•‰ΩúÊó•Âøó</label>
            <textarea id="logContent" class="log-textarea" placeholder="ËÆ∞ÂΩï‰ªäÂ§©ÁöÑÂ∑•‰ΩúÈáçÁÇπ..."></textarea>
            <button class="btn-primary" onclick="saveDayLog()">‰øùÂ≠òÊó•Âøó</button>
            <button class="btn-cancel" onclick="closeModal('dayLogModal')">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="todoHistoryModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 5px;">üìú Â∑≤ÂÆåÊàê‰ªªÂä°</h3>
            <div style="font-size:12px; color:#999; margin-bottom:15px;">ÁÇπÂáª‚ÄúÊÅ¢Â§ç‚ÄùÂèØÊîæÂõûÈ¶ñÈ°µ</div>
            <div id="historyListContainer" class="history-list"></div>
            <button class="btn-cancel" onclick="closeModal('todoHistoryModal')">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <div id="addServiceModal" class="modal">
        <div class="modal-content">
            <h3>ÂΩïÂÖ•ÂèÇÂª∫Âçï‰Ωç</h3>
            <label class="form-label">Âçï‰ΩçÁ±ªÂûã</label>
            <select id="svcType" class="input-box">
                <option value="ËÆæËÆ°Âçï‰Ωç">üé® ËÆæËÆ°Âçï‰Ωç</option>
                <option value="ÁõëÁêÜÂçï‰Ωç">üëÅÔ∏è ÁõëÁêÜÂçï‰Ωç</option>
                <option value="ÂãòÂØüÊµãÁªò">üìê ÂãòÂØüÊµãÁªò</option>
                <option value="ÈÄ†‰ª∑Âí®ËØ¢">üí∞ ÈÄ†‰ª∑Âí®ËØ¢</option>
                <option value="ÊãõÊ†á‰ª£ÁêÜ">üì¢ ÊãõÊ†á‰ª£ÁêÜ</option>
                <option value="ÂÖ∂‰ªñÊúçÂä°">üì¶ ÂÖ∂‰ªñÊúçÂä°</option>
            </select>
            <label class="form-label">Âçï‰ΩçÂêçÁß∞</label>
            <input type="text" id="svcName" class="input-box" placeholder="‰æãÂ¶ÇÔºöÂåó‰∫¨Â∏ÇÂª∫Á≠ëËÆæËÆ°Èô¢">
            <label class="form-label">ÂêàÂêåÈáëÈ¢ù (ÂÖÉ)</label>
            <input type="number" id="svcAmount" class="input-box" placeholder="0">
            <label class="form-label">ËÅîÁ≥ª‰∫∫ & ÁîµËØù</label>
            <input type="text" id="svcContact" class="input-box" placeholder="Âº†‰∏â 13800000000">
            <button class="btn-primary" onclick="saveService()">‰øùÂ≠ò</button>
            <button class="btn-cancel" onclick="closeModal('addServiceModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="addOtModal" class="modal">
        <div class="modal-content">
            <h3>ÂΩïÂÖ•Âä†Áè≠</h3>
            <label class="form-label">Êó•Êúü</label>
            <input type="date" id="otDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">Â§©Êï∞</label>
            <input type="number" id="otDays" class="input-box" step="0.5">
            <label class="form-label">Â§áÊ≥®</label>
            <input type="text" id="otNote" class="input-box">
            <button class="btn-primary" onclick="addOvertime()">Á°ÆËÆ§</button>
            <button class="btn-cancel" onclick="closeModal('addOtModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="addLeaveModal" class="modal">
        <div class="modal-content">
            <h3 id="leaveModalTitle">ÂΩïÂÖ•‰ºëÂÅá</h3>
            <input type="hidden" id="lvEditIndex">
            <label class="form-label">Á±ªÂûã</label>
            <select id="lvType" class="input-box">
                <option value="Âπ¥ÂÅá">Âπ¥ÂÅá</option>
                <option value="Â≠ò‰ºë">Â≠ò‰ºë</option>
                <option value="ÂÄí‰ºë">ÂÄí‰ºë</option>
                <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
            </select>
            <label class="form-label">Êó•Êúü</label>
            <input type="date" id="lvDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <label class="form-label">Â§©Êï∞</label>
            <input type="number" id="lvDays" class="input-box" step="0.5">
            <label class="form-label">ËØ¥Êòé</label>
            <input type="text" id="lvNote" class="input-box">
            <button class="btn-primary" id="lvSaveBtn" onclick="saveLeaveRecord()">Á°ÆËÆ§</button>
            <button class="btn-cancel" onclick="closeModal('addLeaveModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="useOtModal" class="modal">
        <div class="modal-content">
            <h3>Ê†∏ÈîÄÂä†Áè≠</h3>
            <p style="color:#666;font-size:13px;margin-bottom:15px">Á°ÆËÆ§Â∑≤ÂÄí‰ºëÔºü</p>
            <label class="form-label">ÂÄí‰ºëÊó•Êúü</label>
            <input type="date" id="useOtDate" class="input-box" max="2099-12-31"
                oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10)">
            <input type="hidden" id="useOtId">
            <button class="btn-primary" onclick="confirmUseOt()">Á°ÆËÆ§</button>
            <button class="btn-cancel" onclick="closeModal('useOtModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>Êñ∞Âª∫Â∑•Á®ã</h3>
            <label class="form-label">ÂêçÁß∞</label>
            <input type="text" id="newProjectName" class="input-box">
            <label class="form-label">Á±ªÂà´</label>
            <select id="newProjectType" class="input-box">
                <option value="special">üåü ‰∏ìÈ°πÂ∑•Á®ã</option>
                <option value="odd">üîß Èõ∂ÊòüÂ∑•Á®ã</option>
                <option value="repair">üöë Êä¢‰øÆÂ∑•Á®ã</option>
            </select>
            <button class="btn-primary" onclick="createProject()">ÂàõÂª∫</button>
            <button class="btn-cancel" onclick="closeModal('createModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="nodeLibraryModal" class="modal">
        <div class="modal-content">
            <h3>ÈÄâÊã©ËäÇÁÇπ</h3>
            <div id="nodeLibraryGrid" class="node-library-grid"></div>
            <button class="btn-cancel" onclick="closeModal('nodeLibraryModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="dynamicFormModal" class="modal">
        <div class="modal-content">
            <h3 id="formTitle"></h3>
            <div id="dynamicFormContainer"></div>
            <button class="btn-primary" onclick="saveDynamicData()">‰øùÂ≠ò</button>
            <button class="btn-cancel" onclick="closeModal('dynamicFormModal')">ÂèñÊ∂à</button>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 id="configModalTitle">ËäÇÁÇπÂ∫ì</h3>
            <div class="config-container" id="configContainer"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-primary" style="flex:1;" onclick="handleConfigSave()">‰øùÂ≠ò</button>
                <button class="btn-cancel" style="flex:1;" onclick="closeModal('configModal')">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div id="nodeDetailModal" class="node-detail-modal">
        <div class="node-detail-content">
            <div class="node-detail-header" id="nodeDetailTitle"></div>
            <div class="node-field-list" id="nodeFieldList"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-small" onclick="addNewConfigField()" style="flex:1;">+ Â¢ûÂä†Â≠óÊÆµ</button>
                <button class="btn-small" onclick="saveNodeDetailEditor()"
                    style="flex:1; background:var(--primary); color:white;">‰øùÂ≠ò</button>
                <button class="btn-small" onclick="closeNodeDetailEditor()" style="flex:1;">ËøîÂõû</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://api.9990088.xyz';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkZGltYWR6cGJjdm10b3Vqb2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTE3NTksImV4cCI6MjA4NTY4Nzc1OX0.dMJdVjjr3D0oGRli1DE2ohvl-5abwLGHSPAaS8wREG0';

        const { createClient } = supabase;
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
        });

        // ‚ö†Ô∏è ÊääËøô‰∏™Êç¢Êàê‰Ω†Ëá™Â∑±ÁöÑÁÆ°ÁêÜÂëòÈÇÆÁÆ±
        const ADMIN_EMAIL = "liu@qq.com";

        let currentUser = null;
        let isRegisterMode = false;
        let syncTimer = null;

        // üìç 1. ÂÆö‰πâ‰∏Ä‰∏™ÂèòÈáèÔºå‰∏ìÈó®ËÆ∞‰ΩçÁΩÆ
        let homeScrollTop = 0;

        // üîÑ 2. Ë¶ÜÁõñÊóßÁöÑË∑≥ËΩ¨ÂáΩÊï∞ (ÂéªÂà´ÁöÑÈ°µÈù¢Êó∂ÔºåËÆ∞‰∏ãÂΩìÂâç‰ΩçÁΩÆ)
        window.goToPage = function (id) {
            const container = document.querySelector('.page-container');

            // Â¶ÇÊûúÊòØ‰ªéÈ¶ñÈ°µÁ¶ªÂºÄÔºåËµ∂Á¥ßËÆ∞‰∏ã‰ΩçÁΩÆÔºÅ
            if (document.getElementById('homePage').classList.contains('active')) {
                homeScrollTop = container.scrollTop;
            }

            // --- ÂéüÊúâÁöÑÊòæÁ§∫ÈÄªËæë ---
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            // ÂØºËà™Ê†èÂ§ÑÁêÜ
            if (id === 'projectDetail') {
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                document.getElementById('globalPageTitle').innerText = isHome ? 'Â∑•‰ΩúÂä©Êâã' : '';
            }

            // Ê∏≤ÊüìÈÄªËæë
            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();

            // --- üìç Ê†∏ÂøÉ‰ΩçÁΩÆÊÅ¢Â§çÈÄªËæë ---
            if (id === 'homePage') {
                // Â¶ÇÊûúÊòØÂõûÈ¶ñÈ°µÔºåÊÅ¢Â§ç‰ΩçÁΩÆ
                setTimeout(() => { container.scrollTop = homeScrollTop; }, 0);
            } else {
                // Â¶ÇÊûúÊòØÂéªÊñ∞È°µÈù¢ÔºåÊªöÂà∞ÊúÄ‰∏äÈù¢
                container.scrollTop = 0;
            }

            // ÂéÜÂè≤ËÆ∞ÂΩï (Èò≤Ê≠¢ÊµèËßàÂô®ÂêéÈÄÄÈÄÄÂá∫)
            history.pushState({ pageId: id }, null, "#" + id);
        };

        // üè† 3. Ë¶ÜÁõñÊóßÁöÑÂõûÈ¶ñÈ°µÂáΩÊï∞
        window.goHome = function () {
            if (history.state && history.state.pageId) {
                history.back(); // ‰ºòÂÖàËß¶ÂèëÊµèËßàÂô®ÁöÑËøîÂõû
            } else {
                // Âº∫Âà∂ÂõûÈ¶ñÈ°µ
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('homePage').classList.add('active');
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';
                document.getElementById('globalBackBtn').style.display = 'none';
                document.getElementById('userBadge').style.display = 'block';

                // ÊÅ¢Â§ç‰ΩçÁΩÆ
                setTimeout(() => {
                    document.querySelector('.page-container').scrollTop = homeScrollTop;
                }, 0);
            }
        };
        async function initApp() {


            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                // ÊúâË¥¶Âè∑ -> Ëµ∞Ê≠£Â∏∏ÁöÑÁôªÂΩïÊµÅÁ®ãÔºàÂê´Êï∞ÊçÆÊ∏ÖÊ¥óÊ£ÄÊü•Ôºâ
                handleLoginSuccess(session.user);
            } else {
                // Ê≤°Ë¥¶Âè∑ -> Âä†ËΩΩËÉåÊôØÔºåÂπ∂Âº∫Âà∂ÊòæÁ§∫ÁôªÂΩïÊ°Ü
                initHome();
                document.getElementById('auth-modal').style.display = 'flex';
            }
        }
        // üåü Êñ∞Â¢ûÂáΩÊï∞ÔºöËøõÂÖ•ËÆøÂÆ¢Ê®°Âºè
        function enterGuestMode() {
            // 1. ÂÖ≥Èó≠ÁôªÂΩïÂºπÁ™ó
            document.getElementById('auth-modal').style.display = 'none';

            // 2. ÊèêÁ§∫Áî®Êà∑
            showToast('üëÄ ËÆøÂÆ¢Ê®°ÂºèÔºöÊï∞ÊçÆ‰ªÖ‰øùÂ≠òÂú®Êú¨Êú∫');

            // 3. Á°Æ‰øùÂΩìÂâçÊ≤°ÊúâÁôªÂΩïÁî®Êà∑Áä∂ÊÄÅ
            currentUser = null;
            document.getElementById('userBadge').style.display = 'none';

            // 4. Âä†ËΩΩÊú¨Âú∞ÁºìÂ≠òÁöÑÊï∞ÊçÆÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâÂπ∂Ê∏≤ÊüìÈ°µÈù¢
            loadConfig();
            migrateData();
            initHome();
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-action-btn');
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) return showAuthError('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å');

            btn.innerText = 'Â§ÑÁêÜ‰∏≠...';
            btn.disabled = true;
            errorDiv.style.display = 'none';

            let result;
            if (isRegisterMode) {
                result = await _supabase.auth.signUp({ email, password });
            } else {
                result = await _supabase.auth.signInWithPassword({ email, password });
            }

            if (result.error) {
                showAuthError(result.error.message);
                btn.innerText = isRegisterMode ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï';
                btn.disabled = false;
            } else {
                if (isRegisterMode && !result.data.session) {
                    showAuthError('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑Ê£ÄÊü•ÈÇÆÁÆ±Á°ÆËÆ§ÈÇÆ‰ª∂ÔºåÁ°ÆËÆ§ÂêéÈáçÊñ∞ÁôªÂΩï„ÄÇ');
                    btn.innerText = 'Ê≥®ÂÜå';
                    btn.disabled = false;
                } else {
                    handleLoginSuccess(result.data.user);
                }
            }
        }

        // 1. üåü Êñ∞Â¢ûÔºöËÆøÂÆ¢Ê®°ÂºèÁÇπÂáªÂèâÂè∑ÁöÑÈÄªËæë
        function enterGuestMode() {
            document.getElementById('auth-modal').style.display = 'none';
            showToast('üëÄ ËÆøÂÆ¢Ê®°ÂºèÔºöÊï∞ÊçÆ‰ªÖÂ≠òÂú®Êú¨Êú∫');
            currentUser = null;
            // Áõ¥Êé•Âä†ËΩΩÊú¨Âú∞Áé∞ÊúâÂÜÖÂÆπ
            loadConfig(); migrateData(); initHome();
        }

        // 2. üåü ÁªàÊûÅ‰øÆÂ§çÔºöÁôªÂΩïÊàêÂäüÂ§ÑÁêÜÔºàÈò≤‰∏≤Âè∑Ê≠ªÂæ™ÁéØÔºâ
        async function handleLoginSuccess(user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';

            const userBadge = document.getElementById('userBadge');
            userBadge.innerText = user.email.split('@')[0];
            userBadge.style.display = 'block';
            // üåü Êñ∞Â¢ûÔºöÂ¶ÇÊûúÊòØÁÆ°ÁêÜÂëòÔºåÊòæÁ§∫ÈªëËâ≤ÁÆ°ÁêÜÊåâÈíÆ
            if (user.email === ADMIN_EMAIL) {
                document.getElementById('adminBtn').style.display = 'flex';
                showToast('üëÆ ÁÆ°ÁêÜÂëòÊ®°ÂºèÂ∑≤ÊøÄÊ¥ª');
            } else {
                document.getElementById('adminBtn').style.display = 'none';
            }
            showToast('‚òÅÔ∏è Ê≠£Âú®Ê†∏È™å‰∫ëÁ´ØÊï∞ÊçÆ...');

            try {
                // üîç Á¨¨‰∏ÄÊ≠•ÔºöÂÖà‰∏çÂéªËØªÊú¨Âú∞ÔºåÁõ¥Êé•ÈóÆ‰∫ëÁ´ØËøô‰∏™Âè∑ÊúâÊ≤°ÊúâÊï∞ÊçÆ
                const { data, error } = await _supabase.from('user_data').select('content').eq('user_id', currentUser.id).single();

                if (data && data.content) {
                    // üü¢ ÊÉÖÂÜµAÔºöËÄÅÁî®Êà∑Ôºå‰∫ëÁ´ØÊúâ‰∏úË•øÔºåÂº∫Ë°åË¶ÜÁõñÊéâÊú¨Âú∞ÁõÆÂâçÁöÑËÑèÊï∞ÊçÆ
                    const c = data.content;
                    if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                    if (c.config) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                    if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                    if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                    if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
                } else {
                    // üî¥ ÊÉÖÂÜµBÔºöÊñ∞Áî®Êà∑Ôºå‰∫ëÁ´ØÊòØÁ©∫ÁöÑÔºåÁ´ãÂàªÊâßË°åÊñ©È¶ñË°åÂä®ÔºöÊ∏ÖÁ©∫Êú¨Âú∞ÁºìÂ≠òÔºÅ
                    console.log("Ê£ÄÊµãÂà∞Êñ∞Ë¥¶Âè∑ÔºåÊ≠£Âú®Ê∏ÖÊ¥óÊú¨Âú∞ÊÆãÁïôÊï∞ÊçÆ...");
                    localStorage.clear();
                }
            } catch (err) {
                console.log("ËØ•Ë¥¶Âè∑ÊöÇÊó†‰∫ëÁ´ØÂ§á‰ªΩ");
            }

            // üöÄ Á¨¨‰∏âÊ≠•ÔºöÊï∞ÊçÆÊ¥óÂπ≤ÂáÄ‰∫ÜÔºåÂÜçÈáçÊñ∞Âä†ËΩΩÊ∏≤ÊüìÈ°µÈù¢
            loadConfig();
            migrateData();
            initHome();
            showToast('‚úÖ ÁôªÂΩïÊàêÂäü');
        }
        function switchMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? 'Ê≥®ÂÜåÊñ∞Ë¥¶Âè∑' : '‰∫ëÁ´ØË¥¶Âè∑ÁôªÂΩï';
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï';
            document.querySelector('.auth-switch').innerText = isRegisterMode ? 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÁôªÂΩï' : 'Ê≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå';
            document.getElementById('auth-error').style.display = 'none';
        }

        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.innerText = msg;
            el.style.display = 'block';
        }

        async function logout() {
            // üåü ÁÆÄÊ¥ÅÊèêÁ§∫Ôºå‰∏çÂÜçÂ∫üËØù
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ÂêóÔºü')) {
                // 1. Âä®‰ΩúÔºöÁõ¥Êé•Ê∏ÖÁ©∫Êú¨Âú∞Ôºå‰∏çÁïôÁóïËøπ
                localStorage.clear();

                // 2. Âä®‰ΩúÔºöÊñ≠ÂºÄ‰∫ëÁ´Ø
                await _supabase.auth.signOut();

                // 3. Âä®‰ΩúÔºöÂà∑Êñ∞ÈáçÂêØ
                window.location.reload();
            }
        }

        function debouncedSync() {
            if (!currentUser) return;
            showToast('üîÑ Ê≠£Âú®ÂêåÊ≠•...');
            clearTimeout(syncTimer);
            syncTimer = setTimeout(async () => {
                const payload = {
                    projects: JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'),
                    config: JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}'),
                    attendance: JSON.parse(localStorage.getItem(DB_KEY_OT) || '{}'),
                    todo: JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]'),
                    calendar: JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}'),
                    updated_at: new Date().toISOString()
                };
                const { error } = await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                if (!error) showToast('‚úÖ Â∑≤ÂêåÊ≠•Âà∞‰∫ëÁ´Ø');
                else showToast('‚ùå ÂêåÊ≠•Â§±Ë¥•: ' + error.message);
            }, 1000);
        }

        // ==================== Êï∞ÊçÆÂà∑Êñ∞ÊåâÈíÆË∞ÉÁî®ÂáΩÊï∞ ====================
        async function manualSyncData(btnElement) {
            if (!currentUser) {
                showToast('ËØ∑ÂÖàÁôªÂΩïË¥¶Âè∑ÊâçËÉΩÂêåÊ≠•‰∫ëÁ´ØÊï∞ÊçÆ');
                return;
            }

            // ÁÇπÂáªÊó∂ÊòæÁ§∫ËΩ¨Âúà
            if (btnElement) btnElement.classList.add('spin');

            try {
                const { data, error } = await _supabase
                    .from('user_data')
                    .select('content')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (error) throw error;

                if (data && data.content) {
                    // Ë¶ÜÁõñÊú¨Âú∞Êï∞ÊçÆÔºà‰ª•‰∫ëÁ´Ø‰∏∫ÂáÜÔºâ
                    const c = data.content;
                    if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                    if (c.config) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                    if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                    if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                    if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));

                    // Âà∑Êñ∞ÂΩìÂâçÈ°µÈù¢ÊòæÁ§∫
                    if (document.getElementById('homePage').classList.contains('active')) {
                        initHome();
                    } else if (document.getElementById('projectList').classList.contains('active')) {
                        renderProjects();
                    } else if (document.getElementById('attendancePage').classList.contains('active')) {
                        renderOtPage();
                    }

                    showToast('‚úÖ Êï∞ÊçÆÂ∑≤‰ªé‰∫ëÁ´ØÂà∑Êñ∞');
                } else {
                    showToast('‰∫ëÁ´ØÊöÇÊó†Êï∞ÊçÆ');
                }
            } catch (err) {
                console.error(err);
                showToast('‚ùå Âà∑Êñ∞Â§±Ë¥•');
            } finally {
                if (btnElement) btnElement.classList.remove('spin');
            }
        }

        async function syncCloudToLocal() {
            const { data, error } = await _supabase.from('user_data').select('content').eq('user_id', currentUser.id).single();
            if (data && data.content) {
                const c = data.content;
                if (c.projects) localStorage.setItem(DB_KEY_DATA, JSON.stringify(c.projects));
                if (c.config && Object.keys(c.config).length > 0) localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(c.config));
                if (c.attendance) localStorage.setItem(DB_KEY_OT, JSON.stringify(c.attendance));
                if (c.todo) localStorage.setItem(DB_KEY_TODO, JSON.stringify(c.todo));
                if (c.calendar) localStorage.setItem(DB_KEY_CAL, JSON.stringify(c.calendar));
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }

        // --- üåü V64 Ê†∏ÂøÉ‰øÆÊîπÔºöÊô∫ËÉΩÂØºËà™Ê†èÂàáÊç¢ logic ---
        function goHome() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('homePage').classList.add('active');

            // ÂàáÊç¢Âà∞‰∏ªÂØºËà™Ê†è
            document.getElementById('mainNavBar').style.display = 'flex';
            document.getElementById('detailNavBar').style.display = 'none';

            // ÊÅ¢Â§ç‰∏ªÂØºËà™Áä∂ÊÄÅ
            document.getElementById('globalBackBtn').style.display = 'none';
            document.getElementById('userBadge').style.display = 'block';
            document.getElementById('globalPageTitle').innerText = 'Â∑•‰ΩúÂä©Êâã';

            // ÈÖçÁΩÆÊåâÈíÆÈöêËóè
            document.getElementById('nodeConfigBtn').style.display = 'none';

            initHome();
        }

        function goToPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            if (id === 'projectDetail') {
                // ËØ¶ÊÉÖÈ°µÔºöÊòæÁ§∫ËØ¶ÊÉÖ‰∏ìÁî®ÂØºËà™Ê†è
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                // ÂÖ∂‰ªñÈ°µÈù¢ÔºöÊòæÁ§∫‰∏ªÂØºËà™Ê†è
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';

                // Â§ÑÁêÜ‚ÄúÂàóË°®È°µ‚ÄùÁ≠âÂ≠êÈ°µÈù¢ÁöÑËøîÂõûÊåâÈíÆ
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';

                // Â∑•Á®ãÂàóË°®È°µÊòæÁ§∫‚ÄúÈÖçÁΩÆ‚ÄùÊåâÈíÆ
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                // üåü ‰øÆÊîπÔºöÂè™ÊúâÂú®È¶ñÈ°µÊòæÁ§∫Ê†áÈ¢òÔºåÂÖ∂‰ªñÈ°µÈù¢ÁïôÁ©∫
                if (id === 'homePage') {
                    document.getElementById('globalPageTitle').innerText = 'Â∑•‰ΩúÂä©Êâã';
                } else {
                    document.getElementById('globalPageTitle').innerText = '';

                }
            }

            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        const DB_KEY_DATA = 'engineering_master_db';
        const DB_KEY_CONFIG = 'engineering_config_v15';
        const DB_KEY_OT = 'attendance_master_db_v2';
        const DB_KEY_TODO = 'todo_master_db';
        const DB_KEY_CAL = 'calendar_master_db';

        const NODE_CATEGORIES = {
            "üìå È°πÁõÆÂâçÊúüÊâãÁª≠": ["ÊñπÊ°àËÆæËÆ°", "Â∏ÇÂ±ÄÊä•ÂÆ°", "Âå∫ÊîøÂ∫ú‰ºö", "ÂèëÊîπÂßîÁ´ãÈ°π", "‰∫ãÂâçËØÑ‰º∞", "Ë¥¢ÊîøËØÑÂÆ°"],
            "üí∞ ÈááË¥≠ÊâãÁª≠": ["ÂßîÊâò‰ª£ÁêÜÁ≠æÂêàÂêå", "ÁºñÂà∂ÈááË¥≠Êñá‰ª∂", "ÊÑèÂêëÂÖ¨ÂºÄ", "ÂèëÂ∏ÉÂÖ¨Âëä", "ÂÆåÊàêËØÑÊ†á", "ÂèëÂ∏É‰∏≠Ê†áÂÖ¨Á§∫"],
            "üè¢ ÁÆ°ÁêÜÂ§ÑÂÜÖÈÉ®ÊâãÁª≠": ["ÂÖöÁªÑ‰ºö", "‰∏ª‰ªªÂäûÂÖ¨‰ºö", "Á∫∏Ë¥®ËØ∑Á§∫", "‰ªòÊ¨æ"],
            "üèóÔ∏è Â∑•Á®ãÂÆûÊñΩËøáÁ®ãÂèäÂêéÁª≠ÊâãÁª≠": ["ÂºÄÂ∑•Â§áÊ°à", "ËÆæËÆ°‰∫§Â∫ï", "ÊñΩÂ∑•ÂÖ•Âú∫", "Á´£Â∑•È™åÊî∂", "ÁªìÁÆóÂÆ°Ê†∏", "ËµÑÊñôÂΩíÊ°£"]
        };

        const DEFAULT_CONFIG = {
            "ÊñπÊ°àËÆæËÆ°": [{ key: "finishDate", label: "ÂõæÁ∫∏ÂÆåÊàêÊó∂Èó¥", type: "date" }, { key: "designUnit", label: "ËÆæËÆ°Âçï‰Ωç", type: "text" }],
            "Â∏ÇÂ±ÄÊä•ÂÆ°": [{ key: "submitDate", label: "Êä•ÈÄÅÊó∂Èó¥", type: "date" }, { key: "replyDate", label: "ÊâπÂ§çÊó∂Èó¥", type: "date" }],
            "Âå∫ÊîøÂ∫ú‰ºö": [{ key: "meetDate", label: "‰∏ä‰ºöÊó∂Èó¥", type: "date" }, { key: "minutesNo", label: "Á∫™Ë¶ÅÊñáÂè∑", type: "text" }],
            "ÂèëÊîπÂßîÁ´ãÈ°π": [{ key: "submitDate", label: "Áî≥Êä•Êó∂Èó¥", type: "date" }, { key: "approvalDate", label: "ÊâπÂ§çÊó∂Èó¥", type: "date" }, { key: "approvalAmount", label: "ÊâπÂ§çÈáëÈ¢ù(ÂÖÉ)", type: "number" }, { key: "projectCode", label: "È°πÁõÆ‰ª£Á†Å", type: "text" }],
            "‰∫ãÂâçËØÑ‰º∞": [{ key: "evalDate", label: "ËØÑ‰º∞‰ºöËÆÆÊó∂Èó¥", type: "date" }, { key: "reportDate", label: "Êä•ÂëäÂá∫ÂÖ∑Êó∂Èó¥", type: "date" }],
            "Ë¥¢ÊîøËØÑÂÆ°": [{ key: "sendDate", label: "ÈÄÅÂÆ°Êó∂Èó¥", type: "date" }, { key: "reportDate", label: "ËØÑÂÆ°Êä•ÂëäÊó∂Èó¥", type: "date" }, { key: "auditAmount", label: "ÂÆ°ÂÆöÈáëÈ¢ù(ÂÖÉ)", type: "number" }],
            "ÂßîÊâò‰ª£ÁêÜÁ≠æÂêàÂêå": [{ key: "signDate", label: "Á≠æËÆ¢Êó∂Èó¥", type: "date" }, { key: "agencyName", label: "‰ª£ÁêÜÊú∫ÊûÑÂêçÁß∞", type: "text" }],
            "ÁºñÂà∂ÈááË¥≠Êñá‰ª∂": [{ key: "finishDate", label: "ÁºñÂà∂ÂÆåÊàêÊó∂Èó¥", type: "date" }, { key: "controlPrice", label: "ÊéßÂà∂‰ª∑/È¢ÑÁÆó(ÂÖÉ)", type: "number" }, { key: "purchaseMode", label: "ÈááË¥≠ÊñπÂºè", type: "select", options: ["ÂÖ¨ÂºÄÊãõÊ†á", "Á´û‰∫âÊÄßÁ£ãÂïÜ", "Âçï‰∏ÄÊù•Ê∫ê", "ËØ¢‰ª∑"] }],
            "ÊÑèÂêëÂÖ¨ÂºÄ": [{ key: "publicDate", label: "ÊåÇÁΩëÊó∂Èó¥", type: "date" }, { key: "link", label: "ÂÖ¨ÂëäÈìæÊé•", type: "text" }],
            "ÂèëÂ∏ÉÂÖ¨Âëä": [{ key: "publishDate", label: "ÂèëÂ∏ÉÊó∂Èó¥", type: "date" }, { key: "openDate", label: "È¢ÑËÆ°ÂºÄÊ†áÊó∂Èó¥", type: "date" }],
            "ÂÆåÊàêËØÑÊ†á": [{ key: "evalDate", label: "ËØÑÊ†áÊó∂Èó¥", type: "date" }, { key: "evalLocation", label: "ËØÑÊ†áÂú∞ÁÇπ", type: "text" }],
            "ÂèëÂ∏É‰∏≠Ê†áÂÖ¨Á§∫": [{ key: "noticeDate", label: "ÂÖ¨Á§∫ÂèëÂ∏ÉÊó∂Èó¥", type: "date" }, { key: "winner", label: "‰∏≠Ê†áÂçï‰Ωç", type: "text" }, { key: "winAmount", label: "‰∏≠Ê†áÈáëÈ¢ù(ÂÖÉ)", type: "number" }],
            "ÂÖöÁªÑ‰ºö": [{ key: "meetDate", label: "‰ºöËÆÆÊó∂Èó¥", type: "date" }, { key: "topic", label: "ËÆÆÈ¢òÂêçÁß∞", type: "text" }],
            "‰∏ª‰ªªÂäûÂÖ¨‰ºö": [{ key: "meetDate", label: "‰ºöËÆÆÊó∂Èó¥", type: "date" }, { key: "topic", label: "ËÆÆÈ¢òÂêçÁß∞", type: "text" }],
            "Á∫∏Ë¥®ËØ∑Á§∫": [{ key: "approveDate", label: "ÊâπÂáÜÊó∂Èó¥", type: "date" }],
            "‰ªòÊ¨æ": [{ key: "submitFinanceDate", label: "Êèê‰∫§Ë¥¢Âä°Êó•Êúü", type: "date" }, { key: "payAmount", label: "ÊîØ‰ªòÈáëÈ¢ù(ÂÖÉ)", type: "number" }, { key: "payType", label: "Ê¨æÈ°πÊÄßË¥®", type: "select", options: ["È¶ñÁ¨îÊ¨æ", "ËøõÂ∫¶Ê¨æ", "Â∞æÊ¨æ", "Ë¥®‰øùÈáë"] }],
            "ÂºÄÂ∑•Â§áÊ°à": [{ key: "submitDate", label: "Â§áÊ°àÊó∂Èó¥", type: "date" }, { key: "recordType", label: "Â§áÊ°àÁ±ªÂûã", type: "select", options: ["ÁõëÁù£Á´ôÂ§áÊ°à", "Â∑•Á®ãÁßëÂ§áÊ°à"] }],
            "ËÆæËÆ°‰∫§Â∫ï": [{ key: "meetDate", label: "‰∫§Â∫ïÊó∂Èó¥", type: "date" }],
            "ÊñΩÂ∑•ÂÖ•Âú∫": [{ key: "entryDate", label: "ËøõÂú∫Êó•Êúü", type: "date" }],
            "Á´£Â∑•È™åÊî∂": [{ key: "checkDate", label: "Á´£Â∑•È™åÊî∂Êó•Êúü", type: "date" }],
            "ÁªìÁÆóÂÆ°Ê†∏": [{ key: "finishAuditDate", label: "ÂÆ°ÂÆöÊó•Êúü", type: "date" }, { key: "finalAmount", label: "ÂÆ°ÂÆöÈáëÈ¢ù(ÂÖÉ)", type: "number" }, { key: "reduceAmount", label: "Ê†∏ÂáèÈáëÈ¢ù(ÂÖÉ)", type: "number" }],
            "ËµÑÊñôÂΩíÊ°£": [{ key: "archiveDate", label: "ÂΩíÊ°£Êó•Êúü", type: "date" }]
        };

        let GLOBAL_CONFIG = {}, currentProjectId = null, currentStageIndex = null, draggedItemIndex = null, draggedProjectIndex = null, configMode = 'global', tempLocalConfig = null, editingKey = null, dragSrcType = null;
        let viewYear = new Date().getFullYear();
        let viewMonth = new Date().getMonth();
        let selectedDateStr = null;

        const DB = { get: () => JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]'), save: d => { localStorage.setItem(DB_KEY_DATA, JSON.stringify(d)); debouncedSync(); } };
        const DB_OT = { get: () => { const d = localStorage.getItem(DB_KEY_OT); return d ? JSON.parse(d) : { annual: 0, saved: 0, records: [], leaveRecords: [] } }, save: d => { localStorage.setItem(DB_KEY_OT, JSON.stringify(d)); debouncedSync(); } };
        const DB_TODO = {
            get: () => {
                const masterData = localStorage.getItem('todo_master_db');
                const oldData = localStorage.getItem('todo_db');
                if (!masterData && oldData) {
                    console.log("Ê£ÄÊµãÂà∞ÊóßÂæÖÂäûÊï∞ÊçÆÔºåÊ≠£Âú®Ëá™Âä®ËøÅÁßª...");
                    localStorage.setItem('todo_master_db', oldData);
                    return JSON.parse(oldData);
                }
                return JSON.parse(masterData || '[]');
            },
            save: (d) => {
                localStorage.setItem('todo_master_db', JSON.stringify(d));
                if (typeof debouncedSync === 'function') debouncedSync();
            }
        };
        const DB_CAL = { get: () => { const d = localStorage.getItem(DB_KEY_CAL); return d ? JSON.parse(d) : {} }, save: d => { localStorage.setItem(DB_KEY_CAL, JSON.stringify(d)); debouncedSync(); } };

        function loadConfig() {
            const local = JSON.parse(localStorage.getItem(DB_KEY_CONFIG)) || {};
            GLOBAL_CONFIG = { ...DEFAULT_CONFIG, ...local };
            Object.keys(DEFAULT_CONFIG).forEach(key => {
                if (!GLOBAL_CONFIG[key] || GLOBAL_CONFIG[key].length === 0) {
                    GLOBAL_CONFIG[key] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[key]));
                }
            });
        }
        function migrateData() { let list = DB.get(), ch = false; list.forEach(p => { p.stages.forEach(s => { if (!s.config) { s.config = JSON.parse(JSON.stringify(GLOBAL_CONFIG[s.name] || [])); ch = true } }) }); if (ch) DB.save(list); }

        window.onload = function () { initApp(); };

        function initHome() {
            const d = new Date();
            const days = ["Âë®Êó•", "Âë®‰∏Ä", "Âë®‰∫å", "Âë®‰∏â", "Âë®Âõõ", "Âë®‰∫î", "Âë®ÂÖ≠"];
            document.getElementById('welcomeDate').innerText = `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó• ¬∑ ${days[d.getDay()]}`;
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
            const ot = DB_OT.get();
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            (ot.leaveRecords || []).forEach(l => { if (l.type == 'Âπ¥ÂÅá') usedAnnual += parseFloat(l.days); if (l.type == 'Â≠ò‰ºë') usedSaved += parseFloat(l.days); });
            (ot.records || []).forEach(r => { if (r.status != 'used') activeOt += parseFloat(r.days); });
            const total = (parseFloat(ot.annual || 0) - usedAnnual) + (parseFloat(ot.saved || 0) - usedSaved) + activeOt;
            document.getElementById('homeOtDays').innerText = total;
            renderTodos();
        }

        function renderCalendar(y, m) {
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const todayDate = new Date();
            const isCurrentMonth = (y === todayDate.getFullYear() && m === todayDate.getMonth());
            const today = todayDate.getDate();
            const logs = DB_CAL.get();
            document.getElementById('calMonth').innerText = `${y}Âπ¥ ${m + 1}Êúà`;
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '<div class="cal-day-name">Êó•</div><div class="cal-day-name">‰∏Ä</div><div class="cal-day-name">‰∫å</div><div class="cal-day-name">‰∏â</div><div class="cal-day-name">Âõõ</div><div class="cal-day-name">‰∫î</div><div class="cal-day-name">ÂÖ≠</div>';
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let i = 1; i <= daysInMonth; i++) {
                const mStr = (m + 1).toString().padStart(2, '0');
                const dStr = i.toString().padStart(2, '0');
                const dateKey = `${y}-${mStr}-${dStr}`;
                let cls = 'cal-day';
                if (isCurrentMonth && i === today) cls += ' today';
                if (logs[dateKey]) cls += ' has-log';
                const div = document.createElement('div');
                div.className = cls;
                div.innerText = i;
                div.onclick = () => openDayLog(dateKey);
                grid.appendChild(div);
            }
        }

        function changeMonth(delta) {
            viewMonth += delta;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderCalendar(viewYear, viewMonth);
        }

        function goToday() {
            const d = new Date();
            viewYear = d.getFullYear();
            viewMonth = d.getMonth();
            renderCalendar(viewYear, viewMonth);
        }

        function openDayLog(dateStr) {
            selectedDateStr = dateStr;
            document.getElementById('logDateTitle').innerText = dateStr;
            const logs = DB_CAL.get();
            document.getElementById('logContent').value = logs[dateStr] || '';
            openModal('dayLogModal');
        }

        function saveDayLog() {
            if (!selectedDateStr) return;
            const content = document.getElementById('logContent').value.trim();
            const logs = DB_CAL.get();
            if (content) { logs[selectedDateStr] = content; } else { delete logs[selectedDateStr]; }
            DB_CAL.save(logs);
            closeModal('dayLogModal');
            renderCalendar(viewYear, viewMonth);
        }

        function renderTodos() {
            const list = DB_TODO.get();
            const container = document.getElementById('todoList');
            if (!container) return;
            container.innerHTML = '';
            const activeTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => !t.done);
            if (activeTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">üéâ Â§™Ê£í‰∫ÜÔºåÊâÄÊúâÂæÖÂäûÂ∑≤Ê∏ÖÁ©∫ÔºÅ</div>';
                return;
            }
            activeTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'todo-item';
                div.innerHTML = `
                    <div class="todo-checkbox" onclick="toggleTodo(${t.originIdx})"></div>
                    <div class="todo-text">${t.text}</div>
                    <button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>`;
                container.appendChild(div);
            });
        }

        function addTodo() {
            const val = document.getElementById('todoInput').value.trim();
            if (!val) return;
            const list = DB_TODO.get();
            list.unshift({ text: val, done: false, createDate: new Date().toISOString() });
            DB_TODO.save(list);
            document.getElementById('todoInput').value = '';
            renderTodos();
            initHome();
        }

        function toggleTodo(originIdx) {
            const list = DB_TODO.get();
            const item = list[originIdx];
            item.done = !item.done;
            if (item.done) {
                const now = new Date();
                const timeStr = `${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                item.completedAt = timeStr;
            } else {
                delete item.completedAt;
            }
            DB_TODO.save(list);
            renderTodos();
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function deleteTodo(originIdx) {
            if (!confirm("ÂΩªÂ∫ïÂà†Èô§Ôºü")) return;
            const list = DB_TODO.get();
            list.splice(originIdx, 1);
            DB_TODO.save(list);
            renderTodos();
            if (document.getElementById('todoHistoryModal').classList.contains('open')) {
                renderHistoryList();
            }
        }

        function openTodoHistory() {
            renderHistoryList();
            openModal('todoHistoryModal');
        }

        function renderHistoryList() {
            const list = DB_TODO.get();
            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';
            const doneTodos = list.map((t, i) => ({ ...t, originIdx: i })).filter(t => t.done);
            if (doneTodos.length === 0) {
                container.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂΩíÊ°£ËÆ∞ÂΩï</div>';
                return;
            }
            doneTodos.forEach(t => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                        <div style="flex:1; text-decoration:line-through; color:#999; font-size:14px; margin-right:10px; word-break:break-all;">${t.text}</div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <button class="btn-restore" onclick="toggleTodo(${t.originIdx})">ÊÅ¢Â§ç</button>
                            <button class="btn-delete-icon" onclick="deleteTodo(${t.originIdx})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="history-time">üèÅ ÂÆåÊàê‰∫éÔºö${t.completedAt || 'Êó©ÊúüËÆ∞ÂΩï'}</div>
                `;
                container.appendChild(div);
            });
        }

        function getDeadline(dateStr) { if (!dateStr) return "Êú™Áü•"; const d = new Date(dateStr); const target = new Date(d.getFullYear(), d.getMonth() + 2, 0); return target.toISOString().split('T')[0]; }

        function renderOtPage() {
            const data = DB_OT.get();
            document.getElementById('inpAnnual').value = data.annual;
            document.getElementById('inpSaved').value = data.saved;
            let usedAnnual = 0, usedSaved = 0, activeOt = 0;
            const lvContainer = document.getElementById('leaveListContainer');
            lvContainer.innerHTML = '';
            (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((l, idx) => {
                const days = parseFloat(l.days);
                let typeColor = '#999';
                if (l.type === 'Âπ¥ÂÅá') { usedAnnual += days; typeColor = '#007AFF'; }
                if (l.type === 'Â≠ò‰ºë') { usedSaved += days; typeColor = '#AF52DE'; }
                const div = document.createElement('div');
                div.className = 'ot-list-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `<div style="flex:1;"><div style="font-weight:600"><span class="leave-type-tag" style="background:${typeColor}">${l.type || '‰ºëÂÅá'}</span>${l.date} <span style="color:#FF3B30">-${days}Â§©</span></div><div style="font-size:12px;color:#999;margin-left:5px;">${l.note || '-'}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); delLeaveItem(${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                div.onclick = () => editLeave(idx);
                lvContainer.appendChild(div);
            });
            const otContainer = document.getElementById('otListContainer');
            otContainer.innerHTML = '';
            (data.records || []).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const div = document.createElement('div');
                div.className = `ot-card ${r.status === 'used' ? 'used' : ''}`;
                let actionHtml = '';
                let statusBadge = '';
                const trashIcon = `<button class="btn-delete-icon" onclick="delOtItem('${r.id}')" style="margin-left:0;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                if (r.status === 'used') {
                    statusBadge = `<span class="ot-badge">Â∑≤‰ºë</span>`;
                    actionHtml = `<div style="display:flex;justify-content:flex-end;align-items:center;margin-top:5px;"><span style="font-size:12px;margin-right:10px;">ÂΩíÊ°£: ${r.usedDate}</span> ${trashIcon}</div>`;
                } else {
                    activeOt += parseFloat(r.days);
                    const deadline = getDeadline(r.date);
                    statusBadge = `<span class="ot-badge" style="background:#e3f2fd;color:#007AFF">ÂæÖ‰ºë</span>`;
                    actionHtml = `<div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;"><div class="ot-deadline">ÊúâÊïàÊúüËá≥: ${deadline}</div><div style="display:flex;align-items:center;gap:5px;"><button class="btn-mini action" onclick="preUseOt('${r.id}')">‚úÖ ‰ºëÂÆå</button>${trashIcon}</div></div>`;
                }
                div.innerHTML = `<div class="ot-card-header"><div class="ot-date">${r.date} <span style="font-size:14px;margin-left:5px;">+${r.days}Â§©</span></div>${statusBadge}</div><div class="ot-desc">${r.note || 'Êó†Â§áÊ≥®'}</div>${actionHtml}`;
                otContainer.appendChild(div);
            });
            const remAnnual = parseFloat(data.annual || 0) - usedAnnual;
            const remSaved = parseFloat(data.saved || 0) - usedSaved;
            document.getElementById('dispAnnual').innerText = remAnnual;
            document.getElementById('dispSaved').innerText = remSaved;
            document.getElementById('dispOt').innerText = activeOt;
            document.getElementById('otTotalDays').innerText = remAnnual + remSaved + activeOt;
        }

        function saveBaseLeave() { const data = DB_OT.get(); data.annual = document.getElementById('inpAnnual').value || 0; data.saved = document.getElementById('inpSaved').value || 0; DB_OT.save(data); renderOtPage(); }
        function addOvertime() { const date = document.getElementById('otDate').value; const days = document.getElementById('otDays').value; if (!date || !days) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥"); const data = DB_OT.get(); data.records.push({ id: Date.now().toString(), date, days, note: document.getElementById('otNote').value, status: 'active' }); DB_OT.save(data); closeModal('addOtModal'); renderOtPage(); }
        function preUseOt(id) { document.getElementById('useOtId').value = id; document.getElementById('useOtDate').value = new Date().toISOString().split('T')[0]; openModal('useOtModal'); }
        function confirmUseOt() { const id = document.getElementById('useOtId').value; const date = document.getElementById('useOtDate').value; if (!date) return alert("ËØ∑Â°´ÂÜôÊó•Êúü"); const data = DB_OT.get(); const item = data.records.find(r => r.id === id); if (item) { item.status = 'used'; item.usedDate = date; DB_OT.save(data); closeModal('useOtModal'); renderOtPage(); } }
        function delOtItem(id) { if (confirm("Âà†Èô§Ê≠§ËÆ∞ÂΩïÔºü")) { const data = DB_OT.get(); data.records = data.records.filter(r => r.id !== id); DB_OT.save(data); renderOtPage(); } }
        function openNewLeave() { document.getElementById('lvEditIndex').value = ''; document.getElementById('leaveModalTitle').innerText = 'ÂΩïÂÖ•‰ºëÂÅá'; document.getElementById('lvType').value = 'Âπ¥ÂÅá'; document.getElementById('lvDate').value = new Date().toISOString().split('T')[0]; document.getElementById('lvDays').value = ''; document.getElementById('lvNote').value = ''; document.getElementById('lvSaveBtn').innerText = 'Á°ÆËÆ§'; openModal('addLeaveModal'); }
        function editLeave(idx) {
            const data = DB_OT.get();
            const sorted = (data.leaveRecords || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const record = sorted[idx];
            if (!record) return alert('ËÆ∞ÂΩï‰∏çÂ≠òÂú®');
            document.getElementById('lvEditIndex').value = idx;
            document.getElementById('leaveModalTitle').innerText = 'ÁºñËæë‰ºëÂÅá';
            document.getElementById('lvType').value = record.type || 'Âπ¥ÂÅá';
            document.getElementById('lvDate').value = record.date;
            document.getElementById('lvDays').value = record.days;
            document.getElementById('lvNote').value = record.note || '';
            document.getElementById('lvSaveBtn').innerText = '‰øùÂ≠ò‰øÆÊîπ';
            openModal('addLeaveModal');
        }
        function saveLeaveRecord() {
            const editIdx = document.getElementById('lvEditIndex').value;
            const type = document.getElementById('lvType').value;
            const date = document.getElementById('lvDate').value;
            const days = document.getElementById('lvDays').value;
            if (!date || !days) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥");
            const data = DB_OT.get();
            if (!data.leaveRecords) data.leaveRecords = [];
            if (editIdx === '') {
                data.leaveRecords.push({ type, date, days, note: document.getElementById('lvNote').value });
            } else {
                const sorted = data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                const record = sorted[parseInt(editIdx)];
                if (record) { record.type = type; record.date = date; record.days = days; record.note = document.getElementById('lvNote').value; }
            }
            DB_OT.save(data);
            closeModal('addLeaveModal');
            renderOtPage();
        }
        function delLeaveItem(idx) { if (confirm("Âà†Èô§Ê≠§‰ºëÂÅáËÆ∞ÂΩïÔºüÂ∞ÜÊÅ¢Â§çÂØπÂ∫îÁöÑÈ¢ùÂ∫¶„ÄÇ")) { const data = DB_OT.get(); data.leaveRecords.sort((a, b) => new Date(b.date) - new Date(a.date)); data.leaveRecords.splice(idx, 1); DB_OT.save(data); renderOtPage(); } }

        function openConfigModal(mode, stageIndex = null) {
            configMode = mode;
            if (mode === 'global') { renderConfigContainer(); } else {
                currentStageIndex = stageIndex;
                const p = DB.get().find(x => x.id === currentProjectId);
                const stage = p.stages[stageIndex];
                tempLocalConfig = JSON.parse(JSON.stringify(stage.config));
                editingKey = 'LOCAL_EDIT';
                document.getElementById('configModalTitle').innerText = 'ÈÖçÁΩÆÔºö' + stage.name;
                renderConfigFields(tempLocalConfig);
            }
            openModal('configModal');
        }

        function renderConfigContainer() {
            const container = document.getElementById('configContainer');
            container.innerHTML = '';

            // ËØªÂèñÁßÅÊúâËäÇÁÇπÊò†Â∞ÑË°® (Ê†ºÂºè: { "È°πÁõÆÂâçÊúüÊâãÁª≠": ["ÊàëÁöÑÁßÅÊúâËäÇÁÇπA"], "ÈááË¥≠ÊâãÁª≠": [] })
            const customMap = GLOBAL_CONFIG._customNodeMap || {};

            Object.keys(NODE_CATEGORIES).forEach(cat => {
                // 1. Ê∏≤ÊüìÂàÜÁ±ªÊ†áÈ¢ò
                const catTitle = document.createElement('div');
                catTitle.className = 'config-category-title';
                catTitle.innerText = cat;
                container.appendChild(catTitle);

                const grid = document.createElement('div');
                grid.className = 'config-node-grid';

                // 2. Ê∏≤Êüì„ÄêÂÖ¨ÂÖ±ËäÇÁÇπ„Äë (ÈªëËâ≤)
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const nodeBtn = document.createElement('div');
                    nodeBtn.className = 'config-node-item';
                    nodeBtn.innerText = nodeName;
                    nodeBtn.onclick = () => openNodeDetailEditor(nodeName);
                    grid.appendChild(nodeBtn);
                });

                // 3. Ê∏≤Êüì„ÄêÁßÅÊúâËäÇÁÇπ„Äë (Á¥´Ëâ≤Ôºå‰ªÖÂ±û‰∫éÂΩìÂâçÂàÜÁ±ª)
                if (customMap[cat] && Array.isArray(customMap[cat])) {
                    customMap[cat].forEach(nodeName => {
                        const nodeBtn = document.createElement('div');
                        nodeBtn.className = 'config-node-item';
                        nodeBtn.innerText = nodeName;
                        // üåü ËßÜËßâÂå∫ÂàÜÔºöÁßÅÊúâËäÇÁÇπÂ∏¶Á¥´Ëâ≤ËæπÊ°Ü
                        nodeBtn.style.border = '1px solid var(--purple)';
                        nodeBtn.style.color = 'var(--purple)';
                        nodeBtn.style.position = 'relative';

                        // Â¢ûÂä†‰∏Ä‰∏™Â∞èËßíÊ†áË°®Á§∫ÁßÅÊúâ
                        const badge = document.createElement('span');
                        badge.innerText = 'ÁßÅ';
                        badge.style.cssText = 'position:absolute; top:2px; right:2px; font-size:8px; background:var(--purple); color:white; padding:1px 3px; border-radius:4px;';
                        nodeBtn.appendChild(badge);

                        nodeBtn.onclick = () => openNodeDetailEditor(nodeName);
                        grid.appendChild(nodeBtn);
                    });
                }
                // üåü Êñ∞Â¢ûÂáΩÊï∞ÔºöÂàÜÈó®Âà´Á±ªÊñ∞Âª∫ÁßÅÊúâËäÇÁÇπ
                function createNewNodeDefinition(categoryName) {
                    const name = prompt(`Ë¶ÅÂú®„Äê${categoryName}„Äë‰∏ãÊñ∞Âª∫‰ªÄ‰πàËäÇÁÇπÔºü`);
                    if (!name) return;

                    // Ê£ÄÊü•ÈáçÂêç
                    if (GLOBAL_CONFIG[name] || DEFAULT_CONFIG[name]) {
                        return alert("ËØ•ËäÇÁÇπÂêçÁß∞Â∑≤Â≠òÂú®ÔºÅ");
                    }

                    // 1. ÂàùÂßãÂåñËäÇÁÇπÂ≠óÊÆµÈÖçÁΩÆ (ÈªòËÆ§Áªô‰∏§‰∏™ÈÄöÁî®Â≠óÊÆµ)
                    GLOBAL_CONFIG[name] = [
                        { key: "finishDate", label: "ÂÆåÊàêÊó∂Èó¥", type: "date" },
                        { key: "remark", label: "Â§áÊ≥®", type: "text" }
                    ];

                    // 2. ËÆ∞ÂΩïÂà∞ÁßÅÊúâÊò†Â∞ÑË°® (KeyÊòØÂàÜÁ±ªÂêç, ValueÊòØËäÇÁÇπÊï∞ÁªÑ)
                    // ÁªìÊûÑÁ§∫‰æã: { "È°πÁõÆÂâçÊúüÊâãÁª≠": ["ÊñáÁâ©ÂÆ°Êâπ", "ÁªøÂåñËøÅÁßª"], "ÈááË¥≠ÊâãÁª≠": [] }
                    if (!GLOBAL_CONFIG._customNodeMap) GLOBAL_CONFIG._customNodeMap = {};
                    if (!GLOBAL_CONFIG._customNodeMap[categoryName]) GLOBAL_CONFIG._customNodeMap[categoryName] = [];

                    GLOBAL_CONFIG._customNodeMap[categoryName].push(name);

                    // 3. ‰øùÂ≠òÂπ∂Âà∑Êñ∞
                    localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                    debouncedSync();
                    renderConfigContainer(); // Âà∑Êñ∞ÁïåÈù¢Ôºå‰Ω†Â∞±ËÉΩÁúãÂà∞Êñ∞Âä†ÁöÑÊåâÈíÆ‰∫Ü

                    // 4. Ëá™Âä®ÊâìÂºÄÁºñËæëÁ™óÂè£ÔºåÊñπ‰æøÁ´ãÂàªÂä†Â≠óÊÆµ
                    openNodeDetailEditor(name);
                }
                // 4. Ê∏≤Êüì„Äê+ Ëá™ÂÆö‰πâÊñ∞Â¢û„ÄëÊåâÈíÆ (Â∞±Âú®ÂΩìÂâçÂàÜÁ±ªÈáå)
                const addBtn = document.createElement('div');
                addBtn.className = 'config-node-item';
                addBtn.style.border = '1px dashed #999';
                addBtn.style.color = '#999';
                addBtn.style.fontSize = '12px';
                addBtn.innerHTML = '+ Ëá™ÂÆö‰πâ<br>Êñ∞Â¢û';
                // üåü ÂÖ≥ÈîÆÔºöÁÇπÂáªÊó∂ÊääÂΩìÂâçÂàÜÁ±ªÂêç cat ‰º†ËøõÂéª
                addBtn.onclick = () => createNewNodeDefinition(cat);
                grid.appendChild(addBtn);

                container.appendChild(grid);
            });
        }

        let currentEditingNodeName = null;
        function openNodeDetailEditor(nodeName) {
            currentEditingNodeName = nodeName;
            if (!GLOBAL_CONFIG[nodeName]) {
                GLOBAL_CONFIG[nodeName] = JSON.parse(JSON.stringify(DEFAULT_CONFIG[nodeName] || []));
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            }
            const config = GLOBAL_CONFIG[nodeName] || [];
            const modal = document.getElementById('nodeDetailModal');
            document.getElementById('nodeDetailTitle').innerText = nodeName;
            const fieldList = document.getElementById('nodeFieldList');
            fieldList.innerHTML = '';
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) {
                    optionsStr = `<br><span class="node-field-type">ÈÄâÈ°π: ${field.options.join(', ')}</span>`;
                }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">Â≠óÊÆµ: ${field.key} | Á±ªÂûã: ${field.type}${optionsStr}</div></div><button class="btn-delete-icon" onclick="event.stopPropagation(); deleteConfigField('${nodeName}', ${idx})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                fieldList.appendChild(item);
            });
            modal.classList.add('open');
        }

        function closeNodeDetailEditor() {
            document.getElementById('nodeDetailModal').classList.remove('open');
            currentEditingNodeName = null;
        }

        function saveNodeDetailEditor() {
            loadConfig();
            DB.get();
            debouncedSync();
            closeNodeDetailEditor();
            showToast('‚úÖ ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
        }

        function deleteConfigField(nodeName, fieldIdx) {
            if (confirm('Á°ÆÂÆöÂà†Èô§Ê≠§Â≠óÊÆµÂêóÔºü')) {
                if (GLOBAL_CONFIG[nodeName]) {
                    GLOBAL_CONFIG[nodeName].splice(fieldIdx, 1);
                    localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                    openNodeDetailEditor(nodeName);
                    debouncedSync();
                }
            }
        }

        function addNewConfigField() {
            const fieldLabel = prompt('ËØ∑ËæìÂÖ•Â≠óÊÆµÂêçÁß∞ (‰æãÂ¶Ç: ÂÆûÈôÖÂºÄÂ∑•Êó∂Èó¥):');
            if (!fieldLabel) return;
            const fieldKey = 'custom_' + Date.now();
            const typeInput = prompt('ËØ∑ËæìÂÖ•Â≠óÊÆµÁ±ªÂûãÁºñÂè∑:\n1 - Êó•Êúü (Date)\n2 - ÈáëÈ¢ù/Êï∞Â≠ó (Number)\n3 - ÊñáÂ≠ó (Text)\n4 - ‰∏ãÊãâÈÄâÈ°π (Select)', '1');
            let fieldType = 'text';
            let options = [];
            if (typeInput === '1') fieldType = 'date';
            else if (typeInput === '2') fieldType = 'number';
            else if (typeInput === '3') fieldType = 'text';
            else if (typeInput === '4') {
                fieldType = 'select';
                const optStr = prompt('ËØ∑ËæìÂÖ•ÈÄâÈ°πÔºåÁî®ÈÄóÂè∑ÈöîÂºÄ:', 'ÂêàÊ†º,‰∏çÂêàÊ†º');
                if (optStr) options = optStr.split(/[,Ôºå]/).map(s => s.trim());
            } else { return; }
            if (!GLOBAL_CONFIG[currentEditingNodeName]) { GLOBAL_CONFIG[currentEditingNodeName] = []; }
            GLOBAL_CONFIG[currentEditingNodeName].push({ key: fieldKey, label: fieldLabel, type: fieldType, options: options });
            localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
            openNodeDetailEditor(currentEditingNodeName);
            debouncedSync();
        }

        function renderConfigFields(config) {
            const fieldList = document.getElementById('nodeFieldList');
            if (!fieldList) return;
            fieldList.innerHTML = '';
            if (!config || config.length === 0) { fieldList.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">ËØ•ËäÇÁÇπÊöÇÊó†ÈÖçÁΩÆ</div>'; return; }
            config.forEach((field, idx) => {
                const item = document.createElement('div');
                item.className = 'node-field-item';
                let optionsStr = '';
                if (field.options && field.options.length > 0) { optionsStr = `<br><span class="node-field-type">ÈÄâÈ°π: ${field.options.join(', ')}</span>`; }
                item.innerHTML = `<div class="node-field-info"><div class="node-field-name">${field.label}</div><div class="node-field-type">Â≠óÊÆµ: ${field.key} | Á±ªÂûã: ${field.type}${optionsStr}</div></div>`;
                fieldList.appendChild(item);
            });
        }

        function handleConfigSave() {
            if (configMode === 'global') {
                localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(GLOBAL_CONFIG));
                debouncedSync();
                alert('‚úÖ ÂÖ®Â±ÄÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
                closeModal('configModal');
            } else if (configMode === 'local') {
                const list = DB.get();
                const p = list.find(x => x.id === currentProjectId);
                if (p && p.stages[currentStageIndex]) {
                    p.stages[currentStageIndex].config = tempLocalConfig;
                    DB.save(list);
                    alert('‚úÖ ËäÇÁÇπÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
                    closeModal('configModal');
                    refreshDetail(p);
                }
            }
        }

        function createProject() { const n = document.getElementById('newProjectName').value; if (!n) return alert("ËØ∑ËæìÂÖ•ÂêçÁß∞"); DB.save([{ id: Date.now(), name: n, type: document.getElementById('newProjectType').value, createDate: new Date().toLocaleDateString(), stages: [] }, ...DB.get()]); closeModal('createModal'); goToPage('projectList'); }
        function openNodeLibrary() {
            const container = document.getElementById('nodeLibraryGrid');
            container.innerHTML = '';

            // ËØªÂèñÁßÅÊúâÊò†Â∞Ñ
            const customMap = GLOBAL_CONFIG._customNodeMap || {};

            Object.keys(NODE_CATEGORIES).forEach(cat => {
                // Ê∏≤ÊüìÂàÜÁ±ªÂ§¥
                const header = document.createElement('div');
                header.style.cssText = "grid-column: 1 / -1; font-size: 13px; font-weight: bold; color: #888; margin: 15px 0 5px 0; padding-left: 5px; border-left: 3px solid var(--primary);";
                header.innerText = cat;
                container.appendChild(header);

                // 1. ÂÖàÂàóÂá∫ÂÖ¨ÂÖ±ËäÇÁÇπ
                NODE_CATEGORIES[cat].forEach(nodeName => {
                    const btn = document.createElement('div');
                    btn.className = 'node-option';
                    btn.innerText = '+ ' + nodeName;
                    btn.onclick = () => addStage(nodeName);
                    container.appendChild(btn);
                });

                // 2. üåü Á¥ßÊé•ÁùÄÂàóÂá∫ËØ•ÂàÜÁ±ª‰∏ãÁöÑ„ÄêÁßÅÊúâËäÇÁÇπ„Äë
                if (customMap[cat] && Array.isArray(customMap[cat])) {
                    customMap[cat].forEach(nodeName => {
                        const btn = document.createElement('div');
                        btn.className = 'node-option';
                        btn.innerText = '+ ' + nodeName;
                        // Ê†∑ÂºèÂå∫ÂàÜÔºöÁ¥´Ëâ≤ÊñáÂ≠ó
                        btn.style.color = 'var(--purple)';
                        btn.style.borderColor = 'var(--purple)';
                        btn.onclick = () => addStage(nodeName);
                        container.appendChild(btn);
                    });
                }
            });

            openModal('nodeLibraryModal');
        }

        function addStage(nodeName) {
            if (!currentProjectId) return alert('ËØ∑ÂÖàÂú®Â∑•Á®ãËØ¶ÊÉÖÈ°µÊâìÂºÄË¶ÅÊ∑ªÂä†ËäÇÁÇπÁöÑÂ∑•Á®ã„ÄÇ');
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('Êú™ÊâæÂà∞ÂΩìÂâçÂ∑•Á®ã');
            const sourceCfg = (typeof GLOBAL_CONFIG === 'object' && GLOBAL_CONFIG[nodeName]) ? GLOBAL_CONFIG[nodeName] : (DEFAULT_CONFIG[nodeName] || []);
            const cfg = JSON.parse(JSON.stringify(sourceCfg));
            const newStage = { name: nodeName, status: 'waiting', config: cfg, data: {} };
            p.stages.push(newStage);
            DB.save(list);
            closeModal('nodeLibraryModal');
            refreshDetail(p);
        }

        function openDetail(id) {
            currentProjectId = id;
            const p = DB.get().find(x => x.id == id);
            // üåü Ê†∏ÂøÉ‰øÆÂ§çÔºöÊõ¥Êñ∞ËØ¶ÊÉÖÈ°µÈ°∂ÈÉ®ÂØºËà™Êï∞ÊçÆ
            document.getElementById('navDetailTitle').innerText = p.name;
            const typeMap = { 'special': '‰∏ìÈ°πÂ∑•Á®ã', 'odd': 'Èõ∂ÊòüÂ∑•Á®ã', 'repair': 'Êä¢‰øÆÂ∑•Á®ã' };
            document.getElementById('navDetailType').innerText = typeMap[p.type];
            goToPage('projectDetail');
            refreshDetail(p);
        }

        function refreshDetail(p) {
            const c = document.getElementById('stagesContainer'); c.innerHTML = '';
            const prev = document.getElementById('previewFlow'); prev.innerHTML = '';
            p.stages.forEach((s, i) => {
                const conf = s.config || [];
                const getDisplayHtml = (mode) => {
                    return conf.map(f => {
                        if (!s.data[f.key]) return '';
                        let displayVal = s.data[f.key];
                        if (f.type === 'number') displayVal = '¬•' + displayVal;
                        if (mode === 'preview') return `<div class="preview-kv"><span class="preview-k">${f.label}:</span><span class="preview-v">${displayVal}</span></div>`;
                        return `<div class="data-item"><span class="data-label">${f.label}</span><span class="data-value">${displayVal}</span></div>`;
                    }).join('');
                };
                if (s.status === 'done') { prev.innerHTML += `<div class="preview-item done"><div class="preview-item-title"><span>${s.name}</span></div><div class="preview-data-table">${getDisplayHtml('preview')}</div></div>`; }
                let det = ''; if (s.status !== 'waiting') { det = '<div class="data-grid">' + getDisplayHtml('card') + '</div>'; }
                const ico = s.status === 'done' ? '‚úÖ' : (s.status === 'processing' ? 'üî•' : '‚è≥');
                c.innerHTML += `<div class="stage-card ${s.status}"><div class="node-sort-zone"><button class="node-sort-btn" onclick="moveStageUp(${i})">‚Üë</button><button class="node-sort-btn" onclick="moveStageDown(${i})">‚Üì</button></div><div class="card-content" onclick="openStageEdit(${i})"><div class="card-actions-fixed"><button class="icon-btn-card btn-edit-struct" onclick="event.stopPropagation();openConfigModal('local', ${i})">‚öôÔ∏è</button><button class="btn-delete-icon" style="margin-left:0;" onclick="event.stopPropagation();deleteStage(${i})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="status-bar ${s.status}"></div><div class="card-header-row"><span class="card-title">${s.name}</span><span class="card-status-text">${ico}</span></div>${det}</div></div>`;
            });
        }

        function moveStageUp(i) {
            if (i === 0) return;
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            const temp = p.stages[i]; p.stages[i] = p.stages[i - 1]; p.stages[i - 1] = temp;
            DB.save(list); refreshDetail(p);
        }
        function moveStageDown(i) {
            const list = DB.get(); const p = list.find(x => x.id == currentProjectId);
            if (i === p.stages.length - 1) return;
            const temp = p.stages[i]; p.stages[i] = p.stages[i + 1]; p.stages[i + 1] = temp;
            DB.save(list); refreshDetail(p);
        }

        function openStageEdit(i) {
            if (!currentProjectId) return alert('ËØ∑ÂÖàÊâìÂºÄÂ∑•Á®ãËØ¶ÊÉÖÂÜçÁºñËæëËäÇÁÇπ');
            currentStageIndex = i;
            const list = DB.get();
            const p = list.find(x => x.id == currentProjectId);
            if (!p) return alert('Êú™ÊâæÂà∞Â∑•Á®ã');
            const stage = p.stages[i];
            document.getElementById('formTitle').innerText = `${stage.name} ‚Äî ÂΩïÂÖ•`;
            const container = document.getElementById('dynamicFormContainer');
            container.innerHTML = '';
            const cfg = stage.config || [];
            if (!cfg.length) { container.innerHTML = '<div style="color:#666;font-size:13px">ËØ•ËäÇÁÇπÊó†ÂèØÂΩïÂÖ•Â≠óÊÆµ„ÄÇ</div>'; openModal('dynamicFormModal'); return; }
            cfg.forEach(f => {
                const wrap = document.createElement('div');
                wrap.style.marginBottom = '10px';
                const lbl = document.createElement('div');
                lbl.style.fontSize = '13px'; lbl.style.marginBottom = '4px'; lbl.innerText = f.label;
                wrap.appendChild(lbl);
                let inputEl;
                const curVal = (stage.data && stage.data[f.key]) ? stage.data[f.key] : '';
                if (f.type === 'select') {
                    inputEl = document.createElement('select');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    (f.options || []).forEach(opt => { const o = document.createElement('option'); o.value = opt; o.innerText = opt; if (opt === curVal) o.selected = true; inputEl.appendChild(o); });
                } else {
                    inputEl = document.createElement('input');
                    inputEl.id = `f_${f.key}`; inputEl.className = 'input-box';
                    if (f.type === 'date') { inputEl.type = 'date'; inputEl.max = '2099-12-31'; inputEl.oninput = function () { if (this.value.length > 10) this.value = this.value.slice(0, 10); }; }
                    else if (f.type === 'number') inputEl.type = 'number';
                    else inputEl.type = 'text';
                    inputEl.value = curVal;
                }
                wrap.appendChild(inputEl);
                container.appendChild(wrap);
            });
            openModal('dynamicFormModal');
        }

        function editProjectName() {
            const p = DB.get().find(x => x.id === currentProjectId);
            const newName = prompt("‰øÆÊîπÂ∑•Á®ãÂêçÁß∞:", p.name);
            if (newName && newName !== p.name) {
                const list = DB.get();
                list.find(x => x.id === currentProjectId).name = newName;
                DB.save(list);
                // Êõ¥Êñ∞È°∂ÈÉ®Ê†áÈ¢ò
                document.getElementById('navDetailTitle').innerText = newName;
            }
        }

        function saveDynamicData() {
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            const stage = p.stages[currentStageIndex];
            let nd = {}; let full = true;
            stage.config.forEach(f => {
                const el = document.getElementById(`f_${f.key}`);
                if (el) { nd[f.key] = el.value; if (el.value === '') full = false; }
            });
            stage.data = { ...stage.data, ...nd };
            stage.status = Object.values(nd).some(v => v) ? (full ? 'done' : 'processing') : 'waiting';
            DB.save(list); closeModal('dynamicFormModal'); refreshDetail(p);
        }
        function deleteStage(i) { if (confirm("Âà†ËäÇÁÇπÔºü")) { const l = DB.get(); const p = l.find(x => x.id == currentProjectId); p.stages.splice(i, 1); DB.save(l); refreshDetail(p); } }

        function renderProjects() {
            const list = DB.get();
            const cs = document.getElementById('container_special');
            const co = document.getElementById('container_odd');
            const cr = document.getElementById('container_repair');
            cs.innerHTML = ''; co.innerHTML = ''; cr.innerHTML = '';
            let c1 = 0, c2 = 0, c3 = 0;
            list.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `<div class="list-item-content" onclick="openDetail(${p.id})"><div style="display:flex; flex-direction:column; overflow:hidden;"><div class="list-item-title" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.name}</div><div class="list-item-date">${p.createDate}</div></div><button class="btn-delete-icon" onclick="deleteProject(event, ${p.id})"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div><div class="list-sort-zone"><button class="sort-btn up" onclick="moveProjUp(${i}, '${p.type}')">‚Üë</button><button class="sort-btn down" onclick="moveProjDown(${i}, '${p.type}')">‚Üì</button></div>`;
                if (p.type === 'special') { cs.appendChild(d); c1++; } else if (p.type === 'odd') { co.appendChild(d); c2++; } else { cr.appendChild(d); c3++; }
            });
            document.getElementById('c_s').innerText = c1; document.getElementById('c_o').innerText = c2; document.getElementById('c_r').innerText = c3;
        }

        function deleteProject(e, id) {
            e.stopPropagation();
            if (confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÂΩªÂ∫ïÂà†Èô§Ëøô‰∏™Â∑•Á®ãÂêóÔºü\nÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºÅ')) {
                let list = DB.get(); list = list.filter(p => p.id !== id);
                DB.save(list); renderProjects();
            }
        }
        function moveProjUp(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i - 1; k >= 0; k--) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }
        function moveProjDown(i, type) {
            const list = DB.get();
            let targetIndex = -1;
            for (let k = i + 1; k < list.length; k++) { if (list[k].type === type) { targetIndex = k; break; } }
            if (targetIndex !== -1) { const temp = list[i]; list[i] = list[targetIndex]; list[targetIndex] = temp; DB.save(list); renderProjects(); }
        }

        function exportData() { const d = { v: "44.0", d: new Date(), p: DB.get(), c: GLOBAL_CONFIG, ot: DB_OT.get(), todo: DB_TODO.get(), cal: DB_CAL.get() }; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], { type: "json" })); a.download = `backup_${Date.now()}.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importData(i) {
            if (!i.files || !i.files[0]) return alert("‚ùå Ê≤°ÈÄâÊñá‰ª∂ÔºÅ");
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    alert("üîç Ê≠£Âú®Ëß£ÊûêÂπ∂ÂéªÈáç...");
                    const b = JSON.parse(e.target.result);
                    const impP = b.p || b.projects || []; const impConf = b.c || b.config || {}; const impOt = b.ot || b.attendance || {}; const impTodo = b.todo || []; const impCal = b.cal || b.calendar || {};
                    const currP = JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]');
                    const currConf = JSON.parse(localStorage.getItem(DB_KEY_CONFIG) || '{}');
                    const currOt = JSON.parse(localStorage.getItem(DB_KEY_OT) || '{"records":[], "leaveRecords":[]}');
                    const projectMap = new Map(); currP.forEach(p => projectMap.set(p.id, p)); impP.forEach(p => projectMap.set(p.id, p));
                    const mergedProjects = Array.from(projectMap.values());
                    const mergedOt = { annual: currOt.annual || impOt.annual, saved: currOt.saved || impOt.saved, records: [...(currOt.records || []), ...(impOt.records || [])], leaveRecords: [...(currOt.leaveRecords || []), ...(impOt.leaveRecords || [])] };
                    const mergedTodo = [...(JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]')), ...impTodo];
                    const mergedCal = { ...impCal, ...JSON.parse(localStorage.getItem(DB_KEY_CAL) || '{}') };
                    const mergedConfig = { ...impConf, ...currConf };
                    localStorage.setItem(DB_KEY_DATA, JSON.stringify(mergedProjects)); localStorage.setItem(DB_KEY_CONFIG, JSON.stringify(mergedConfig)); localStorage.setItem(DB_KEY_OT, JSON.stringify(mergedOt)); localStorage.setItem(DB_KEY_TODO, JSON.stringify(mergedTodo)); localStorage.setItem(DB_KEY_CAL, JSON.stringify(mergedCal));
                    if (currentUser) {
                        const payload = { projects: mergedProjects, config: mergedConfig, attendance: mergedOt, todo: mergedTodo, calendar: mergedCal, updated_at: new Date().toISOString() };
                        await _supabase.from('user_data').upsert({ user_id: currentUser.id, content: payload });
                    }
                    alert(`‚úÖ ÂØºÂÖ•ÂÆåÊàêÔºÅ`); location.reload();
                } catch (err) { alert("üí• Âá∫Èîô: " + err.message); }
            };
            r.readAsText(i.files[0]); i.value = '';
        }

        function calcDateDiff() {
            const d1 = document.getElementById('toolStartDate').value;
            const d2 = document.getElementById('toolEndDate').value;
            const resBox = document.getElementById('dateResult');
            if (!d1 || !d2) { alert("ËØ∑ÂÖàÈÄâÊã©‰∏§‰∏™Êó•ÊúüÔºÅ"); return; }
            const diffTime = Math.abs(new Date(d2) - new Date(d1));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            resBox.style.display = 'block'; resBox.innerText = `Áõ∏Â∑Æ ${diffDays} Â§©`;
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        // üåü Ë°•ÂÖÖÔºöÊ∏≤ÊüìÂèÇÂª∫Âçï‰Ωç
        function renderServices() {
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            const container = document.getElementById('servicesListContainer');
            const emptyHint = document.getElementById('emptyServicesHint');

            container.innerHTML = '';

            if (!p.services) p.services = [];
            if (p.services.length === 0) {
                emptyHint.style.display = 'block';
                return;
            } else {
                emptyHint.style.display = 'none';
            }

            p.services.forEach((svc, idx) => {
                const div = document.createElement('div');
                div.className = 'service-card';
                // Ê®°ÊãüËøõÂ∫¶Êù°
                const mockProgress = Math.floor(Math.random() * 50) + 30;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span class="service-type-tag">${svc.type}</span>
                        <button class="btn-delete-icon" onclick="deleteService(${idx})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                    <div class="service-name">${svc.name}</div>
                    <div class="service-row">
                        <span>üí∞ ÂêàÂêåÈ¢ù: ¬•${Number(svc.amount).toLocaleString()}</span>
                        <span>üë§ ${svc.contact || 'Êó†ËÅîÁ≥ª‰∫∫'}</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width: ${mockProgress}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function saveService() {
            const type = document.getElementById('svcType').value;
            const name = document.getElementById('svcName').value;
            const amount = document.getElementById('svcAmount').value;
            const contact = document.getElementById('svcContact').value;
            if (!name) return alert('ËØ∑ËæìÂÖ•Âçï‰ΩçÂêçÁß∞');
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            if (!p.services) p.services = [];
            p.services.push({ type, name, amount, contact });
            DB.save(list);
            closeModal('addServiceModal');
            renderServices();
            document.getElementById('svcName').value = '';
            document.getElementById('svcAmount').value = '';
            document.getElementById('svcContact').value = '';
        }
        function deleteService(idx) {
            if (!confirm('Á°ÆÂÆöÁßªÈô§ËØ•ÂèÇÂª∫Âçï‰ΩçÂêóÔºü')) return;
            const list = DB.get();
            const p = list.find(x => x.id === currentProjectId);
            p.services.splice(idx, 1);
            DB.save(list);
            renderServices();
        }
        function switchDetailTab(tabName) {
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`seg_${tabName}`).classList.add('active');
            document.getElementById('view_timeline').style.display = (tabName === 'timeline') ? 'block' : 'none';
            document.getElementById('view_services').style.display = (tabName === 'services') ? 'block' : 'none';
            if (tabName === 'services') { renderServices(); }
        }


        // --- üëÆ ÁÆ°ÁêÜÂëòÂäüËÉΩ (‰øÆÂ§çÁâà) ---

        async function openAdminPanel() {
            openModal('adminModal');
            document.getElementById('adminUserList').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</td></tr>';

            // 1. ‰øÆÂ§çÁÇπÔºöÂéªÊéâ 'updated_at'ÔºåÂè™Êü•ËØ¢Â≠òÂú®ÁöÑÂàó
            const { data, error } = await _supabase
                .from('user_data')
                .select('user_id, content');

            if (error) {
                // Â¶ÇÊûúËøòÊòØÊä•ÈîôÔºåÂèØËÉΩÊòØÊùÉÈôêÈóÆÈ¢òÔºåÊàñËÄÖË°®Âêç‰∏çÂØπ
                alert("Âä†ËΩΩÂ§±Ë¥•: " + error.message);
                return;
            }

            document.getElementById('adminTotalCount').innerText = data.length;
            const tbody = document.getElementById('adminUserList');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</td></tr>';
                return;
            }

            data.forEach(row => {
                // 2. Â∞ùËØïËß£Êûê ID (Âè™ÊòæÁ§∫Ââç8‰Ωç)
                let displayName = row.user_id.slice(0, 8) + '...';

                // 3. ‰øÆÂ§çÁÇπÔºö‰ªé content (JSON) ÂÜÖÈÉ®ËØªÂèñÊó∂Èó¥
                let dateStr = 'Êú™Áü•Êó∂Èó¥';
                if (row.content && row.content.updated_at) {
                    dateStr = new Date(row.content.updated_at).toLocaleString();
                } else if (row.content && row.content.d) {
                    // ÂÖºÂÆπÊóßÊï∞ÊçÆÁöÑÂØºÂá∫Êó∂Èó¥Â≠óÊÆµ
                    dateStr = new Date(row.content.d).toLocaleString();
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="font-family:monospace; color:#333;">${displayName}</span></td>
                    <td style="font-size:11px; color:#666;">${dateStr}</td>
                    <td>
                        <button class="btn-del-user" onclick="adminDeleteUser('${row.user_id}')">Âà†Èô§</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function adminDeleteUser(targetUserId) {
            if (!confirm('‚ö†Ô∏è Ë≠¶ÂëäÔºöÁ°ÆÂÆöË¶ÅÂà†Èô§ËØ•Áî®Êà∑ÁöÑÊâÄÊúâ‰∫ëÁ´ØÊï∞ÊçÆÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ')) return;

            const { error } = await _supabase
                .from('user_data')
                .delete()
                .eq('user_id', targetUserId);

            if (error) {
                alert('Âà†Èô§Â§±Ë¥•: ' + error.message);
            } else {
                alert('‚úÖ Êï∞ÊçÆÂ∑≤Âà†Èô§');
                openAdminPanel(); // Âà∑Êñ∞ÂàóË°®
            }
        }
        // üë§ ÊâìÂºÄ‰∏™‰∫∫‰∏≠ÂøÉ
        function openPersonalCenter() {
            if (!currentUser) return;

            // 1. Â°´ÂÖ•ÈÇÆÁÆ±
            document.getElementById('centerEmail').innerText = currentUser.email;

            // 2. È°∫‰æøÁªüËÆ°‰∏Ä‰∏ãÊï∞ÊçÆÔºàÊòæÂæóÈ´òÁ∫ßÔºâ
            const projs = JSON.parse(localStorage.getItem(DB_KEY_DATA) || '[]');
            const todos = JSON.parse(localStorage.getItem(DB_KEY_TODO) || '[]');

            document.getElementById('centerProjCount').innerText = projs.length;
            document.getElementById('centerTodoCount').innerText = todos.length;

            // 3. ÊâìÂºÄÂºπÁ™ó
            openModal('personalCenterModal');
        }

        // --- üîô Ê†∏ÂøÉ‰øÆÂ§çÔºöÊé•ÁÆ°ÊµèËßàÂô®ËøîÂõûÈîÆ & ÊªëÂä®ËøîÂõû ---

        // 1. ÁõëÂê¨ÊµèËßàÂô®ÁöÑ‚ÄúÂêéÈÄÄ‚ÄùÂä®‰Ωú (ÂåÖÊã¨ËæπÁºòÊªëÂä®„ÄÅÁâ©ÁêÜËøîÂõûÈîÆ)
        window.addEventListener('popstate', function (event) {
            // Â¶ÇÊûú history Áä∂ÊÄÅÈáåÊ≤°Êúâ IDÔºåËØ¥ÊòéÂõûÂà∞‰∫ÜÂéüÁÇπÔºàÈ¶ñÈ°µÔºâ
            const state = event.state;

            if (state && state.pageId) {
                // Â¶ÇÊûúÂéÜÂè≤ËÆ∞ÂΩïÈáåÊúâÈ°µÈù¢IDÔºåÂ∞±Ë∑≥ËøáÂéªÔºàÊØîÂ¶ÇÂâçËøõÊó∂Ôºâ
                // ËøôÈáåÊàë‰ª¨ÈÄöÂ∏∏Âè™ÈúÄË¶ÅÂ§ÑÁêÜ‚ÄúÂõûÈÄÄ‚ÄùÂà∞È¶ñÈ°µÁöÑÊÉÖÂÜµ
                // ‰ΩÜ‰∏∫‰∫Ü‰øùÈô©ÔºåËøòÊòØÁïôÁùÄ
                showPageSimple(state.pageId);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÁä∂ÊÄÅ‰∫ÜÔºåËØ¥ÊòéÈÄÄÂà∞‰∫ÜÊúÄÂºÄÂßãÔºåÂº∫Âà∂ÂõûÈ¶ñÈ°µ
                goHomeSimple();
            }
        });

        // 2. ÊîπÈÄ†È°µÈù¢Ë∑≥ËΩ¨ÂáΩÊï∞ÔºöÊØèÊ¨°Ë∑≥ËΩ¨ÈÉΩ‚ÄúËôöÊûÑ‚Äù‰∏ÄÊù°ÂéÜÂè≤ËÆ∞ÂΩï
        // ‚ö†Ô∏è Ê≥®ÊÑèÔºöËØ∑Áî®Ëøô‰∏™ÊõøÊç¢‰ª£Á†ÅÈáåÂéüÊú¨ÁöÑ goToPage ÂáΩÊï∞ÔºåÊàñËÄÖË¶ÜÁõñÂÆÉ
        const originalGoToPage = window.goToPage; // Â§á‰ªΩ‰∏Ä‰∏ãÊóßÈÄªËæëÂ¶ÇÊûúÊúâÁöÑËØù

        window.goToPage = function (id) {
            // ÂÖàÊâßË°åÂéüÊú¨ÁöÑ UI ÂàáÊç¢ÈÄªËæë
            showPageSimple(id);

            // üìù ÂÖ≥ÈîÆÔºöÂæÄÊµèËßàÂô®ÂéÜÂè≤ÈáåÂ°û‰∏ÄÊù°ËÆ∞ÂΩï
            // ËøôÊ†∑ÊµèËßàÂô®ËßâÂæóÂ¶ÇÊûú‰Ω†ÊªëÂõûÂéªÔºåÂ∞±ÊòØÊí§ÈîÄËøôÊù°ËÆ∞ÂΩïÔºåËÄå‰∏çÊòØÂÖ≥Èó≠ÁΩëÈ°µ
            history.pushState({ pageId: id }, null, "#" + id);
        };

        // 3. ÊîπÈÄ†ÂõûÈ¶ñÈ°µÂáΩÊï∞
        window.goHome = function () {
            // Â¶ÇÊûúÂΩìÂâçÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºà‰∏çÊòØÈ¶ñÈ°µÔºâÔºåÂ∞±ÈÄöËøá history.back() ËøîÂõû
            // ËøôÊ†∑ÂèØ‰ª•Ê®°ÊãüÁî®Êà∑ÁöÑ‚ÄúÁÇπÂáªËøîÂõû‚ÄùÊìç‰Ωú
            if (history.state && history.state.pageId) {
                history.back();
            } else {
                goHomeSimple();
            }
        };

        // --- ÂÜÖÈÉ®Â∑•ÂÖ∑ÔºöÁ∫ØÁ≤πÁöÑÊòæÁ§∫ÈöêËóèÔºå‰∏çÊìç‰ΩúÂéÜÂè≤ËÆ∞ÂΩï ---
        function showPageSimple(id) {
            // 1. ÈöêËóèÊâÄÊúâÈ°µÈù¢
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // 2. ÊòæÁ§∫ÁõÆÊ†áÈ°µÈù¢
            const target = document.getElementById(id);
            if (target) target.classList.add('active');

            // 3. Â§ÑÁêÜÂØºËà™Ê†èÊòæÁ§∫
            if (id === 'projectDetail') {
                document.getElementById('mainNavBar').style.display = 'none';
                document.getElementById('detailNavBar').style.display = 'flex';
            } else {
                document.getElementById('mainNavBar').style.display = 'flex';
                document.getElementById('detailNavBar').style.display = 'none';

                // È¶ñÈ°µÁâπÊÆäÂ§ÑÁêÜ
                const isHome = (id === 'homePage');
                document.getElementById('globalBackBtn').style.display = isHome ? 'none' : 'flex';
                document.getElementById('userBadge').style.display = isHome ? 'block' : 'none';
                document.getElementById('nodeConfigBtn').style.display = (id === 'projectList') ? 'block' : 'none';
                document.getElementById('globalPageTitle').innerText = isHome ? 'Â∑•‰ΩúÂä©Êâã' : '';
            }

            // 4. Ëß¶ÂèëÈ°µÈù¢ÁâπÂÆöÁöÑÊ∏≤ÊüìÈÄªËæë
            if (id === 'projectList') renderProjects();
            if (id === 'attendancePage') renderOtPage();
            if (id === 'homePage') initHome();
        }

        // --- ÂÜÖÈÉ®Â∑•ÂÖ∑ÔºöÁ∫ØÁ≤πÂõûÈ¶ñÈ°µ UI ---
        function goHomeSimple() {
            showPageSimple('homePage');
        }

        // ÂàùÂßãÂåñÔºöÂàöÊâìÂºÄÁΩëÈ°µÊó∂ÔºåÊääÈ¶ñÈ°µÊõøÊç¢‰∏∫ÂΩìÂâçÁä∂ÊÄÅÔºåÈò≤Ê≠¢‰π±Ë∑ë
        history.replaceState({ pageId: 'homePage' }, null, "#home");

    </script>
    <div id="personalCenterModal" class="modal">
        <div class="modal-content" style="max-width: 320px; text-align: center;">
            <h3 style="margin-bottom: 5px;">‰∏™‰∫∫‰∏≠ÂøÉ</h3>

            <div style="font-size: 48px; margin: 15px 0;">ü§†</div>

            <div style="color: #666; font-size: 13px;">ÂΩìÂâçÁôªÂΩïË¥¶Âè∑</div>
            <div id="centerEmail"
                style="font-size: 18px; font-weight: bold; color: #333; margin-bottom: 25px; word-break: break-all;">
                loading...
            </div>

            <div
                style="display: flex; justify-content: space-around; margin-bottom: 25px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <div>
                    <div style="font-size: 12px; color: #999;">È°πÁõÆÊï∞</div>
                    <div style="font-size: 16px; font-weight: bold;" id="centerProjCount">0</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #999;">ÂæÖÂäûÊï∞</div>
                    <div style="font-size: 16px; font-weight: bold;" id="centerTodoCount">0</div>
                </div>
            </div>

            <button class="btn-primary" style="background: #FF3B30; margin-bottom: 10px;"
                onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
            <button class="btn-cancel" onclick="closeModal('personalCenterModal')">ÂÖ≥Èó≠</button>
        </div>
    </div>
</body>

</html>